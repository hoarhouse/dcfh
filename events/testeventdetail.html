<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - DCF Hungary</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: #333;
            border-radius: 50%;
            margin-right: 8px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            text-decoration: none;
            color: #666;
            font-size: 0.9rem;
            position: relative;
        }

        .nav-menu a.active {
            color: #333;
            font-weight: 600;
        }

        .nav-menu a:hover {
            color: #333;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #000, #333);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .user-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e5e5;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #000, #333);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .dropdown-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-email {
            color: #666;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-divider {
            height: 1px;
            background: #f0f0f0;
            margin: 0.5rem 0;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #000;
        }

        .logout-btn {
            color: #dc3545 !important;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #fee !important;
            color: #c82333 !important;
        }

        .dropdown-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .event-hero {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .event-banner {
            height: 300px;
            background: linear-gradient(135deg, #000, #333);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            position: relative;
        }

        .event-content {
            padding: 2rem;
        }

        .event-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 2rem;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 1rem;
        }

        .event-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-bottom: 1.5rem;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meta-icon {
            font-size: 1.2rem;
        }

        .event-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 200px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            text-align: center;
        }

        .btn-primary {
            background: #000;
            color: white;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: transparent;
            color: #666;
            border: 2px solid #e5e5e5;
        }

        .btn-secondary:hover {
            color: #333;
            border-color: #333;
        }

        .btn.liked {
            background: #dc3545;
            color: white;
        }

        .btn.following {
            background: #28a745;
            color: white;
        }

        .btn.registered {
            background: #007bff;
            color: white;
        }

        .event-description {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }

        .event-details {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .details-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }

        .organizer-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .organizer-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #000, #333);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .organizer-details h4 {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .organizer-details p {
            color: #666;
            font-size: 0.9rem;
        }

        .comments-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .comments-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-form {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
        }

        .comment-input {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .comment-input:focus {
            outline: none;
            border-color: #333;
        }

        .comment-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comments-list {
            padding: 1.5rem;
        }

        .comment {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .comment:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #000, #333);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            font-weight: 600;
            color: #333;
        }

        .comment-time {
            color: #666;
            font-size: 0.9rem;
        }

        .comment-text {
            color: #333;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .comment-actions-bar {
            display: flex;
            gap: 1rem;
        }

        .comment-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .comment-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
            background: #fee;
            border-radius: 8px;
            margin: 1rem 0;
        }

        @media (max-width: 1024px) {
            .event-details {
                grid-template-columns: 1fr;
            }

            .event-header {
                flex-direction: column;
                align-items: stretch;
            }

            .event-actions {
                flex-direction: row;
                min-width: auto;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0 1rem;
            }

            .event-title {
                font-size: 2rem;
            }

            .event-meta {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-menu {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/dcf-unified-auth.js"></script>
</head>

<body>
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <div class="logo-icon"></div>
                Domus Communis Foundation Hungary
            </a>
            <ul class="nav-menu">
                <li><a href="../members/dcf_member_home.html">Home</a></li>
                <li><a href="../members/dcf_members_directory.html">Members</a></li>
                <li><a href="../members/dcf_projects_home.html">Projects</a></li>
                <li><a href="../events/dcf_events_calendar.html" class="active">Events</a></li>
                <li><a href="../resources/dcf_resources_library.html">Resources</a></li>
            </ul>
            <div class="user-menu">
                <div class="user-dropdown">
                    <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar">SJ</div>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-header">
                            <div class="dropdown-avatar">SJ</div>
                            <div class="dropdown-info">
                                <div class="dropdown-name" id="dropdownUserName">@username</div>
                                <div class="dropdown-email" id="dropdownUserEmail">user@email.com</div>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="../members/dcf_member_profile.html" class="dropdown-item">
                            <span class="dropdown-icon">👤</span>
                            My Profile
                        </a>
                        <a href="../members/dcf_members_directory.html" class="dropdown-item">
                            <span class="dropdown-icon">👥</span>
                            My Connections
                        </a>
                        <a href="../members/dcf_projects_home.html" class="dropdown-item">
                            <span class="dropdown-icon">📋</span>
                            My Projects
                        </a>
                        <a href="../events/dcf_events_calendar.html" class="dropdown-item">
                            <span class="dropdown-icon">📅</span>
                            My Events
                        </a>
                        <a href="../members/dcf_personal_analytics.html" class="dropdown-item">
                            <span class="dropdown-icon">📊</span>
                            My Stats
                        </a>
                        <div class="dropdown-divider"></div>
                        <button onclick="handleLogout()" class="dropdown-item logout-btn">
                            <span class="dropdown-icon">🚪</span>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-container">
        <!-- Event Hero Section -->
        <div class="event-hero">
            <div class="event-banner" id="eventBanner">
                📅
            </div>
            <div class="event-content">
                <div class="event-header">
                    <div class="event-info">
                        <h1 class="event-title" id="eventTitle">Loading...</h1>
                        <div class="event-meta" id="eventMeta">
                            <div class="meta-item">
                                <span class="meta-icon">📅</span>
                                <span id="eventDate">Loading...</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">🕒</span>
                                <span id="eventTime">Loading...</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">📍</span>
                                <span id="eventLocation">Loading...</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">👥</span>
                                <span id="eventAttendees">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="event-actions">
                        <button class="btn btn-primary" id="registerBtn" onclick="toggleRegistration()">
                            📝 Register
                        </button>
                        <button class="btn btn-secondary" id="likeBtn" onclick="toggleLike()">
                            ❤️ Like
                        </button>
                        <button class="btn btn-secondary" id="followBtn" onclick="toggleFollow()">
                            👁️ Follow
                        </button>
                        <button class="btn btn-secondary" onclick="shareEvent()">
                            📤 Share
                        </button>
                    </div>
                </div>
                <div class="event-description" id="eventDescription">
                    Loading event description...
                </div>
            </div>
        </div>

        <!-- Event Details Grid -->
        <div class="event-details">
            <div class="details-section">
                <h2 class="section-title">Event Details</h2>
                <div id="eventDetailsContent">
                    Loading details...
                </div>
            </div>
            <div class="details-section">
                <h2 class="section-title">Organizer</h2>
                <div class="organizer-info" id="organizerInfo">
                    <div class="organizer-avatar" id="organizerAvatar">O</div>
                    <div class="organizer-details">
                        <h4 id="organizerName">Loading...</h4>
                        <p id="organizerEmail">Loading...</p>
                    </div>
                </div>
                <div id="organizerControls" style="display: none;">
                    <a href="dcf_event_manage.html" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        ⚙️ Manage Event
                    </a>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="comments-section">
            <div class="comments-header">
                <h2 class="section-title">Discussion</h2>
                <span id="commentCount">0 comments</span>
            </div>
            
            <div class="comment-form" id="commentForm">
                <textarea 
                    class="comment-input" 
                    id="commentInput" 
                    placeholder="Share your thoughts about this event..."
                    rows="3"
                ></textarea>
                <div class="comment-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="addComment()">
                        💬 Post Comment
                    </button>
                </div>
            </div>

            <div class="comments-list" id="commentsList">
                <div class="loading">
                    Loading comments...
                </div>
            </div>
        </div>
    </main>

    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let currentEvent = null;
        let currentUser = null;
        let isRegistered = false;
        let isLiked = false;
        let isFollowing = false;
        let comments = [];

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔄 Page loading...');
            
            // Wait for auth to initialize
            await waitForAuth();
            
            // Get event ID from URL
            const eventId = getEventIdFromUrl();
            if (!eventId) {
                showError('Event not found');
                return;
            }
            
            // Load event data and comments
            await loadEventData(eventId);
            await loadComments(eventId);
            await loadUserStates(eventId);
        });

        async function waitForAuth() {
            let attempts = 0;
            while (attempts < 50) {
                if (window.getCurrentUser && window.getCurrentUser()) {
                    currentUser = window.getCurrentUser();
                    console.log('✅ Auth ready, user:', currentUser.username);
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            console.log('⚠️ Auth timeout, proceeding without user');
        }

        function getEventIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // ========================================
        // EVENT DATA LOADING
        // ========================================
        async function loadEventData(eventId) {
            try {
                console.log('📅 Loading event data for:', eventId);
                
                const { data: event, error } = await window.dcfSupabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) {
                    console.error('❌ Error loading event:', error);
                    showError('Failed to load event data');
                    return;
                }

                if (!event) {
                    showError('Event not found');
                    return;
                }

                currentEvent = event;
                console.log('✅ Event loaded:', event.title);
                
                // Update UI with event data
                updateEventUI(event);
                
                // Load organizer info
                await loadOrganizerInfo(event.organizer_id, event.contact_email);
                
            } catch (error) {
                console.error('❌ Error in loadEventData:', error);
                showError('Failed to load event');
            }
        }

        function updateEventUI(event) {
            // Title and basic info
            document.getElementById('eventTitle').textContent = event.title;
            document.getElementById('eventDescription').textContent = event.description || 'No description available.';
            
            // Meta information
            const eventDate = new Date(event.event_date);
            document.getElementById('eventDate').textContent = eventDate.toLocaleDateString();
            document.getElementById('eventTime').textContent = event.start_time || 'Time TBD';
            document.getElementById('eventLocation').textContent = event.location || 'Location TBD';
            document.getElementById('eventAttendees').textContent = `${event.max_attendees || 'Unlimited'} max`;
            
            // Event details content
            const detailsContent = document.getElementById('eventDetailsContent');
            detailsContent.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <strong>Event Type:</strong> ${event.event_type || 'General'}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Category:</strong> ${event.category || 'Uncategorized'}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Target Audience:</strong> ${event.target_audience || 'All members'}
                </div>
                ${event.meeting_link ? `
                <div style="margin-bottom: 1rem;">
                    <strong>Meeting Link:</strong> 
                    <a href="${event.meeting_link}" target="_blank" style="color: #007bff;">Join Meeting</a>
                </div>
                ` : ''}
                ${event.additional_instructions ? `
                <div style="margin-bottom: 1rem;">
                    <strong>Additional Instructions:</strong><br>
                    ${event.additional_instructions}
                </div>
                ` : ''}
            `;
        }

        async function loadOrganizerInfo(organizerId, contactEmail) {
            try {
                // Try to get organizer from user_profiles
                const { data: organizer, error } = await window.dcfSupabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', organizerId)
                    .single();

                if (organizer) {
                    updateOrganizerUI(organizer);
                } else {
                    // Fallback to contact email
                    updateOrganizerUI({
                        name: 'Event Organizer',
                        email: contactEmail || 'No contact provided'
                    });
                }

                // Show manage controls if current user is organizer
                if (currentUser && (currentUser.id === organizerId || currentUser.email === contactEmail)) {
                    document.getElementById('organizerControls').style.display = 'block';
                }

            } catch (error) {
                console.error('❌ Error loading organizer:', error);
                updateOrganizerUI({
                    name: 'Event Organizer',
                    email: 'No contact provided'
                });
            }
        }

        function updateOrganizerUI(organizer) {
            const initials = generateInitials(organizer.name || 'Event Organizer');
            
            document.getElementById('organizerName').textContent = organizer.name || 'Event Organizer';
            document.getElementById('organizerEmail').textContent = organizer.email || 'No contact provided';
            document.getElementById('organizerAvatar').textContent = initials;
        }

        // ========================================
        // USER STATES (REGISTRATION, LIKES, FOLLOWS)
        // ========================================
        async function loadUserStates(eventId) {
            if (!currentUser) {
                console.log('ℹ️ No user logged in, skipping state loading');
                return;
            }

            try {
                console.log('🔄 Loading user states for event:', eventId);
                
                // Check registration status - handle errors gracefully
                try {
                    const { data: registration } = await window.dcfSupabase
                        .from('event_registrations')
                        .select('*')
                        .eq('event_id', eventId)
                        .eq('attendee_email', currentUser.email)
                        .maybeSingle();
                    
                    isRegistered = !!registration;
                } catch (error) {
                    console.log('ℹ️ Registration check failed, defaulting to false');
                    isRegistered = false;
                }

                // Check like status - handle errors gracefully
                try {
                    const { data: like } = await window.dcfSupabase
                        .from('event_likes')
                        .select('*')
                        .eq('event_id', eventId)
                        .eq('user_email', currentUser.email)
                        .maybeSingle();
                    
                    isLiked = !!like;
                } catch (error) {
                    console.log('ℹ️ Like check failed, defaulting to false');
                    isLiked = false;
                }

                // Check follow status - handle errors gracefully
                try {
                    const { data: follow } = await window.dcfSupabase
                        .from('event_follows')
                        .select('*')
                        .eq('event_id', eventId)
                        .eq('user_email', currentUser.email)
                        .maybeSingle();
                    
                    isFollowing = !!follow;
                } catch (error) {
                    console.log('ℹ️ Follow check failed, defaulting to false');
                    isFollowing = false;
                }

                // Update button states
                updateButtonStates();
                
                console.log('✅ User states loaded:', { isRegistered, isLiked, isFollowing });

            } catch (error) {
                console.error('❌ Error loading user states:', error);
                // Continue with default states
                updateButtonStates();
            }
        }

        function updateButtonStates() {
            const registerBtn = document.getElementById('registerBtn');
            const likeBtn = document.getElementById('likeBtn');
            const followBtn = document.getElementById('followBtn');

            // Update registration button
            if (isRegistered) {
                registerBtn.textContent = '✅ Registered';
                registerBtn.classList.remove('btn-primary');
                registerBtn.classList.add('registered');
            } else {
                registerBtn.textContent = '📝 Register';
                registerBtn.classList.add('btn-primary');
                registerBtn.classList.remove('registered');
            }

            // Update like button
            if (isLiked) {
                likeBtn.textContent = '❤️ Liked';
                likeBtn.classList.remove('btn-secondary');
                likeBtn.classList.add('liked');
            } else {
                likeBtn.textContent = '🤍 Like';
                likeBtn.classList.add('btn-secondary');
                likeBtn.classList.remove('liked');
            }

            // Update follow button
            if (isFollowing) {
                followBtn.textContent = '👁️ Following';
                followBtn.classList.remove('btn-secondary');
                followBtn.classList.add('following');
            } else {
                followBtn.textContent = '👁️ Follow';
                followBtn.classList.add('btn-secondary');
                followBtn.classList.remove('following');
            }
        }

        // ========================================
        // COMMENTS SYSTEM
        // ========================================
        async function loadComments(eventId) {
            try {
                console.log('💬 Loading comments for event:', eventId);
                
                const { data: eventComments, error } = await window.dcfSupabase
                    .from('event_comments')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('❌ Error loading comments:', error);
                    showCommentsError('Failed to load comments');
                    return;
                }

                comments = eventComments || [];
                console.log(`✅ Loaded ${comments.length} comments`);
                
                // Enhance comments with usernames
                await enhanceCommentsWithUsernames();
                
                // Render comments
                renderComments();
                
            } catch (error) {
                console.error('❌ Error in loadComments:', error);
                showCommentsError('Failed to load comments');
            }
        }

        async function enhanceCommentsWithUsernames() {
            for (const comment of comments) {
                try {
                    // Get username from user_profiles using email
                    const { data: profile } = await window.dcfSupabase
                        .from('user_profiles')
                        .select('username, name')
                        .eq('email', comment.user_email)
                        .single();

                    if (profile) {
                        comment.display_username = profile.username;
                        comment.display_name = profile.name;
                    } else {
                        // Fallback to email prefix
                        comment.display_username = comment.user_email.split('@')[0];
                        comment.display_name = comment.user_name;
                    }
                } catch (error) {
                    console.log('⚠️ Failed to get username for:', comment.user_email);
                    comment.display_username = comment.user_email.split('@')[0];
                    comment.display_name = comment.user_name;
                }
            }
        }

        function renderComments() {
            const commentsList = document.getElementById('commentsList');
            const commentCount = document.getElementById('commentCount');
            
            // Update comment count
            commentCount.textContent = `${comments.length} comment${comments.length !== 1 ? 's' : ''}`;
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="empty-state">
                        <h3>No comments yet</h3>
                        <p>Be the first to share your thoughts about this event!</p>
                    </div>
                `;
                return;
            }

            const commentsHTML = comments.map(comment => {
                const timeAgo = formatTimeAgo(new Date(comment.created_at));
                const authorInitials = generateInitials(comment.display_name || comment.user_name);
                
                return `
                    <div class="comment">
                        <div class="comment-avatar">${authorInitials}</div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">@${comment.display_username}</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.comment_text)}</div>
                            <div class="comment-actions-bar">
                                <button class="comment-btn" onclick="likeComment('${comment.id}')">
                                    👍 Like
                                </button>
                                <button class="comment-btn" onclick="replyToComment('${comment.id}')">
                                    💬 Reply
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            commentsList.innerHTML = commentsHTML;
        }

        async function addComment() {
            if (!currentUser) {
                alert('Please log in to comment');
                return;
            }

            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();

            if (!commentText) {
                alert('Please enter a comment');
                return;
            }

            try {
                console.log('💬 Adding comment...');
                
                const { data, error } = await window.dcfSupabase
                    .from('event_comments')
                    .insert([{
                        event_id: currentEvent.id,
                        user_email: currentUser.email,
                        user_name: currentUser.name,
                        comment_text: commentText
                    }])
                    .select()
                    .single();

                if (error) {
                    console.error('❌ Error adding comment:', error);
                    alert('Failed to add comment. Please try again.');
                    return;
                }

                console.log('✅ Comment added successfully');
                
                // Clear input
                commentInput.value = '';
                
                // Reload comments
                await loadComments(currentEvent.id);
                
            } catch (error) {
                console.error('❌ Error in addComment:', error);
                alert('Failed to add comment. Please try again.');
            }
        }

        // ========================================
        // EVENT ACTIONS
        // ========================================
        async function toggleRegistration() {
            if (!currentUser) {
                alert('Please log in to register for events');
                return;
            }

            try {
                if (isRegistered) {
                    // Unregister
                    await window.dcfSupabase
                        .from('event_registrations')
                        .delete()
                        .eq('event_id', currentEvent.id)
                        .eq('attendee_email', currentUser.email);
                    
                    isRegistered = false;
                    console.log('✅ Unregistered from event');
                } else {
                    // Register
                    await window.dcfSupabase
                        .from('event_registrations')
                        .insert([{
                            event_id: currentEvent.id,
                            user_id: currentUser.id,
                            attendee_name: currentUser.name,
                            attendee_email: currentUser.email,
                            status: 'registered'
                        }]);
                    
                    isRegistered = true;
                    console.log('✅ Registered for event');
                }
                
                updateButtonStates();
                
            } catch (error) {
                console.error('❌ Error toggling registration:', error);
                alert('Failed to update registration. Please try again.');
            }
        }

        async function toggleLike() {
            if (!currentUser) {
                alert('Please log in to like events');
                return;
            }

            try {
                if (isLiked) {
                    // Unlike
                    await window.dcfSupabase
                        .from('event_likes')
                        .delete()
                        .eq('event_id', currentEvent.id)
                        .eq('user_email', currentUser.email);
                    
                    isLiked = false;
                    console.log('✅ Unliked event');
                } else {
                    // Like
                    await window.dcfSupabase
                        .from('event_likes')
                        .insert([{
                            event_id: currentEvent.id,
                            user_email: currentUser.email,
                            user_name: currentUser.name
                        }]);
                    
                    isLiked = true;
                    console.log('✅ Liked event');
                }
                
                updateButtonStates();
                
            } catch (error) {
                console.error('❌ Error toggling like:', error);
                alert('Failed to update like. Please try again.');
            }
        }

        async function toggleFollow() {
            if (!currentUser) {
                alert('Please log in to follow events');
                return;
            }

            try {
                if (isFollowing) {
                    // Unfollow
                    await window.dcfSupabase
                        .from('event_follows')
                        .delete()
                        .eq('event_id', currentEvent.id)
                        .eq('user_email', currentUser.email);
                    
                    isFollowing = false;
                    console.log('✅ Unfollowed event');
                } else {
                    // Follow
                    await window.dcfSupabase
                        .from('event_follows')
                        .insert([{
                            event_id: currentEvent.id,
                            user_email: currentUser.email,
                            user_name: currentUser.name
                        }]);
                    
                    isFollowing = true;
                    console.log('✅ Followed event');
                }
                
                updateButtonStates();
                
            } catch (error) {
                console.error('❌ Error toggling follow:', error);
                alert('Failed to update follow. Please try again.');
            }
        }

        function shareEvent() {
            if (navigator.share) {
                navigator.share({
                    title: currentEvent.title,
                    text: currentEvent.description,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Event link copied to clipboard!');
                }).catch(() => {
                    alert('Event URL: ' + window.location.href);
                });
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function generateInitials(name) {
            if (!name || typeof name !== 'string') return 'U';
            
            // Remove titles and clean up
            const cleanName = name.replace(/^(Dr\.?|Mr\.?|Mrs\.?|Ms\.?|Prof\.?|Professor|Father|Fr\.?|Sister|Sr\.?|Rabbi)\s+/i, '').trim();
            const parts = cleanName.split(' ').filter(part => part.length > 0);
            
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            } else if (parts.length === 1) {
                return parts[0].substring(0, 2).toUpperCase();
            }
            
            return 'U';
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const main = document.querySelector('.main-container');
            main.innerHTML = `
                <div class="error">
                    <h2>Error</h2>
                    <p>${message}</p>
                    <a href="dcf_events_calendar.html" class="btn btn-primary" style="margin-top: 1rem;">
                        ← Back to Events
                    </a>
                </div>
            `;
        }

        function showCommentsError(message) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = `
                <div class="error">
                    <p>${message}</p>
                </div>
            `;
        }

        // Placeholder functions for comment actions
        function likeComment(commentId) {
            console.log('Like comment:', commentId);
            // TODO: Implement comment liking
        }

        function replyToComment(commentId) {
            console.log('Reply to comment:', commentId);
            // TODO: Implement comment replies
        }
    </script>
</body>
</html>