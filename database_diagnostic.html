<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCF Hungary - Database Diagnostic</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .query-result {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .error {
            color: #ff4444;
        }
        .success {
            color: #44ff44;
        }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #666;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #444;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>üîç DCF Hungary Database Diagnostic</h1>
    <p>Investigating user profile vs activity data discrepancy</p>

    <button onclick="runDiagnostic()">üöÄ RUN FULL DIAGNOSTIC</button>
    <button onclick="clearResults()">üóëÔ∏è CLEAR RESULTS</button>

    <div id="results"></div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://atzommnkkwzgbktuzjti.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `query-result ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function getCurrentUser() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error) throw error;
                return user;
            } catch (error) {
                log(`‚ùå Error getting current user: ${error.message}`, 'error');
                return null;
            }
        }

        async function checkUserProfiles(userEmail) {
            log(`üîç TASK 1: Checking user_profiles table for email: ${userEmail}`);
            
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('email', userEmail);

                if (error) throw error;

                if (data && data.length > 0) {
                    const profile = data[0];
                    log(`‚úÖ USER PROFILE FOUND:
üìß Email: ${profile.email}
üë§ Name: "${profile.name}"
üè∑Ô∏è Username: "${profile.username}"
üÜî ID: ${profile.id}
üìÖ Created: ${profile.created_at}
üîó Avatar URL: ${profile.avatar_url || 'None'}`, 'success');
                    return profile;
                } else {
                    log(`‚ùå NO USER PROFILE FOUND for email: ${userEmail}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`‚ùå Error querying user_profiles: ${error.message}`, 'error');
                return null;
            }
        }

        async function checkProjectActivity() {
            log(`üîç TASK 2: Checking project_activity table for recent activities`);
            
            try {
                const { data, error } = await supabase
                    .from('project_activity')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (data && data.length > 0) {
                    log(`‚úÖ FOUND ${data.length} RECENT ACTIVITIES:`, 'success');
                    
                    data.forEach((activity, index) => {
                        log(`üîπ Activity ${index + 1}:
   üë§ user_name: "${activity.user_name}"
   üìß user_email: "${activity.user_email}"
   üÜî user_id: ${activity.user_id}
   üéØ Action: ${activity.action_type}
   üìù Description: ${activity.action_description}
   üìÖ Created: ${activity.created_at}
   üîó Project ID: ${activity.project_id}`);
                    });

                    // Count occurrences of different user_name values
                    const userNameCounts = {};
                    data.forEach(activity => {
                        const userName = activity.user_name;
                        userNameCounts[userName] = (userNameCounts[userName] || 0) + 1;
                    });

                    log(`üìä USER_NAME VALUE COUNTS:
${Object.entries(userNameCounts).map(([name, count]) => `   "${name}": ${count} activities`).join('\n')}`, 'success');

                } else {
                    log(`‚ùå NO PROJECT ACTIVITIES FOUND`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error querying project_activity: ${error.message}`, 'error');
            }
        }

        async function checkAuthUser(userEmail) {
            log(`üîç TASK 3: Checking auth.users table for email: ${userEmail}`);
            
            try {
                // Get current auth user
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) throw error;

                if (user) {
                    log(`‚úÖ AUTH USER FOUND:
üìß Email: ${user.email}
üÜî ID: ${user.id}
üì± Phone: ${user.phone || 'None'}
üìÖ Created: ${user.created_at}
üìÖ Last Sign In: ${user.last_sign_in_at}
üìÖ Email Confirmed: ${user.email_confirmed_at}
üîó App Metadata: ${JSON.stringify(user.app_metadata, null, 2)}
üë§ User Metadata: ${JSON.stringify(user.user_metadata, null, 2)}
üè∑Ô∏è Identities: ${JSON.stringify(user.identities, null, 2)}`, 'success');
                    return user;
                } else {
                    log(`‚ùå NO AUTH USER FOUND`, 'error');
                    return null;
                }
            } catch (error) {
                log(`‚ùå Error getting auth user: ${error.message}`, 'error');
                return null;
            }
        }

        async function traceDataFlow(authUser, userProfile) {
            log(`üîç TASK 4: Tracing data flow and identifying discrepancy source`);
            
            if (!authUser || !userProfile) {
                log(`‚ùå Cannot trace data flow - missing auth user or profile data`, 'error');
                return;
            }

            log(`üîÑ DATA FLOW ANALYSIS:

üîπ AUTH USER DATA:
   Email: ${authUser.email}
   Auth ID: ${authUser.id}
   User Metadata Name: ${authUser.user_metadata?.name || 'None'}
   User Metadata Username: ${authUser.user_metadata?.username || 'None'}
   User Metadata Full Name: ${authUser.user_metadata?.full_name || 'None'}

üîπ USER PROFILE DATA:
   Email: ${userProfile.email}
   Profile ID: ${userProfile.id}
   Name: "${userProfile.name}"
   Username: "${userProfile.username}"

üîπ DISCREPANCY ANALYSIS:
   Profile Name vs Auth Name: "${userProfile.name}" vs "${authUser.user_metadata?.name || 'None'}"
   Profile Username vs Auth Username: "${userProfile.username}" vs "${authUser.user_metadata?.username || 'None'}"
   
üîπ POTENTIAL SOURCES:
   1. GitHub OAuth: Check if auth.user_metadata contains GitHub data
   2. Manual Profile Creation: Profile might be manually created/updated
   3. Signup Process: Profile creation might use different data source
   4. Data Sync Issue: Auth and profile tables might be out of sync`);

            // Check for GitHub identity data
            const githubIdentity = authUser.identities?.find(identity => identity.provider === 'github');
            if (githubIdentity) {
                log(`üîπ GITHUB IDENTITY FOUND:
   Provider: ${githubIdentity.provider}
   Identity Data: ${JSON.stringify(githubIdentity.identity_data, null, 2)}`, 'success');
            }
        }

        async function runDiagnostic() {
            clearResults();
            log(`üöÄ STARTING COMPREHENSIVE DATABASE DIAGNOSTIC
==================================================`);
            
            // Get current user
            const authUser = await getCurrentUser();
            if (!authUser) {
                log(`‚ùå DIAGNOSTIC FAILED: No authenticated user found`, 'error');
                return;
            }

            const userEmail = authUser.email;
            log(`üë§ Current User Email: ${userEmail}\n`);

            // Run all diagnostic tasks
            const userProfile = await checkUserProfiles(userEmail);
            log(`\n`);
            
            await checkProjectActivity();
            log(`\n`);
            
            const authUserDetails = await checkAuthUser(userEmail);
            log(`\n`);
            
            await traceDataFlow(authUserDetails, userProfile);
            log(`\n`);

            // Final summary
            log(`üìã DIAGNOSTIC SUMMARY:
==================================================
‚úÖ Tasks Completed: 4/4
üìä Data Sources Checked: auth.users, user_profiles, project_activity
üéØ Focus: Identifying source of "hooray" vs "Prof. chris hoar" discrepancy
üìù Results: See detailed output above`, 'success');
        }

        // Auto-run diagnostic on page load
        window.addEventListener('load', () => {
            setTimeout(runDiagnostic, 1000);
        });
    </script>
</body>
</html>