<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comments System - DCF Hungary</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23dc3545'/></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/dcf-unified-auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            line-height: 1.6;
            color: #333;
        }

        /* Header from dcf_projects_home.html */
        .header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: #333;
            border-radius: 50%;
            margin-right: 8px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            text-decoration: none;
            color: #666;
            font-size: 0.9rem;
            position: relative;
        }

        .nav-menu a.active {
            color: #333;
            font-weight: 600;
        }

        .nav-menu a:hover {
            color: #333;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Main Container */
        .container {
            max-width: 614px;
            margin: 2rem auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Post Header */
        .post-header {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #efefef;
        }

        .post-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            margin-right: 12px;
        }

        .post-info {
            flex: 1;
        }

        .post-username {
            font-weight: 600;
            font-size: 14px;
            color: #262626;
            text-decoration: none;
        }

        .post-location {
            font-size: 12px;
            color: #8e8e8e;
        }

        /* Post Actions */
        .post-actions {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid #efefef;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 8px;
            margin-right: 8px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: #f2f2f2;
            transform: scale(1.1);
        }

        .action-btn.liked {
            color: #ed4956;
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Post Caption */
        .post-caption {
            padding: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .post-likes {
            padding: 0 16px 8px;
            font-weight: 600;
            font-size: 14px;
        }

        /* Comments Section */
        .comments-section {
            border-top: 1px solid #efefef;
        }

        .comments-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f2f2f2;
            background: #fafafa;
        }

        .comments-count {
            font-weight: 600;
            font-size: 14px;
            color: #262626;
        }

        .comments-filter {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            background: none;
            border: 1px solid #dbdbdb;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #f2f2f2;
        }

        .filter-btn.active {
            background: #0095f6;
            color: white;
            border-color: #0095f6;
        }

        /* Comment Input */
        .comment-input-section {
            padding: 16px;
            border-bottom: 1px solid #efefef;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .comment-input-wrapper {
            flex: 1;
            position: relative;
        }

        .comment-input {
            width: 100%;
            border: 1px solid #dbdbdb;
            border-radius: 22px;
            padding: 10px 16px;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: border-color 0.2s ease;
            min-height: 42px;
            max-height: 120px;
            overflow-y: auto;
        }

        .comment-input:focus {
            border-color: #0095f6;
        }

        .comment-input::placeholder {
            color: #8e8e8e;
        }

        .comment-submit {
            background: #0095f6;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .comment-submit:hover {
            background: #0074d9;
            transform: translateY(-1px);
        }

        .comment-submit:disabled {
            background: #b2dffc;
            cursor: not-allowed;
            transform: none;
        }

        /* Comments List */
        .comments-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .comment {
            padding: 12px 16px;
            display: flex;
            gap: 12px;
            transition: background 0.2s ease;
        }

        .comment:hover {
            background: #fafafa;
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .comment-username {
            font-weight: 600;
            font-size: 14px;
            color: #262626;
            text-decoration: none;
        }

        .comment-username:hover {
            text-decoration: underline;
        }

        .comment-time {
            font-size: 12px;
            color: #8e8e8e;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.4;
            color: #262626;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .comment-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .comment-action {
            background: none;
            border: none;
            font-size: 12px;
            color: #8e8e8e;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }

        .comment-action:hover {
            color: #262626;
        }

        .comment-action.liked {
            color: #ed4956;
        }

        .comment-action svg {
            width: 14px;
            height: 14px;
        }

        /* Nested Comments */
        .nested-comments {
            margin-left: 44px;
            border-left: 2px solid #efefef;
            margin-top: 8px;
        }

        .nested-comment {
            padding: 8px 0 8px 12px;
        }

        /* Reply Input */
        .reply-input-wrapper {
            margin-left: 44px;
            margin-top: 8px;
            padding: 8px 0;
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .reply-input {
            flex: 1;
            border: 1px solid #dbdbdb;
            border-radius: 18px;
            padding: 8px 12px;
            font-size: 13px;
            resize: none;
            outline: none;
            min-height: 36px;
        }

        .reply-input:focus {
            border-color: #0095f6;
        }

        .reply-actions {
            display: flex;
            gap: 4px;
        }

        .reply-btn {
            background: #0095f6;
            color: white;
            border: none;
            border-radius: 16px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .cancel-btn {
            background: #efefef;
            color: #262626;
        }

        /* Edit Mode */
        .edit-input {
            width: 100%;
            border: 1px solid #0095f6;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            margin-bottom: 8px;
            resize: vertical;
            min-height: 60px;
        }

        .edit-actions {
            display: flex;
            gap: 8px;
        }

        .edit-btn {
            background: #0095f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
        }

        .cancel-edit-btn {
            background: #efefef;
            color: #262626;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 20px;
            color: #8e8e8e;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0095f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #8e8e8e;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Header from dcf_projects_home.html -->
    <header class="header">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon"></div>
                DCF Hungary
            </a>
            <nav>
                <ul class="nav-menu">
                    <li><a href="members/dcf_member_home.html">Home</a></li>
                    <li><a href="projects/dcf_projects_home.html">Projects</a></li>
                    <li><a href="resources/dcf_resources_home.html">Resources</a></li>
                    <li><a href="events/dcf_event_management.html">Events</a></li>
                    <li><a href="dcf_comments_test.html" class="active">Comments Test</a></li>
                </ul>
            </nav>
            <div class="user-menu" id="userMenu">
                <!-- User menu will be populated by dcf-unified-auth.js -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Post Header -->
        <div class="post-header">
            <div class="post-avatar">DC</div>
            <div class="post-info">
                <a href="#" class="post-username">DCF Hungary</a>
                <div class="post-location">Budapest, Hungary</div>
            </div>
        </div>

        <!-- Post Caption -->
        <div class="post-caption">
            Welcome to the new DCF Hungary social comment system! This modern interface brings professional social media quality interactions to our community platform. Share your thoughts, engage with members, and build meaningful connections.
        </div>

        <!-- Post Actions -->
        <div class="post-actions">
            <button class="action-btn" id="likePostBtn" onclick="togglePostLike()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
            </button>
            <button class="action-btn" onclick="document.getElementById('newComment').focus()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
            </button>
            <button class="action-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m9.032 4.026a9.001 9.001 0 01-7.432 0m9.032-4.026A9.001 9.001 0 0112 3c-2.796 0-5.29 1.28-6.716 3.284m9.432 8.4a9.001 9.001 0 01-7.432 0"></path>
                </svg>
            </button>
        </div>

        <!-- Post Likes Count -->
        <div class="post-likes" id="postLikesCount">0 likes</div>

        <!-- Comments Section -->
        <div class="comments-section">
            <!-- Comments Header -->
            <div class="comments-header">
                <div class="comments-count" id="commentsCount">0 Comments</div>
                <div class="comments-filter">
                    <button class="filter-btn active" onclick="filterComments('all')">All</button>
                    <button class="filter-btn" onclick="filterComments('top')">Top</button>
                    <button class="filter-btn" onclick="filterComments('recent')">Recent</button>
                </div>
            </div>

            <!-- Comment Input -->
            <div class="comment-input-section">
                <div class="comment-avatar" id="userAvatar">U</div>
                <div class="comment-input-wrapper">
                    <textarea 
                        class="comment-input" 
                        id="newComment"
                        placeholder="Add a comment..."
                        rows="1"
                    ></textarea>
                    <button class="comment-submit" onclick="submitComment()" disabled>Post</button>
                </div>
            </div>

            <!-- Comments List -->
            <div class="comments-list" id="commentsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading comments...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration from database-reference.md
        const SUPABASE_URL = 'https://atzommnkkwzgbktuzjti.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks';
        
        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Test post ID for demo
        const TEST_POST_ID = '123e4567-e89b-12d3-a456-426614174000';
        
        // Current user from unified auth
        let currentUser = {
            username: localStorage.getItem('dcf_user_name') || 'Guest User',
            email: localStorage.getItem('dcf_user_email') || 'guest@dcfhungary.org',
            id: localStorage.getItem('dcf_user_id') || null
        };
        
        // Update user avatar
        function updateUserAvatar() {
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar && currentUser.username) {
                userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            }
        }
        
        // Load comments from database
        async function loadComments() {
            try {
                const { data, error } = await supabaseClient
                    .from('post_comments')
                    .select('*')
                    .eq('post_id', TEST_POST_ID)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                displayComments(data || []);
                updateCommentsCount(data?.length || 0);
                
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('commentsList').innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p>Be the first to comment!</p>
                    </div>
                `;
            }
        }
        
        // Display comments in UI
        function displayComments(comments) {
            const commentsList = document.getElementById('commentsList');
            
            if (!comments || comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p>Be the first to comment!</p>
                    </div>
                `;
                return;
            }
            
            // Build comment tree
            const commentTree = buildCommentTree(comments);
            commentsList.innerHTML = renderComments(commentTree);
        }
        
        // Build nested comment tree
        function buildCommentTree(comments) {
            const tree = [];
            const map = {};
            
            comments.forEach(comment => {
                map[comment.id] = { ...comment, replies: [] };
            });
            
            comments.forEach(comment => {
                if (comment.parent_id && map[comment.parent_id]) {
                    map[comment.parent_id].replies.push(map[comment.id]);
                } else if (!comment.parent_id) {
                    tree.push(map[comment.id]);
                }
            });
            
            return tree;
        }
        
        // Render comments HTML
        function renderComments(comments, isNested = false) {
            return comments.map(comment => `
                <div class="${isNested ? 'nested-comment' : 'comment'}" id="comment-${comment.id}">
                    <div class="comment-avatar">${(comment.username || 'User').charAt(0).toUpperCase()}</div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <a href="#" class="comment-username">${comment.username || 'Anonymous'}</a>
                            <span class="comment-time">${formatTime(comment.created_at)}</span>
                        </div>
                        <div class="comment-text">${escapeHtml(comment.content)}</div>
                        <div class="comment-actions">
                            <button class="comment-action ${comment.user_liked ? 'liked' : ''}" onclick="toggleCommentLike('${comment.id}')">
                                <svg fill="${comment.user_liked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                <span>${comment.like_count || 0}</span>
                            </button>
                            <button class="comment-action" onclick="showReplyInput('${comment.id}')">Reply</button>
                            ${comment.username === currentUser.username ? `
                                <button class="comment-action" onclick="editComment('${comment.id}')">Edit</button>
                                <button class="comment-action" onclick="deleteComment('${comment.id}')">Delete</button>
                            ` : ''}
                        </div>
                        <div id="reply-${comment.id}"></div>
                        ${comment.replies && comment.replies.length > 0 ? `
                            <div class="nested-comments">
                                ${renderComments(comment.replies, true)}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Submit new comment
        async function submitComment(parentId = null) {
            const input = parentId ? 
                document.querySelector(`#reply-${parentId} .reply-input`) : 
                document.getElementById('newComment');
            
            const content = input.value.trim();
            if (!content) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('post_comments')
                    .insert({
                        post_id: TEST_POST_ID,
                        content: content,
                        username: currentUser.username,
                        user_id: currentUser.id,
                        parent_id: parentId,
                        like_count: 0
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Clear input
                input.value = '';
                if (!parentId) {
                    document.querySelector('.comment-submit').disabled = true;
                }
                
                // Reload comments
                await loadComments();
                
                // Create notification if replying
                if (parentId) {
                    await createCommentNotification(parentId);
                }
                
            } catch (error) {
                console.error('Error submitting comment:', error);
                alert('Failed to post comment. Please try again.');
            }
        }
        
        // Toggle comment like
        async function toggleCommentLike(commentId) {
            try {
                // Check if already liked
                const { data: existingLike, error: checkError } = await supabaseClient
                    .from('comment_likes')
                    .select('id')
                    .eq('comment_id', commentId)
                    .eq('user_email', currentUser.email)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') throw checkError;
                
                if (existingLike) {
                    // Unlike
                    await supabaseClient
                        .from('comment_likes')
                        .delete()
                        .eq('id', existingLike.id);
                        
                    // Update count
                    await supabaseClient
                        .from('post_comments')
                        .update({ like_count: supabaseClient.raw('like_count - 1') })
                        .eq('id', commentId);
                } else {
                    // Like
                    await supabaseClient
                        .from('comment_likes')
                        .insert({
                            comment_id: commentId,
                            user_email: currentUser.email,
                            user_name: currentUser.username
                        });
                        
                    // Update count
                    await supabaseClient
                        .from('post_comments')
                        .update({ like_count: supabaseClient.raw('like_count + 1') })
                        .eq('id', commentId);
                }
                
                // Reload comments
                await loadComments();
                
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }
        
        // Show reply input
        function showReplyInput(commentId) {
            const replyDiv = document.getElementById(`reply-${commentId}`);
            replyDiv.innerHTML = `
                <div class="reply-input-wrapper">
                    <textarea class="reply-input" placeholder="Write a reply..."></textarea>
                    <div class="reply-actions">
                        <button class="reply-btn" onclick="submitComment('${commentId}')">Reply</button>
                        <button class="reply-btn cancel-btn" onclick="cancelReply('${commentId}')">Cancel</button>
                    </div>
                </div>
            `;
            replyDiv.querySelector('.reply-input').focus();
        }
        
        // Cancel reply
        function cancelReply(commentId) {
            document.getElementById(`reply-${commentId}`).innerHTML = '';
        }
        
        // Edit comment
        async function editComment(commentId) {
            const commentEl = document.getElementById(`comment-${commentId}`);
            const textEl = commentEl.querySelector('.comment-text');
            const currentText = textEl.textContent;
            
            textEl.innerHTML = `
                <textarea class="edit-input">${currentText}</textarea>
                <div class="edit-actions">
                    <button class="edit-btn" onclick="saveEdit('${commentId}')">Save</button>
                    <button class="edit-btn cancel-edit-btn" onclick="cancelEdit('${commentId}', '${escapeHtml(currentText)}')">Cancel</button>
                </div>
            `;
            
            textEl.querySelector('.edit-input').focus();
        }
        
        // Save edit
        async function saveEdit(commentId) {
            const editInput = document.querySelector(`#comment-${commentId} .edit-input`);
            const newContent = editInput.value.trim();
            
            if (!newContent) return;
            
            try {
                const { error } = await supabaseClient
                    .from('post_comments')
                    .update({ content: newContent })
                    .eq('id', commentId)
                    .eq('username', currentUser.username);
                
                if (error) throw error;
                
                await loadComments();
                
            } catch (error) {
                console.error('Error saving edit:', error);
                alert('Failed to save edit. Please try again.');
            }
        }
        
        // Cancel edit
        function cancelEdit(commentId, originalText) {
            const textEl = document.querySelector(`#comment-${commentId} .comment-text`);
            textEl.textContent = originalText;
        }
        
        // Delete comment
        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('post_comments')
                    .delete()
                    .eq('id', commentId)
                    .eq('username', currentUser.username);
                
                if (error) throw error;
                
                await loadComments();
                
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Failed to delete comment. Please try again.');
            }
        }
        
        // Toggle post like (demo only)
        function togglePostLike() {
            const btn = document.getElementById('likePostBtn');
            btn.classList.toggle('liked');
            
            const likesCount = document.getElementById('postLikesCount');
            const currentCount = parseInt(likesCount.textContent) || 0;
            
            if (btn.classList.contains('liked')) {
                likesCount.textContent = `${currentCount + 1} likes`;
            } else {
                likesCount.textContent = `${Math.max(0, currentCount - 1)} likes`;
            }
        }
        
        // Filter comments
        function filterComments(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Re-sort and display based on filter
            loadComments();
        }
        
        // Update comments count
        function updateCommentsCount(count) {
            document.getElementById('commentsCount').textContent = 
                count === 0 ? 'No comments yet' :
                count === 1 ? '1 Comment' :
                `${count} Comments`;
        }
        
        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
            
            return date.toLocaleDateString();
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Create notification
        async function createCommentNotification(parentCommentId) {
            try {
                // Get parent comment details
                const { data: parentComment } = await supabaseClient
                    .from('post_comments')
                    .select('username, user_id')
                    .eq('id', parentCommentId)
                    .single();
                
                if (parentComment && parentComment.username !== currentUser.username) {
                    // Create notification using notification-system.js pattern
                    await supabaseClient
                        .from('notifications')
                        .insert({
                            type: 'post_comment',
                            title: 'New reply to your comment',
                            message: `${currentUser.username} replied to your comment`,
                            recipient_email: parentComment.user_email || 'unknown@dcfhungary.org',
                            recipient_name: parentComment.username,
                            sender_email: currentUser.email,
                            sender_name: currentUser.username,
                            related_id: TEST_POST_ID,
                            related_type: 'post'
                        });
                }
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }
        
        // Setup real-time subscriptions
        function setupRealtimeSubscriptions() {
            // Subscribe to new comments
            supabaseClient
                .channel('comments-channel')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'post_comments',
                    filter: `post_id=eq.${TEST_POST_ID}`
                }, () => {
                    loadComments();
                })
                .subscribe();
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Update user info from auth
            updateUserAvatar();
            
            // Load initial comments
            loadComments();
            
            // Setup real-time updates
            setupRealtimeSubscriptions();
            
            // Setup comment input
            const commentInput = document.getElementById('newComment');
            const submitBtn = document.querySelector('.comment-submit');
            
            commentInput.addEventListener('input', function() {
                submitBtn.disabled = !this.value.trim();
                
                // Auto-resize
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Handle enter key
            commentInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!submitBtn.disabled) {
                        submitComment();
                    }
                }
            });
        });
    </script>
</body>
</html>