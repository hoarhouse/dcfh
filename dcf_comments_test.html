<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCF Comments System Test - Social Media Quality</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            line-height: 1.6;
            color: #262626;
        }

        .container {
            max-width: 614px;
            margin: 2rem auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Post Header */
        .post-header {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #efefef;
        }

        .post-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            margin-right: 12px;
        }

        .post-info {
            flex: 1;
        }

        .post-username {
            font-weight: 600;
            font-size: 14px;
            color: #262626;
            text-decoration: none;
        }

        .post-username:hover {
            text-decoration: underline;
        }

        .post-location {
            font-size: 12px;
            color: #8e8e8e;
        }

        .post-menu {
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .post-menu:hover {
            background: #f2f2f2;
        }

        /* Post Image */
        .post-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            display: block;
        }

        /* Post Actions */
        .post-actions {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid #efefef;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 8px;
            margin-right: 8px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: #f2f2f2;
            transform: scale(1.1);
        }

        .action-btn.liked {
            color: #ed4956;
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
        }

        .bookmark-btn {
            margin-left: auto;
        }

        /* Post Caption */
        .post-caption {
            padding: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .post-likes {
            padding: 0 16px 8px;
            font-weight: 600;
            font-size: 14px;
        }

        /* Comments Section */
        .comments-section {
            border-top: 1px solid #efefef;
        }

        .comments-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f2f2f2;
            background: #fafafa;
        }

        .comments-count {
            font-weight: 600;
            font-size: 14px;
            color: #262626;
        }

        .comments-filter {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            background: none;
            border: 1px solid #dbdbdb;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #f2f2f2;
        }

        .filter-btn.active {
            background: #0095f6;
            color: white;
            border-color: #0095f6;
        }

        /* Comment Input */
        .comment-input-section {
            padding: 16px;
            border-bottom: 1px solid #efefef;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .comment-input-wrapper {
            flex: 1;
            position: relative;
        }

        .comment-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 14px;
            resize: none;
            padding: 8px 12px;
            border-radius: 20px;
            background: #f2f2f2;
            min-height: 36px;
            max-height: 120px;
            font-family: inherit;
        }

        .comment-input:focus {
            background: #ffffff;
            box-shadow: 0 0 0 2px #0095f6;
        }

        .comment-submit {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #0095f6;
            color: white;
            border: none;
            border-radius: 16px;
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            pointer-events: none;
        }

        .comment-submit.active {
            opacity: 1;
            pointer-events: all;
        }

        .comment-submit:hover {
            background: #1877f2;
            transform: translateY(-50%) scale(1.05);
        }

        /* Comments List */
        .comments-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .comment {
            padding: 12px 16px;
            border-bottom: 1px solid #f8f8f8;
            transition: background 0.2s ease;
        }

        .comment:hover {
            background: #fafafa;
        }

        .comment.reply {
            margin-left: 44px;
            border-left: 2px solid #f2f2f2;
            padding-left: 16px;
        }

        .comment.reply.level-2 {
            margin-left: 68px;
        }

        .comment.reply.level-3 {
            margin-left: 92px;
        }

        .comment-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .comment-content {
            flex: 1;
        }

        .comment-user {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .comment-username {
            font-weight: 600;
            font-size: 13px;
            color: #262626;
            text-decoration: none;
        }

        .comment-username:hover {
            text-decoration: underline;
        }

        .comment-time {
            font-size: 12px;
            color: #8e8e8e;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .comment-text a {
            color: #0095f6;
            text-decoration: none;
        }

        .comment-text a:hover {
            text-decoration: underline;
        }

        .comment-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .comment-action {
            background: none;
            border: none;
            font-size: 12px;
            color: #8e8e8e;
            cursor: pointer;
            font-weight: 600;
            padding: 4px 0;
            transition: color 0.2s ease;
        }

        .comment-action:hover {
            color: #262626;
        }

        .comment-action.liked {
            color: #ed4956;
        }

        .comment-like-count {
            font-size: 12px;
            color: #8e8e8e;
            font-weight: 500;
        }

        .comment-menu {
            position: relative;
            margin-left: auto;
        }

        .comment-menu-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: #8e8e8e;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .comment-menu-btn:hover {
            background: #f2f2f2;
            color: #262626;
        }

        .comment-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid #dbdbdb;
            min-width: 120px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
        }

        .comment-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .comment-dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease;
            color: #262626;
        }

        .comment-dropdown-item:hover {
            background: #f2f2f2;
        }

        .comment-dropdown-item.danger {
            color: #ed4956;
        }

        .comment-dropdown-item.danger:hover {
            background: #fef7f7;
        }

        /* Reply Form */
        .reply-form {
            margin-top: 12px;
            margin-left: 44px;
            display: none;
            background: #fafafa;
            border-radius: 8px;
            padding: 12px;
        }

        .reply-form.active {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .reply-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 13px;
            resize: none;
            padding: 8px 12px;
            border-radius: 16px;
            background: white;
            min-height: 32px;
            max-height: 80px;
            font-family: inherit;
            border: 1px solid #dbdbdb;
        }

        .reply-input:focus {
            border-color: #0095f6;
            box-shadow: 0 0 0 2px rgba(0, 149, 246, 0.1);
        }

        .reply-submit {
            background: #0095f6;
            color: white;
            border: none;
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reply-submit:hover {
            background: #1877f2;
        }

        .reply-cancel {
            background: none;
            color: #8e8e8e;
            border: none;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .reply-cancel:hover {
            color: #262626;
        }

        /* Edit Form */
        .edit-form {
            display: none;
        }

        .edit-form.active {
            display: block;
        }

        .edit-input {
            width: 100%;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 40px;
            margin-bottom: 8px;
        }

        .edit-input:focus {
            border-color: #0095f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 149, 246, 0.1);
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .edit-save, .edit-cancel {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-save {
            background: #0095f6;
            color: white;
            border: none;
        }

        .edit-save:hover {
            background: #1877f2;
        }

        .edit-cancel {
            background: #f2f2f2;
            color: #262626;
            border: none;
        }

        .edit-cancel:hover {
            background: #e4e4e4;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: #8e8e8e;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0095f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }

            .comments-filter {
                flex-wrap: wrap;
            }

            .filter-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            .comment.reply {
                margin-left: 24px;
            }

            .comment.reply.level-2 {
                margin-left: 36px;
            }

            .comment.reply.level-3 {
                margin-left: 48px;
            }

            .reply-form {
                margin-left: 24px;
            }
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #262626;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #00ba7c;
        }

        .toast.error {
            background: #ed4956;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Post Header -->
        <div class="post-header">
            <div class="post-avatar">DCF</div>
            <div class="post-info">
                <a href="#" class="post-username">@dcfhungary</a>
                <div class="post-location">Budapest, Hungary</div>
            </div>
            <div class="post-menu">
                <svg fill="currentColor" height="16" width="16" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="1.5"></circle>
                    <circle cx="6" cy="12" r="1.5"></circle>
                    <circle cx="18" cy="12" r="1.5"></circle>
                </svg>
            </div>
        </div>

        <!-- Post Image -->
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjE0IiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY3ZWVhO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRiYTI7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyYWRpZW50KSIvPgogIDx0ZXh0IHg9IjUwJSIgeT0iNDAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjQiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QUkgRXRoaWNzIFN1bW1pdCBhdCBWYXRpY2FuPC90ZXh0PgogIDx0ZXh0IHg9IjUwJSIgeT0iNjAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBvcGFjaXR5PSIwLjkiPkRDRiBIdW5nYXJ5IGxlYWRpbmcgZ2xvYmFsIGRpc2N1c3Npb25zPC90ZXh0Pgo8L3N2Zz4=" alt="DCF AI Ethics Summit" class="post-image">

        <!-- Post Actions -->
        <div class="post-actions">
            <button class="action-btn like-btn" onclick="togglePostLike()">
                <svg fill="currentColor" height="24" width="24" viewBox="0 0 24 24">
                    <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
                </svg>
            </button>
            <button class="action-btn comment-btn" onclick="focusCommentInput()">
                <svg fill="currentColor" height="24" width="24" viewBox="0 0 24 24">
                    <path d="M20.656 17.008a9.993 9.993 0 1 0-3.59 3.615L22 22Z"></path>
                </svg>
            </button>
            <button class="action-btn share-btn">
                <svg fill="currentColor" height="24" width="24" viewBox="0 0 24 24">
                    <line fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2" x1="22" x2="9.218" y1="3" y2="10.083"></line>
                    <polygon fill="none" points="11.698 20.334 22 3.001 2 3.001 9.218 10.084 11.698 20.334" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></polygon>
                </svg>
            </button>
            <button class="action-btn bookmark-btn">
                <svg fill="currentColor" height="24" width="24" viewBox="0 0 24 24">
                    <polygon fill="none" points="20 21 12 13.44 4 21 4 3 20 3 20 21" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polygon>
                </svg>
            </button>
        </div>

        <!-- Post Likes -->
        <div class="post-likes">
            <span id="postLikes">847</span> likes
        </div>

        <!-- Post Caption -->
        <div class="post-caption">
            <strong>dcfhungary</strong> Incredible discussions at the Vatican AI Ethics Summit! 🏛️ DCF Hungary is proud to lead global conversations on ensuring AI development prioritizes human dignity and ethical principles. Thank you to all participants for meaningful dialogue on the future of technology. #AIEthics #VatikanSummit #TechForGood #HumanDignity
        </div>

        <!-- Comments Section -->
        <div class="comments-section">
            <!-- Comments Header -->
            <div class="comments-header">
                <div class="comments-count">
                    View all <span id="commentsCount">0</span> comments
                </div>
                <div class="comments-filter">
                    <button class="filter-btn active" onclick="filterComments('newest')">Newest</button>
                    <button class="filter-btn" onclick="filterComments('oldest')">Oldest</button>
                    <button class="filter-btn" onclick="filterComments('most_liked')">Most Liked</button>
                    <button class="filter-btn" onclick="filterComments('most_replies')">Most Replies</button>
                </div>
            </div>

            <!-- Comment Input -->
            <div class="comment-input-section">
                <div class="comment-avatar">YO</div>
                <div class="comment-input-wrapper">
                    <textarea 
                        class="comment-input" 
                        placeholder="Add a comment..." 
                        id="commentInput"
                        onkeydown="handleCommentKeyPress(event)"
                        oninput="toggleSubmitButton()"
                    ></textarea>
                    <button class="comment-submit" id="commentSubmit" onclick="submitComment()">Post</button>
                </div>
            </div>

            <!-- Comments List -->
            <div class="comments-list" id="commentsList">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading comments...
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://atzommnkkwzgbktuzjti.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global state
        let currentUser = { email: 'test@dcfhungary.org', username: 'testuser', name: 'Test User' };
        let comments = [];
        let currentFilter = 'newest';
        const testPostId = 'test-post-ai-ethics-summit';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadComments();
        });

        // Comment input handling
        function toggleSubmitButton() {
            const input = document.getElementById('commentInput');
            const submit = document.getElementById('commentSubmit');
            
            if (input.value.trim()) {
                submit.classList.add('active');
            } else {
                submit.classList.remove('active');
            }
        }

        function handleCommentKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (document.getElementById('commentInput').value.trim()) {
                    submitComment();
                }
            }
        }

        function focusCommentInput() {
            document.getElementById('commentInput').focus();
        }

        // Time formatting
        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return '1m';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd';
            if (seconds < 2629746) return Math.floor(seconds / 604800) + 'w';
            if (seconds < 31556952) return Math.floor(seconds / 2629746) + 'mo';
            return Math.floor(seconds / 31556952) + 'y';
        }

        // Make links clickable
        function makeLinksClickable(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const mentionRegex = /@(\w+)/g;
            
            return text
                .replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>')
                .replace(mentionRegex, '<a href="#" onclick="viewProfile(\'$1\')">@$1</a>');
        }

        function viewProfile(username) {
            showToast(`Viewing profile: @${username}`, 'success');
        }

        // Submit comment
        async function submitComment() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            
            if (!content) return;

            try {
                const { data, error } = await supabase
                    .from('post_comments')
                    .insert({
                        post_id: testPostId,
                        content: content,
                        username: currentUser.username,
                        user_email: currentUser.email,
                        user_name: currentUser.name,
                        like_count: 0,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                input.value = '';
                toggleSubmitButton();
                loadComments();
                showToast('Comment posted!', 'success');

            } catch (error) {
                console.error('Error posting comment:', error);
                showToast('Failed to post comment', 'error');
            }
        }

        // Load comments
        async function loadComments() {
            try {
                let query = supabase
                    .from('post_comments')
                    .select('*')
                    .eq('post_id', testPostId);

                // Apply filtering
                switch (currentFilter) {
                    case 'newest':
                        query = query.order('created_at', { ascending: false });
                        break;
                    case 'oldest':
                        query = query.order('created_at', { ascending: true });
                        break;
                    case 'most_liked':
                        query = query.order('like_count', { ascending: false });
                        break;
                    case 'most_replies':
                        // For now, just use like_count as proxy
                        query = query.order('like_count', { ascending: false });
                        break;
                }

                const { data, error } = await query;

                if (error) throw error;

                comments = data || [];
                renderComments();

            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('commentsList').innerHTML = 
                    '<div class="loading">Failed to load comments</div>';
            }
        }

        // Render comments
        function renderComments() {
            const container = document.getElementById('commentsList');
            const countElement = document.getElementById('commentsCount');
            
            countElement.textContent = comments.length;

            if (comments.length === 0) {
                container.innerHTML = '<div class="loading">No comments yet. Be the first to comment!</div>';
                return;
            }

            container.innerHTML = comments.map(comment => createCommentHTML(comment)).join('');
        }

        // Create comment HTML
        function createCommentHTML(comment) {
            const isOwner = comment.user_email === currentUser.email;
            const initials = (comment.user_name || comment.username || 'U')
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);

            return `
                <div class="comment" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <div class="comment-avatar">${initials}</div>
                        <div class="comment-content">
                            <div class="comment-user">
                                <a href="#" class="comment-username" onclick="viewProfile('${comment.username}')">@${comment.username}</a>
                                <span class="comment-time">${formatTimeAgo(comment.created_at)}</span>
                            </div>
                            <div class="comment-text" id="commentText-${comment.id}">
                                ${makeLinksClickable(comment.content)}
                            </div>
                            <div class="edit-form" id="editForm-${comment.id}">
                                <textarea class="edit-input" id="editInput-${comment.id}">${comment.content}</textarea>
                                <div class="edit-actions">
                                    <button class="edit-cancel" onclick="cancelEdit('${comment.id}')">Cancel</button>
                                    <button class="edit-save" onclick="saveEdit('${comment.id}')">Save</button>
                                </div>
                            </div>
                            <div class="comment-actions">
                                <button class="comment-action like-comment-btn ${comment.is_liked ? 'liked' : ''}" 
                                        onclick="toggleCommentLike('${comment.id}')">
                                    ❤ ${comment.like_count || 0}
                                </button>
                                <button class="comment-action" onclick="showReplyForm('${comment.id}')">Reply</button>
                                ${isOwner ? `<button class="comment-action" onclick="startEdit('${comment.id}')">Edit</button>` : ''}
                                <span class="comment-like-count">${comment.like_count || 0} likes</span>
                            </div>
                        </div>
                        ${isOwner ? `
                            <div class="comment-menu">
                                <button class="comment-menu-btn" onclick="toggleCommentMenu('${comment.id}')">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="1.5"></circle>
                                        <circle cx="6" cy="12" r="1.5"></circle>
                                        <circle cx="18" cy="12" r="1.5"></circle>
                                    </svg>
                                </button>
                                <div class="comment-dropdown" id="commentMenu-${comment.id}">
                                    <button class="comment-dropdown-item" onclick="startEdit('${comment.id}')">Edit</button>
                                    <button class="comment-dropdown-item danger" onclick="deleteComment('${comment.id}')">Delete</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="reply-form" id="replyForm-${comment.id}">
                        <div class="comment-avatar">${currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                        <textarea class="reply-input" placeholder="Write a reply..." id="replyInput-${comment.id}"></textarea>
                        <button class="reply-submit" onclick="submitReply('${comment.id}')">Reply</button>
                        <button class="reply-cancel" onclick="hideReplyForm('${comment.id}')">Cancel</button>
                    </div>
                </div>
            `;
        }

        // Comment actions
        async function toggleCommentLike(commentId) {
            try {
                const comment = comments.find(c => c.id === commentId);
                const isCurrentlyLiked = comment.is_liked;
                const newLikeCount = isCurrentlyLiked ? 
                    (comment.like_count || 0) - 1 : 
                    (comment.like_count || 0) + 1;

                // Update database
                const { error } = await supabase
                    .from('post_comments')
                    .update({ 
                        like_count: newLikeCount
                    })
                    .eq('id', commentId);

                if (error) throw error;

                // Update local state
                comment.like_count = newLikeCount;
                comment.is_liked = !isCurrentlyLiked;

                // Update UI
                const likeBtn = document.querySelector(`[data-comment-id="${commentId}"] .like-comment-btn`);
                likeBtn.textContent = `❤ ${newLikeCount}`;
                likeBtn.classList.toggle('liked', !isCurrentlyLiked);

                const likeCount = document.querySelector(`[data-comment-id="${commentId}"] .comment-like-count`);
                likeCount.textContent = `${newLikeCount} likes`;

                // Manage comment_likes table
                if (!isCurrentlyLiked) {
                    await supabase
                        .from('comment_likes')
                        .insert({
                            comment_id: commentId,
                            user_email: currentUser.email,
                            created_at: new Date().toISOString()
                        });
                } else {
                    await supabase
                        .from('comment_likes')
                        .delete()
                        .eq('comment_id', commentId)
                        .eq('user_email', currentUser.email);
                }

            } catch (error) {
                console.error('Error toggling like:', error);
                showToast('Failed to update like', 'error');
            }
        }

        function showReplyForm(commentId) {
            // Hide all other reply forms
            document.querySelectorAll('.reply-form').forEach(form => {
                form.classList.remove('active');
            });
            
            const replyForm = document.getElementById(`replyForm-${commentId}`);
            replyForm.classList.add('active');
            document.getElementById(`replyInput-${commentId}`).focus();
        }

        function hideReplyForm(commentId) {
            const replyForm = document.getElementById(`replyForm-${commentId}`);
            replyForm.classList.remove('active');
            document.getElementById(`replyInput-${commentId}`).value = '';
        }

        async function submitReply(commentId) {
            const input = document.getElementById(`replyInput-${commentId}`);
            const content = input.value.trim();
            
            if (!content) return;

            try {
                const { data, error } = await supabase
                    .from('post_comments')
                    .insert({
                        post_id: testPostId,
                        content: content,
                        username: currentUser.username,
                        user_email: currentUser.email,
                        user_name: currentUser.name,
                        parent_comment_id: commentId,
                        like_count: 0,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                hideReplyForm(commentId);
                loadComments();
                showToast('Reply posted!', 'success');

            } catch (error) {
                console.error('Error posting reply:', error);
                showToast('Failed to post reply', 'error');
            }
        }

        function startEdit(commentId) {
            const textDiv = document.getElementById(`commentText-${commentId}`);
            const editForm = document.getElementById(`editForm-${commentId}`);
            const menu = document.getElementById(`commentMenu-${commentId}`);
            
            textDiv.style.display = 'none';
            editForm.classList.add('active');
            if (menu) menu.classList.remove('active');
            
            document.getElementById(`editInput-${commentId}`).focus();
        }

        function cancelEdit(commentId) {
            const textDiv = document.getElementById(`commentText-${commentId}`);
            const editForm = document.getElementById(`editForm-${commentId}`);
            
            textDiv.style.display = 'block';
            editForm.classList.remove('active');
        }

        async function saveEdit(commentId) {
            const input = document.getElementById(`editInput-${commentId}`);
            const newContent = input.value.trim();
            
            if (!newContent) return;

            try {
                const { error } = await supabase
                    .from('post_comments')
                    .update({ 
                        content: newContent,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', commentId);

                if (error) throw error;

                // Update local state
                const comment = comments.find(c => c.id === commentId);
                comment.content = newContent;

                // Update UI
                const textDiv = document.getElementById(`commentText-${commentId}`);
                textDiv.innerHTML = makeLinksClickable(newContent);
                
                cancelEdit(commentId);
                showToast('Comment updated!', 'success');

            } catch (error) {
                console.error('Error updating comment:', error);
                showToast('Failed to update comment', 'error');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;

            try {
                const { error } = await supabase
                    .from('post_comments')
                    .delete()
                    .eq('id', commentId);

                if (error) throw error;

                loadComments();
                showToast('Comment deleted!', 'success');

            } catch (error) {
                console.error('Error deleting comment:', error);
                showToast('Failed to delete comment', 'error');
            }
        }

        function toggleCommentMenu(commentId) {
            // Close all other menus
            document.querySelectorAll('.comment-dropdown').forEach(menu => {
                if (menu.id !== `commentMenu-${commentId}`) {
                    menu.classList.remove('active');
                }
            });

            const menu = document.getElementById(`commentMenu-${commentId}`);
            menu.classList.toggle('active');
        }

        // Filter comments
        function filterComments(filter) {
            currentFilter = filter;
            
            // Update filter button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            loadComments();
        }

        // Post actions
        function togglePostLike() {
            const likeBtn = document.querySelector('.like-btn');
            const likesElement = document.getElementById('postLikes');
            const currentLikes = parseInt(likesElement.textContent);
            
            likeBtn.classList.toggle('liked');
            
            if (likeBtn.classList.contains('liked')) {
                likesElement.textContent = currentLikes + 1;
                likeBtn.innerHTML = `
                    <svg fill="#ed4956" height="24" width="24" viewBox="0 0 24 24">
                        <path d="M17.5 1.917a6.4 6.4 0 0 0-5.5 3.3 6.4 6.4 0 0 0-5.5-3.3A6.8 6.8 0 0 0 0 8.967c0 4.547 4.786 9.513 8.8 12.88a4.974 4.974 0 0 0 6.4 0C19.214 18.48 24 13.514 24 8.967A6.8 6.8 0 0 0 17.5 1.917Z"></path>
                    </svg>
                `;
            } else {
                likesElement.textContent = currentLikes - 1;
                likeBtn.innerHTML = `
                    <svg fill="currentColor" height="24" width="24" viewBox="0 0 24 24">
                        <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
                    </svg>
                `;
            }
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.comment-menu')) {
                document.querySelectorAll('.comment-dropdown').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });

        // Auto-resize textareas
        document.addEventListener('input', function(event) {
            if (event.target.matches('textarea')) {
                event.target.style.height = 'auto';
                event.target.style.height = event.target.scrollHeight + 'px';
            }
        });
    </script>
</body>
</html>