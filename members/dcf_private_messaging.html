<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - DCF Hungary</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23dc3545'/></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: #333;
            border-radius: 50%;
            margin-right: 8px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            text-decoration: none;
            color: #666;
            font-size: 0.9rem;
            position: relative;
        }

        .nav-menu a.active {
            color: #333;
            font-weight: 600;
        }

        .nav-menu a:hover {
            color: #333;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
        }

        .user-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e5e5;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

                .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #666;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow: hidden;
            /* Content controlled by master-consolidated.js */
        }

        .user-avatar:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dropdown-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #000, #333);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
            box-sizing: border-box;
            overflow: hidden;
        }

        .dropdown-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-email {
            color: #666;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-divider {
            height: 1px;
            background: #f0f0f0;
            margin: 0.5rem 0;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #000;
        }

        .logout-btn {
            color: #dc3545 !important;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #fee !important;
            color: #c82333 !important;
        }

        .dropdown-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            display: none;
        }

        .dropdown-overlay.active {
            display: block;
        }

    

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            height: calc(100vh - 90px);
        }

        .messaging-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100%;
            overflow: hidden;
        }

        .sidebar {
            border-right: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .new-message-btn {
            background: #000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .new-message-btn:hover {
            background: #333;
        }

        .search-container {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e5e5;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #f8f9fa;
        }

        .search-input:focus {
            outline: none;
            border-color: #333;
            background: white;
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .conversation-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
        }

        .conversation-item:hover {
            background: #f8f9fa;
        }

        .conversation-item.active {
            background: #f0f0f0;
            border-right: 3px solid #333;
        }

        .conversation-item.unread {
            background: #fffbf0;
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .conversation-preview {
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-item.unread .conversation-preview {
            font-weight: 600;
            color: #333;
        }

        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .conversation-time {
            color: #999;
            font-size: 0.8rem;
        }

        .unread-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #28a745;
            border-radius: 50%;
            border: 2px solid white;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            position: relative;
        }

        .chat-user-details {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .chat-user-status {
            color: #666;
            font-size: 0.9rem;
        }

        .chat-user-status.online {
            color: #28a745;
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .chat-action-btn:hover {
            background: #f8f9fa;
            color: #333;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            max-width: 70%;
        }

        .message.sent {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .message-sender {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .message-time {
            color: #999;
            font-size: 0.8rem;
        }

        .message-bubble {
            background: #f8f9fa;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            color: #333;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: #000;
            color: white;
            border-color: #000;
        }

        .message-reactions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .reaction {
            background: #f8f9fa;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reaction:hover {
            background: #e9ecef;
        }

        .reaction.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        .message-input-container {
            padding: 1rem;
            border-top: 1px solid #e5e5e5;
            background: #f8f9fa;
        }

        .message-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            background: white;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            padding: 0.75rem;
            transition: border-color 0.3s ease;
        }

        .message-input-wrapper:focus-within {
            border-color: #333;
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            line-height: 1.4;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .message-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .message-action-btn:hover {
            background: #f8f9fa;
            color: #333;
        }

        .send-btn {
            background: #000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: #333;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #333;
        }

        .textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .textarea:focus {
            outline: none;
            border-color: #333;
        }

        .member-search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .member-result {
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background-color 0.3s ease;
        }

        .member-result:hover {
            background: #f8f9fa;
        }

        .member-result:last-child {
            border-bottom: none;
        }

        .member-result-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .member-result-info {
            flex: 1;
        }

        .member-result-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .member-result-role {
            color: #666;
            font-size: 0.9rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .btn-primary {
            background: #000;
            color: white;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: transparent;
            color: #666;
            border: 2px solid #e5e5e5;
        }

        .btn-secondary:hover {
            color: #333;
            border-color: #333;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        @media (max-width: 1024px) {
            .messaging-container {
                grid-template-columns: 280px 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }

            .messaging-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e5e5e5;
                height: auto;
                max-height: 300px;
            }

            .chat-container {
                min-height: 0;
            }

            .nav-menu {
                display: none;
            }

            .message {
                max-width: 85%;
            }

            .sidebar-header {
                padding: 1rem;
            }

            .conversation-list {
                max-height: 200px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/dcf-unified-auth.js"></script>
</head>

<body>
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <div class="logo-icon"></div>
                Domus Communis Foundation
            </a>
            <ul class="nav-menu" id="navMenu">
            </ul>
            <div class="user-menu">
    <div class="user-dropdown">
        <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar"></div>
        <div class="dropdown-menu" id="userDropdown">
            <div class="dropdown-header">
                <div class="dropdown-avatar"></div>
                <div class="dropdown-info">
                    <div class="dropdown-name" id="dropdownUserName"></div>
                    <div class="dropdown-email" id="dropdownUserEmail"></div>
                </div>
            </div>
            <!-- Navigation will be dynamically generated by dcf-unified-auth.js -->
        </div>
    </div>
</div>
        </nav>
    </header>

    <main class="main-container">
        <div class="messaging-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h1 class="sidebar-title">Messages</h1>
                    <button class="new-message-btn" onclick="openNewMessageModal()" title="New Message">+</button>
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search conversations..." id="conversationSearch">
                </div>

                <div class="conversation-list" id="conversationList">
                    <div class="conversation-item unread active" data-conversation="mary-aiken">
                        <div class="conversation-avatar">MA</div>
                        <div class="conversation-info">
                            <div class="conversation-name">Dr. Mary Aiken</div>
                            <div class="conversation-preview">Thanks for sharing the child safety research. Let's discuss the implications for our upcoming workshop.</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">2 min ago</div>
                            <div class="unread-badge">2</div>
                        </div>
                        <div class="online-indicator"></div>
                    </div>

                    <div class="conversation-item" data-conversation="michael-torres">
                        <div class="conversation-avatar">MT</div>
                        <div class="conversation-info">
                            <div class="conversation-name">Fr. Michael Torres</div>
                            <div class="conversation-preview">The theological framework document is ready for review. Would you like to schedule a call to discuss?</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">1 hour ago</div>
                        </div>
                    </div>

                    <div class="conversation-item" data-conversation="antal-kuthy">
                        <div class="conversation-avatar">AK</div>
                        <div class="conversation-info">
                            <div class="conversation-name">Dr. Antal Kuthy</div>
                            <div class="conversation-preview">Great presentation at the conference! The AI governance section was particularly insightful.</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">3 hours ago</div>
                        </div>
                        <div class="online-indicator"></div>
                    </div>

                    <div class="conversation-item" data-conversation="alessio-pecorario">
                        <div class="conversation-avatar">AP</div>
                        <div class="conversation-info">
                            <div class="conversation-name">Dr. Alessio Pecorario</div>
                            <div class="conversation-preview">The EU AI Act compliance guide is now available. I've updated the resource library with the latest version.</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">Yesterday</div>
                        </div>
                    </div>

                    <div class="conversation-item unread" data-conversation="project-team">
                        <div class="conversation-avatar">PT</div>
                        <div class="conversation-info">
                            <div class="conversation-name">AI Ethics Project Team</div>
                            <div class="conversation-preview">New milestone completed! Check out the updated project dashboard for the latest progress.</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">Yesterday</div>
                            <div class="unread-badge">1</div>
                        </div>
                    </div>

                    <div class="conversation-item" data-conversation="greg-sim">
                        <div class="conversation-avatar">GS</div>
                        <div class="conversation-info">
                            <div class="conversation-name">Greg Sim</div>
                            <div class="conversation-preview">Looking forward to our collaboration on the cybersecurity framework. When would be a good time to connect?</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">2 days ago</div>
                        </div>
                    </div>

                    <div class="conversation-item" data-conversation="zoltan-papp">
                        <div class="conversation-avatar">ZP</div>
                        <div class="conversation-info">
                            <div class="conversation-name">Zoltan Papp</div>
                            <div class="conversation-preview">The patent application for the new AI safety protocol has been submitted. I'll keep you updated on the progress.</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">1 week ago</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="chat-header">
                    <div class="chat-user-info">
                        <div class="chat-avatar">
                            MA
                            <div class="online-indicator"></div>
                        </div>
                        <div class="chat-user-details">
                            <div class="chat-user-name">Dr. Mary Aiken</div>
                            <div class="chat-user-status online">Online ‚Ä¢ Active now</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="startVideoCall()" title="Video Call">üìπ</button>
                        <button class="chat-action-btn" onclick="startVoiceCall()" title="Voice Call">üìû</button>
                        <button class="chat-action-btn" onclick="openChatInfo()" title="Chat Info">‚ÑπÔ∏è</button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message">
                        <div class="message-avatar">MA</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-sender">Dr. Mary Aiken</div>
                                <div class="message-time">Today at 2:15 PM</div>
                            </div>
                            <div class="message-bubble">
                                Hi Sarah! I hope you're doing well. I wanted to follow up on our discussion about child safety in AI systems. Have you had a chance to review the research paper I sent?
                            </div>
                        </div>
                    </div>

                    <div class="message sent">
                        <div class="message-avatar">SJ</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-sender">You</div>
                                <div class="message-time">Today at 2:18 PM</div>
                            </div>
                            <div class="message-bubble">
                                Hi Mary! Yes, I've reviewed it thoroughly. The findings about age-appropriate AI interactions are fascinating. I think this could be a cornerstone for our upcoming workshop on ethical AI development.
                            </div>
                        </div>
                    </div>

                    <div class="message">
                        <div class="message-avatar">MA</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-sender">Dr. Mary Aiken</div>
                                <div class="message-time">Today at 2:20 PM</div>
                            </div>
                            <div class="message-bubble">
                                I'm so glad you found it valuable! The section on developmental psychology and AI interaction patterns took months to research. Would you be interested in co-presenting this at the workshop?
                            </div>
                            <div class="message-reactions">
                                <div class="reaction">üëç 2</div>
                                <div class="reaction">‚ù§Ô∏è 1</div>
                            </div>
                        </div>
                    </div>

                    <div class="message sent">
                        <div class="message-avatar">SJ</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-sender">You</div>
                                <div class="message-time">Today at 2:22 PM</div>
                            </div>
                            <div class="message-bubble">
                                Absolutely! I'd love to co-present with you. We could structure it as a dialogue between cyberpsychology and AI ethics perspectives. What do you think?
                            </div>
                        </div>
                    </div>

                    <div class="message">
                        <div class="message-avatar">MA</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-sender">Dr. Mary Aiken</div>
                                <div class="message-time">Today at 2:25 PM</div>
                            </div>
                            <div class="message-bubble">
                                That's a brilliant approach! The interdisciplinary perspective will be so valuable for our audience. Should we schedule a call this week to outline the presentation structure?
                            </div>
                        </div>
                    </div>

                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        <span>Dr. Mary Aiken is typing</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>

                <div class="message-input-container">
                    <div class="message-input-wrapper">
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="attachFile()" title="Attach File">üìé</button>
                            <button class="message-action-btn" onclick="addEmoji()" title="Add Emoji">üòä</button>
                        </div>
                        <textarea class="message-input" placeholder="Type your message..." id="messageInput" rows="1"></textarea>
                        <button class="send-btn" onclick="sendMessage()" id="sendButton" disabled>‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- New Message Modal -->
    <div class="modal" id="newMessageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">New Message</h2>
                <button class="close-btn" onclick="closeModal('newMessageModal')">&times;</button>
            </div>
            <form id="newMessageForm">
                <div class="form-group">
                    <label class="form-label" for="recipientSearch">To:</label>
                    <input type="text" id="recipientSearch" class="form-input" placeholder="Search for a member to message...">
                    <div class="member-search-results" id="memberSearchResults" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="messageSubject">Subject (Optional):</label>
                    <input type="text" id="messageSubject" class="form-input" placeholder="Enter message subject...">
                </div>
                <div class="form-group">
                    <label class="form-label" for="newMessageText">Message:</label>
                    <textarea id="newMessageText" class="textarea" placeholder="Type your message..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newMessageModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Message</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // SECURITY: Comprehensive Input Sanitization
        // ============================================
        // This private messaging form implements bulletproof input sanitization to prevent:
        // 1. Cross-Site Scripting (XSS) attacks
        // 2. SQL Injection attacks
        // 3. JavaScript injection
        // 4. HTML/XML injection
        // 5. Command injection
        // 6. Buffer overflow attempts
        // All inputs are sanitized both in real-time and on submission
        
        /**
         * Comprehensive input sanitization function
         * Removes dangerous patterns, scripts, and injection attempts
         */
        function sanitizeInput(input) {
            if (typeof input !== 'string') {
                return '';
            }
            
            // Store original length for logging
            const originalLength = input.length;
            
            // Step 1: Remove all HTML/XML tags including script tags
            let sanitized = input.replace(/<\/?[^>]+(>|$)/gi, '');
            
            // Step 2: Remove JavaScript event handlers
            sanitized = sanitized.replace(/on\w+\s*=\s*["'][^"']*["']/gi, '');
            sanitized = sanitized.replace(/on\w+\s*=\s*[^\s>]*/gi, '');
            
            // Step 3: Remove javascript:, data:, vbscript: and other dangerous URL schemes
            sanitized = sanitized.replace(/javascript\s*:/gi, '');
            sanitized = sanitized.replace(/data\s*:/gi, '');
            sanitized = sanitized.replace(/vbscript\s*:/gi, '');
            sanitized = sanitized.replace(/about\s*:/gi, '');
            sanitized = sanitized.replace(/chrome\s*:/gi, '');
            sanitized = sanitized.replace(/file\s*:/gi, '');
            
            // Step 4: Remove SQL injection patterns
            const sqlPatterns = [
                /(\b)(DROP|DELETE|INSERT|UPDATE|SELECT|UNION|CREATE|ALTER|EXEC|EXECUTE|SCRIPT|TRUNCATE)(\b)/gi,
                /(--)|(\/\*[\s\S]*?\*\/)/g,  // SQL comments
                /(\b)(OR|AND)(\b)\s*\d+\s*=\s*\d+/gi,  // OR 1=1 patterns
                /(\b)(OR|AND)(\b)\s*['"][^'"]*['"]\s*=\s*['"][^'"]*['"]/gi,  // OR 'a'='a' patterns
                /;.*(DROP|DELETE|INSERT|UPDATE|SELECT)/gi,  // Semicolon followed by SQL command
                /\bWAITFOR\s+DELAY/gi,  // SQL Server delay attacks
                /\bBENCHMARK\s*\(/gi,  // MySQL benchmark attacks
                /\bSLEEP\s*\(/gi  // Sleep attacks
            ];
            
            sqlPatterns.forEach(pattern => {
                sanitized = sanitized.replace(pattern, '');
            });
            
            // Step 5: Remove inline styles that could be malicious
            sanitized = sanitized.replace(/style\s*=\s*["'][^"']*["']/gi, '');
            sanitized = sanitized.replace(/style\s*=\s*[^\s>]*/gi, '');
            
            // Step 6: Remove potentially dangerous characters in specific contexts
            // But preserve valid email and password characters
            const dangerousChars = [
                /[<>]/g,  // Angle brackets
                /&#/g,  // HTML entities
                /\\x[0-9a-fA-F]{2}/g,  // Hex escapes
                /\\u[0-9a-fA-F]{4}/g,  // Unicode escapes
                /\0/g  // Null bytes
            ];
            
            dangerousChars.forEach(pattern => {
                sanitized = sanitized.replace(pattern, '');
            });
            
            // Step 7: Remove any remaining script-like patterns
            sanitized = sanitized.replace(/\beval\s*\(/gi, '');
            sanitized = sanitized.replace(/\bexecScript\s*\(/gi, '');
            sanitized = sanitized.replace(/\bsetTimeout\s*\(/gi, '');
            sanitized = sanitized.replace(/\bsetInterval\s*\(/gi, '');
            sanitized = sanitized.replace(/\bFunction\s*\(/gi, '');
            sanitized = sanitized.replace(/\bnew\s+Function/gi, '');
            
            // Step 8: Remove encoded scripts
            sanitized = sanitized.replace(/%3Cscript/gi, '');
            sanitized = sanitized.replace(/%3C%2Fscript/gi, '');
            sanitized = sanitized.replace(/\\x3cscript/gi, '');
            sanitized = sanitized.replace(/\\u003cscript/gi, '');
            
            // Step 9: Normalize whitespace
            sanitized = sanitized.replace(/\s+/g, ' ').trim();
            
            // Log if content was sanitized (for security monitoring)
            if (sanitized.length !== originalLength || sanitized !== input) {
                console.warn('‚ö†Ô∏è Input sanitization applied. Potential attack attempt blocked.');
                console.log('Original length:', originalLength, 'Sanitized length:', sanitized.length);
            }
            
            return sanitized;
        }
        
        /**
         * Email-specific sanitization
         * Preserves valid email format while removing dangerous content
         */
        function sanitizeEmail(email) {
            if (typeof email !== 'string') {
                return '';
            }
            
            // First apply general sanitization
            let sanitized = sanitizeInput(email);
            
            // Remove any remaining non-email characters
            // Allow only valid email characters: alphanumeric, @, ., _, -, +
            sanitized = sanitized.replace(/[^a-zA-Z0-9@._\-+]/g, '');
            
            // Ensure only one @ symbol
            const atCount = (sanitized.match(/@/g) || []).length;
            if (atCount > 1) {
                // Keep only the first @ and remove others
                let firstAt = sanitized.indexOf('@');
                let beforeAt = sanitized.substring(0, firstAt);
                let afterAt = sanitized.substring(firstAt + 1).replace(/@/g, '');
                sanitized = beforeAt + '@' + afterAt;
            }
            
            // Limit length to prevent buffer overflow attempts
            if (sanitized.length > 254) {  // RFC 5321 max email length
                sanitized = sanitized.substring(0, 254);
            }
            
            return sanitized.toLowerCase();
        }
        
        /**
         * Message-specific sanitization
         * Removes dangerous patterns while preserving normal text
         */
        function sanitizeMessage(text, maxLength = 5000) {
            if (typeof text !== 'string') {
                return '';
            }
            
            // Apply general sanitization
            let sanitized = sanitizeInput(text);
            
            // Limit length based on field requirements
            if (sanitized.length > maxLength) {
                sanitized = sanitized.substring(0, maxLength);
            }
            
            return sanitized;
        }
        
        /**
         * Search-specific sanitization
         * Removes dangerous patterns while preserving search terms
         */
        function sanitizeSearch(text, maxLength = 100) {
            if (typeof text !== 'string') {
                return '';
            }
            
            // Apply general sanitization
            let sanitized = sanitizeInput(text);
            
            // Limit length based on field requirements
            if (sanitized.length > maxLength) {
                sanitized = sanitized.substring(0, maxLength);
            }
            
            return sanitized;
        }
        
        /**
         * Safely set text content to prevent XSS
         */
        function safeSetTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                // Use textContent instead of innerHTML to prevent XSS
                element.textContent = sanitizeInput(text);
            }
        }
        
        /**
         * Apply real-time sanitization to form inputs
         */
        function initializeInputSanitization() {
            // Conversation search field
            const conversationSearch = document.getElementById('conversationSearch');
            if (conversationSearch) {
                conversationSearch.addEventListener('input', function(e) {
                    const sanitized = sanitizeSearch(e.target.value, 100);
                    if (sanitized !== e.target.value) {
                        e.target.value = sanitized;
                        console.warn('Conversation search input sanitized');
                    }
                });
                conversationSearch.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    e.target.value = sanitizeSearch(pastedText, 100);
                });
            }
            
            // Message input field
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function(e) {
                    const sanitized = sanitizeMessage(e.target.value, 5000);
                    if (sanitized !== e.target.value) {
                        e.target.value = sanitized;
                        console.warn('Message input sanitized');
                    }
                });
                messageInput.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    e.target.value = sanitizeMessage(pastedText, 5000);
                });
            }
            
            // Recipient search field
            const recipientSearch = document.getElementById('recipientSearch');
            if (recipientSearch) {
                recipientSearch.addEventListener('input', function(e) {
                    const sanitized = sanitizeSearch(e.target.value, 100);
                    if (sanitized !== e.target.value) {
                        e.target.value = sanitized;
                        console.warn('Recipient search input sanitized');
                    }
                });
                recipientSearch.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    e.target.value = sanitizeSearch(pastedText, 100);
                });
            }
            
            // Message subject field
            const messageSubject = document.getElementById('messageSubject');
            if (messageSubject) {
                messageSubject.addEventListener('input', function(e) {
                    const sanitized = sanitizeMessage(e.target.value, 200);
                    if (sanitized !== e.target.value) {
                        e.target.value = sanitized;
                        console.warn('Message subject sanitized');
                    }
                });
                messageSubject.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    e.target.value = sanitizeMessage(pastedText, 200);
                });
            }
            
            // New message text field
            const newMessageText = document.getElementById('newMessageText');
            if (newMessageText) {
                newMessageText.addEventListener('input', function(e) {
                    const sanitized = sanitizeMessage(e.target.value, 5000);
                    if (sanitized !== e.target.value) {
                        e.target.value = sanitized;
                        console.warn('New message text sanitized');
                    }
                });
                newMessageText.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    e.target.value = sanitizeMessage(pastedText, 5000);
                });
            }
        }
        
        // Global variables
        let currentUser = null;
        let supabase = null;
        let currentConversation = null; // Will be set to actual user ID
        let currentRecipient = null; // Current conversation recipient
        let conversations = {};
        let connectedUsers = []; // Will be loaded from database
        let messageSubscription = null; // For real-time updates

        // Initialize messaging with unified auth
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîç Private Messaging page loaded');
            
            // SECURITY: Initialize input sanitization
            initializeInputSanitization();
            console.log('‚úÖ Security: Input sanitization initialized');
            
            await initializeMessagingWithAuth();
        });

        async function initializeMessagingWithAuth() {
            try {
                // Use unified auth client exclusively
                supabase = window.dcfSupabase;
                
                if (!supabase) {
                    console.log('‚ö†Ô∏è Database connection not available - waiting...');
                    // Wait for Supabase to be ready
                    let attempts = 0;
                    while (!window.dcfSupabase && attempts < 20) {
                        await new Promise(resolve => setTimeout(resolve, 150));
                        attempts++;
                    }
                    supabase = window.dcfSupabase;
                    
                    if (!supabase) {
                        console.error('‚ùå Database connection failed after waiting');
                        showError('Database connection not available. Please refresh the page.');
                        return;
                    }
                }

                // Wait for unified auth system to be ready first
                let authAttempts = 0;
                const maxAttempts = 20; // 20 attempts
                const waitInterval = 150; // 150ms per attempt (3 seconds total)
                
                console.log('üîÑ Waiting for unified auth system to initialize...');
                
                // First, wait for the auth system itself to be ready
                while (!window.getCurrentUser && authAttempts < maxAttempts) {
                    console.log(`‚è≥ Auth system not ready yet (attempt ${authAttempts + 1}/${maxAttempts})`);
                    await new Promise(resolve => setTimeout(resolve, waitInterval));
                    authAttempts++;
                }
                
                if (!window.getCurrentUser) {
                    console.error('‚ùå Auth system failed to initialize after 3 seconds');
                    showError('Authentication system not available. Please refresh the page.');
                    return;
                }
                
                console.log('‚úÖ Auth system ready, checking user session...');
                
                // Now check for user authentication with additional attempts
                let authUser = null;
                let userCheckAttempts = 0;
                
                while (userCheckAttempts < maxAttempts) {
                    authUser = window.getCurrentUser();
                    console.log(`üîç User check attempt ${userCheckAttempts + 1}/${maxAttempts}: user =`, authUser);
                    
                    if (authUser && authUser.id) {
                        console.log(`‚úÖ User authenticated after ${userCheckAttempts + 1} attempts (${(userCheckAttempts + 1) * waitInterval}ms)`);
                        currentUser = authUser;
                        break;
                    }
                    
                    userCheckAttempts++;
                    await new Promise(resolve => setTimeout(resolve, waitInterval));
                }
                
                // Final check after all attempts
                if (!authUser || !authUser.id) {
                    authUser = window.getCurrentUser();
                    console.log('üîç Final auth check after full wait period: user =', authUser);
                    
                    if (authUser && authUser.id) {
                        currentUser = authUser;
                        console.log('‚úÖ User authenticated on final check');
                    } else {
                        console.log('‚ö†Ô∏è No valid user session found after 3 seconds of waiting');
                        console.log('Final authUser value:', authUser);
                        showAuthRequired();
                        return;
                    }
                }

                // Initialize messaging interface now that auth is confirmed
                setupMessageInput();
                setupConversationSearch();
                
                // Load connected users and setup real messaging
                await loadConnectedUsers();
                setupConversationListeners();
                
                // Load first conversation or handle URL params
                if (connectedUsers.length > 0 && !currentConversation) {
                    // Set first connected user as default conversation
                    currentConversation = connectedUsers[0].id;
                    currentRecipient = connectedUsers[0];
                    await loadConversation(currentConversation);
                }
                
                // Check URL parameters for pre-selected recipient
                const urlParams = new URLSearchParams(window.location.search);
                const recipientId = urlParams.get('recipient');
                const recipientName = urlParams.get('name');
                
                if (recipientId && recipientName) {
                    console.log('üìß Opening conversation with:', recipientName);
                    // Small delay to let interface initialize
                    setTimeout(async () => {
                        // Check if user is in connected users
                        const connectedUser = connectedUsers.find(u => u.id === recipientId);
                        if (connectedUser) {
                            // Select this conversation
                            await selectConversation(recipientId);
                        } else {
                            console.warn('User not in connections:', recipientId);
                            showError('You must be connected to message this user');
                        }
                    }, 500);
                }

            } catch (error) {
                console.error('Error initializing messaging page:', error);
                showError('Failed to load messaging interface');
            }
        }

        function showAuthRequired() {
            const messagesContainer = document.querySelector('.messages-container');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 12px; margin: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîê</div>
                        <h3 style="margin-bottom: 1rem; color: #333;">Authentication Required</h3>
                        <p style="color: #666; margin-bottom: 1.5rem;">
                            Private messaging requires you to be logged in to access your conversations.
                        </p>
                        <a href="../auth/dcf_login_page.html" style="display: inline-block; padding: 0.75rem 1.5rem; background: #333; color: white; text-decoration: none; border-radius: 6px;">
                            Log In to Continue
                        </a>
                    </div>
                `;
            }
        }

        // Database functions for real messaging
        async function loadConnectedUsers() {
            try {
                console.log('üìã Loading connected users...');
                
                // Get all accepted connections for current user
                const { data: connections, error } = await supabase
                    .from('connections')
                    .select(`
                        *,
                        requester:user_profiles!connections_requester_id_fkey (
                            id, username, first_name, last_name, avatar_url, role
                        ),
                        recipient:user_profiles!connections_recipient_id_fkey (
                            id, username, first_name, last_name, avatar_url, role
                        )
                    `)
                    .or(`requester_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`)
                    .eq('status', 'accepted');

                if (error) {
                    console.error('Error loading connections:', error);
                    return;
                }

                // Extract connected users
                connectedUsers = [];
                connections.forEach(conn => {
                    const otherUser = conn.requester_id === currentUser.id ? 
                        conn.recipient : conn.requester;
                    
                    if (otherUser) {
                        connectedUsers.push({
                            id: otherUser.id,
                            name: [otherUser.first_name, otherUser.last_name].filter(Boolean).join(' ') || 
                                  otherUser.username || 'User',
                            username: otherUser.username,
                            role: otherUser.role || 'Member',
                            avatar_url: otherUser.avatar_url,
                            avatar: otherUser.first_name ? 
                                (otherUser.first_name.charAt(0) + (otherUser.last_name?.charAt(0) || '')).toUpperCase() :
                                (otherUser.username ? otherUser.username.substring(0, 2).toUpperCase() : 'U')
                        });
                    }
                });

                console.log('‚úÖ Loaded connected users:', connectedUsers.length);
                
                // Update conversation list UI
                updateConversationList();
                
            } catch (error) {
                console.error('Error in loadConnectedUsers:', error);
            }
        }

        async function loadConversation(recipientId) {
            if (!recipientId || !currentUser) return;

            try {
                console.log('üí¨ Loading conversation with:', recipientId);
                
                // Find recipient info
                const recipient = connectedUsers.find(u => u.id === recipientId);
                if (!recipient) {
                    console.error('Recipient not found in connected users');
                    return;
                }

                currentConversation = recipientId;
                currentRecipient = recipient;

                // Update chat header
                document.querySelector('.chat-user-name').textContent = recipient.name;
                document.querySelector('.chat-avatar').textContent = recipient.avatar;
                document.querySelector('.chat-user-status').textContent = 'Active member';

                // Load messages from database
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},recipient_id.eq.${recipientId}),and(sender_id.eq.${recipientId},recipient_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: true });

                if (error) {
                    console.error('Error loading messages:', error);
                    return;
                }

                // Clear and display messages
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';

                if (messages && messages.length > 0) {
                    messages.forEach(msg => {
                        displayMessage(msg);
                    });
                } else {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <p>Start your conversation with ${recipient.name}</p>
                        </div>
                    `;
                }

                // Mark messages as read
                await markMessagesAsRead(recipientId);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Error in loadConversation:', error);
            }
        }

        async function sendRealMessage(content) {
            if (!content || !currentRecipient) return;

            try {
                console.log('üì§ Sending message to:', currentRecipient.name);

                // Insert message into database
                const { data, error } = await supabase
                    .from('messages')
                    .insert({
                        sender_id: currentUser.id || currentUser.user_id,
                        sender_email: currentUser.email,
                        recipient_id: currentRecipient.id,
                        recipient_email: currentRecipient.email || currentRecipient.username,
                        content: content,
                        message_type: 'text',
                        is_read: false,
                        created_at: new Date().toISOString()
                    })
                    .select('*')
                    .single();

                if (error) throw error;

                // Display message immediately
                displayMessage(data);

                // Update conversation preview
                updateConversationPreview(currentRecipient.id, content);

                // Scroll to bottom
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Create notification for recipient (if they're not currently viewing this conversation)
                if (window.notificationSystem) {
                    await window.notificationSystem.createMessageNotification(
                        currentRecipient.id,
                        currentUser.username || currentUser.email,
                        content
                    );
                }

                console.log('‚úÖ Message sent successfully');

            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message. Please try again.');
            }
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            const isSent = message.sender_id === currentUser.id;
            messageElement.className = `message ${isSent ? 'sent' : ''}`;

            const time = new Date(message.created_at);
            const timeString = `${time.toLocaleDateString()} at ${time.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            })}`;

            const senderName = isSent ? 'You' : 
                (currentRecipient ? currentRecipient.name : 
                    message.sender_email ? message.sender_email.split('@')[0] : 'User');

            const avatar = isSent ? '' : 
                (currentRecipient ? currentRecipient.avatar : 
                    (senderName ? senderName.substring(0, 2).toUpperCase() : 'U'));

            messageElement.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-sender">${senderName}</div>
                        <div class="message-time">${timeString}</div>
                    </div>
                    <div class="message-bubble">${message.content}</div>
                </div>
            `;

            messagesContainer.appendChild(messageElement);
        }

        async function markMessagesAsRead(senderId) {
            try {
                // Mark all messages from this sender as read
                const { error } = await supabase
                    .from('messages')
                    .update({ is_read: true })
                    .eq('sender_id', senderId)
                    .eq('recipient_id', currentUser.id)
                    .eq('is_read', false);

                if (error) {
                    console.error('Error marking messages as read:', error);
                }
            } catch (error) {
                console.error('Error in markMessagesAsRead:', error);
            }
        }

        function updateConversationList() {
            const conversationList = document.querySelector('.conversation-list');
            conversationList.innerHTML = '';

            if (connectedUsers.length === 0) {
                conversationList.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #666;">
                        <p>No connections yet</p>
                        <a href="dcf_members_directory.html" style="color: #007bff; text-decoration: none;">
                            Find members to connect with
                        </a>
                    </div>
                `;
                return;
            }

            // Add each connected user as a conversation
            connectedUsers.forEach(user => {
                const conversationItem = document.createElement('div');
                conversationItem.className = 'conversation-item';
                conversationItem.dataset.userId = user.id;
                conversationItem.dataset.conversation = user.id;
                
                conversationItem.innerHTML = `
                    <div class="conversation-avatar">${user.avatar}</div>
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <span class="conversation-name">${user.name}</span>
                            <span class="conversation-time"></span>
                        </div>
                        <div class="conversation-preview">${user.role}</div>
                    </div>
                `;

                conversationItem.addEventListener('click', () => {
                    selectConversation(user.id);
                });

                conversationList.appendChild(conversationItem);
            });

            // Load unread counts for each conversation
            loadUnreadCounts();
        }

        async function loadUnreadCounts() {
            try {
                // Get unread message counts for all conversations
                const { data, error } = await supabase
                    .from('messages')
                    .select('sender_id')
                    .eq('recipient_id', currentUser.id)
                    .eq('is_read', false);

                if (!error && data) {
                    // Count unread per sender
                    const unreadCounts = {};
                    data.forEach(msg => {
                        unreadCounts[msg.sender_id] = (unreadCounts[msg.sender_id] || 0) + 1;
                    });

                    // Update UI with unread badges
                    Object.keys(unreadCounts).forEach(senderId => {
                        const conversationItem = document.querySelector(`[data-user-id="${senderId}"]`);
                        if (conversationItem) {
                            const preview = conversationItem.querySelector('.conversation-preview');
                            if (preview && unreadCounts[senderId] > 0) {
                                preview.innerHTML = `<strong>${unreadCounts[senderId]} unread message${unreadCounts[senderId] > 1 ? 's' : ''}</strong>`;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading unread counts:', error);
            }
        }

        async function selectConversation(userId) {
            // Remove active class from all items
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to selected
            const selectedItem = document.querySelector(`[data-user-id="${userId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }

            // Load the conversation
            await loadConversation(userId);
        }

        function showError(message) {
            const messagesContainer = document.querySelector('.messages-container');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 12px; margin: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <h3 style="margin-bottom: 1rem; color: #333;">Error</h3>
                        <p style="color: #666; margin-bottom: 1.5rem;">${message}</p>
                        <button onclick="location.reload()" style="padding: 0.75rem 1.5rem; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Refresh Page
                        </button>
                    </div>
                `;
            }
        }

        function setupMessageInput() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            messageInput.addEventListener('input', function() {
                // Auto-resize textarea
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                
                // Enable/disable send button
                sendButton.disabled = !this.value.trim();
                
                // Show typing indicator
                if (!isTyping && this.value.trim()) {
                    isTyping = true;
                    // In a real app, this would send typing status to other users
                }
            });

            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function setupConversationSearch() {
            const searchInput = document.getElementById('conversationSearch');
            searchInput.addEventListener('input', function() {
                filterConversations(this.value);
            });
        }

        function setupConversationListeners() {
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', function() {
                    const conversationId = this.dataset.conversation;
                    selectConversation(conversationId);
                });
            });
        }

        function selectConversation_OLD(conversationId) {
            // This is the old demo version - replaced by async selectConversation above
        }

        // Removed old demo loadConversation - using async database version above

        function loadMessages_DEPRECATED(conversationId) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Sample messages based on conversation
            const sampleMessages = {
                'mary-aiken': [
                    { sender: 'mary-aiken', text: 'Hi Sarah! I hope you\'re doing well. I wanted to follow up on our discussion about child safety in AI systems. Have you had a chance to review the research paper I sent?', time: 'Today at 2:15 PM' },
                    { sender: 'self', text: 'Hi Mary! Yes, I\'ve reviewed it thoroughly. The findings about age-appropriate AI interactions are fascinating. I think this could be a cornerstone for our upcoming workshop on ethical AI development.', time: 'Today at 2:18 PM' },
                    { sender: 'mary-aiken', text: 'I\'m so glad you found it valuable! The section on developmental psychology and AI interaction patterns took months to research. Would you be interested in co-presenting this at the workshop?', time: 'Today at 2:20 PM' },
                    { sender: 'self', text: 'Absolutely! I\'d love to co-present with you. We could structure it as a dialogue between cyberpsychology and AI ethics perspectives. What do you think?', time: 'Today at 2:22 PM' },
                    { sender: 'mary-aiken', text: 'That\'s a brilliant approach! The interdisciplinary perspective will be so valuable for our audience. Should we schedule a call this week to outline the presentation structure?', time: 'Today at 2:25 PM' }
                ],
                'michael-torres': [
                    { sender: 'michael-torres', text: 'Good morning, Sarah. I\'ve been working on the theological framework for AI ethics that we discussed. The integration of Catholic Social Teaching principles is coming along well.', time: 'Yesterday at 9:30 AM' },
                    { sender: 'self', text: 'That\'s wonderful, Michael! I\'m eager to see how you\'ve structured the theological foundations. This will be crucial for our institutional guidelines.', time: 'Yesterday at 10:15 AM' },
                    { sender: 'michael-torres', text: 'The document is ready for review. Would you like to schedule a call to discuss the implementation strategy?', time: '1 hour ago' }
                ]
            };

            // Clear existing messages
            messagesContainer.innerHTML = '';

            // Load messages for this conversation
            const messages = sampleMessages[conversationId] || [];
            messages.forEach(message => {
                addMessageToChat(message);
            });

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // DEPRECATED - Using displayMessage for real messages
        function addMessageToChat_DEPRECATED(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.sender === 'self' ? 'sent' : ''}`;
            
            const member = members.find(m => m.id === message.sender);
            const avatar = message.sender === 'self' ? '' : (member ? member.avatar : 'U');
            const senderName = message.sender === 'self' ? 'You' : (member ? member.name : 'Unknown');
            
            messageElement.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-sender">${senderName}</div>
                        <div class="message-time">${message.time}</div>
                    </div>
                    <div class="message-bubble">${message.text}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            if (!currentRecipient) {
                showError('Please select a conversation first');
                return;
            }

            // Clear input immediately for better UX
            messageInput.value = '';
            messageInput.style.height = 'auto';
            document.getElementById('sendButton').disabled = true;
            
            // Send the real message to database
            await sendRealMessage(messageText);
        }

        // DEPRECATED - No more simulated responses
        function simulateResponse_DEPRECATED() {
            const responses = [
                "That's a great point! I hadn't considered that perspective.",
                "Thanks for sharing that insight. It really adds to our discussion.",
                "I agree completely. Let's explore this further in our next meeting.",
                "Excellent idea! I'll incorporate that into our framework.",
                "Thank you for the clarification. This helps me understand better."
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            const now = new Date();
            const timeString = `Today at ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            
            addMessageToChat({
                sender: currentConversation,
                text: randomResponse,
                time: timeString
            });
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function updateConversationPreview(conversationId, messageText) {
            const conversationItem = document.querySelector(`[data-conversation="${conversationId}"]`);
            const preview = conversationItem.querySelector('.conversation-preview');
            const time = conversationItem.querySelector('.conversation-time');
            
            preview.textContent = messageText;
            time.textContent = 'Just now';
            
            // Move conversation to top
            const conversationList = document.getElementById('conversationList');
            conversationList.insertBefore(conversationItem, conversationList.firstChild);
        }

        function filterConversations(searchTerm) {
            const conversations = document.querySelectorAll('.conversation-item');
            conversations.forEach(conversation => {
                const name = conversation.querySelector('.conversation-name').textContent.toLowerCase();
                const preview = conversation.querySelector('.conversation-preview').textContent.toLowerCase();
                const matches = name.includes(searchTerm.toLowerCase()) || preview.includes(searchTerm.toLowerCase());
                conversation.style.display = matches ? 'flex' : 'none';
            });
        }

        // New message functionality
        function openNewMessageModal() {
            document.getElementById('newMessageModal').classList.add('active');
            setupMemberSearch();
        }

        function setupMemberSearch() {
            const searchInput = document.getElementById('recipientSearch');
            const resultsContainer = document.getElementById('memberSearchResults');
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                if (searchTerm.length > 0) {
                    const filteredMembers = members.filter(member => 
                        member.name.toLowerCase().includes(searchTerm) || 
                        member.role.toLowerCase().includes(searchTerm)
                    );
                    
                    if (filteredMembers.length > 0) {
                        resultsContainer.innerHTML = filteredMembers.map(member => `
                            <div class="member-result" onclick="selectRecipient('${member.id}', '${member.name}')">
                                <div class="member-result-avatar">${member.avatar}</div>
                                <div class="member-result-info">
                                    <div class="member-result-name">${member.name}</div>
                                    <div class="member-result-role">${member.role}</div>
                                </div>
                            </div>
                        `).join('');
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.style.display = 'none';
                    }
                } else {
                    resultsContainer.style.display = 'none';
                }
            });
        }

        function selectRecipient(memberId, memberName) {
            document.getElementById('recipientSearch').value = memberName;
            document.getElementById('memberSearchResults').style.display = 'none';
            document.getElementById('recipientSearch').dataset.memberId = memberId;
        }

        // Chat actions
        function startVideoCall() {
            showAlert('Video call functionality would be implemented here', 'info', 'Video Call');
        }

        function startVoiceCall() {
            showAlert('Voice call functionality would be implemented here', 'info', 'Voice Call');
        }

        function openChatInfo() {
            showAlert('Chat information panel would be implemented here', 'info', 'Chat Info');
        }

        function attachFile() {
            showAlert('File attachment functionality would be implemented here', 'info', 'Attach File');
        }

        function addEmoji() {
            showAlert('Emoji picker would be implemented here', 'info', 'Add Emoji');
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Form submissions
        document.getElementById('newMessageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const recipientId = document.getElementById('recipientSearch').dataset.memberId;
            const subject = document.getElementById('messageSubject').value;
            const messageText = document.getElementById('newMessageText').value;
            
            if (!recipientId || !messageText.trim()) {
                showAlert('Please select a recipient and enter a message', 'warning', 'Message Required');
                return;
            }
            
            // Create new conversation or navigate to existing one
            selectConversation(recipientId);
            
            // Send the message
            setTimeout(() => {
                const now = new Date();
                const timeString = `Today at ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                
                addMessageToChat({
                    sender: 'self',
                    text: messageText,
                    time: timeString
                });
                
                updateConversationPreview(recipientId, messageText);
            }, 500);
            
            closeModal('newMessageModal');
            
            // Reset form
            document.getElementById('newMessageForm').reset();
            document.getElementById('memberSearchResults').style.display = 'none';
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
   });

        // User menu functionality now handled by dcf-unified-auth.js
    </script>
</body>
</html>