<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - DCF Hungary</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23dc3545'/></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #333;
            --secondary-color: #666;
            --muted-color: #999;
            --border-color: #e5e5e5;
            --background: #ffffff;
            --background-alt: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--background);
        }

        /* Standard Site Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 50%;
            margin-right: 8px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .nav-menu a:hover {
            color: var(--text-primary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-dropdown {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background-alt);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            transition: var(--transition);
            overflow: hidden;
        }

        .user-avatar:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            z-index: 1000;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Profile Header with Cover Image */
        .profile-header {
            position: relative;
            height: 300px;
            background-size: cover;
            background-position: center;
            background-color: var(--background-alt);
            border-radius: 16px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .profile-header-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 3rem 2rem 2rem;
            display: flex;
            align-items: flex-end;
        }

        .profile-avatar-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 16px;
            background: white;
            border: 4px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            overflow: hidden;
            flex-shrink: 0;
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-initials {
            background: linear-gradient(135deg, var(--background-alt), #e9ecef);
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .profile-header-info {
            flex: 1;
            color: white;
        }

        .profile-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .profile-username {
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0.95;
            margin-bottom: 0.5rem;
        }

        .profile-title-org {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .profile-location {
            font-size: 0.95rem;
            opacity: 0.85;
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: white;
            color: var(--text-primary);
        }

        .btn-primary:hover {
            background: var(--background-alt);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        /* Profile Info Sidebar */
        .profile-sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .profile-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .edit-btn:hover {
            background: var(--background-alt);
            color: var(--text-primary);
        }

        .profile-bio {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .text-muted {
            color: var(--text-muted);
            font-style: italic;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .profile-tag {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--background-alt);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .profile-tag:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .profile-tag-secondary {
            background: white;
            border: 2px solid var(--border-color);
        }

        .profile-website {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.95rem;
            display: block;
            margin-top: 0.5rem;
            transition: var(--transition);
        }

        .profile-website:hover {
            color: var(--text-primary);
            text-decoration: underline;
        }

        .member-since {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
            padding: 1rem 0;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Feed Section */
        .feed-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Post Creator */
        .post-creator {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .post-creator-header {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .post-input {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            transition: var(--transition);
        }

        .post-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(51, 51, 51, 0.1);
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .char-count {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .char-count.warning {
            color: #ff6b6b;
        }

        .btn-post {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-post:hover:not(:disabled) {
            background: #555;
            transform: translateY(-1px);
        }

        .btn-post:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Post Card */
        .post-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: var(--background-alt);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-secondary);
            overflow: hidden;
            flex-shrink: 0;
        }

        .post-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-author-info {
            flex: 1;
        }

        .post-author-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .post-timestamp {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .post-content {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .post-media {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
            max-height: 400px;
            object-fit: cover;
        }

        .post-footer {
            display: flex;
            gap: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            background: none;
            border: none;
            padding: 0;
        }

        .post-action:hover {
            color: var(--text-primary);
        }

        .post-action.liked {
            color: #ff6b6b;
        }

        /* Load More */
        .load-more {
            text-align: center;
            padding: 2rem;
        }

        .btn-load-more {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-load-more:hover {
            background: var(--background-alt);
            transform: translateY(-1px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert-success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .profile-sidebar {
                order: 2;
            }

            .feed-section {
                order: 1;
            }

            .profile-header {
                height: 250px;
            }

            .profile-avatar-large {
                width: 80px;
                height: 80px;
                font-size: 1.8rem;
            }

            .profile-name {
                font-size: 1.5rem;
            }

            .profile-stats {
                grid-template-columns: repeat(3, 1fr);
            }

            .profile-header-overlay {
                padding: 2rem 1rem 1rem;
            }

            .profile-avatar-section {
                flex-direction: column;
                text-align: center;
            }

            .profile-actions {
                justify-content: center;
                width: 100%;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/dcf-unified-auth.js"></script>
</head>
<body>
    <!-- Standard Site Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <div class="logo-icon"></div>
                Domus Communis Foundation
            </a>
            <ul class="nav-menu" id="navMenu">
                <!-- Populated by dcf-unified-auth.js -->
            </ul>
            <div class="user-menu">
                <div class="user-dropdown">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div class="dropdown-menu" id="userDropdown">
                        <!-- Populated by dcf-unified-auth.js -->
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-container">
        <!-- Debug Mode Banner -->
        <div style="background: #ff6b6b; color: white; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align: center; font-weight: 600;">
            🔧 DEBUG MODE: Authentication redirects are disabled for debugging
        </div>
        
        <!-- Alert Messages -->
        <div class="alert alert-error" id="errorAlert"></div>
        <div class="alert alert-success" id="successAlert"></div>

        <!-- Profile Header with Cover Image -->
        <div class="profile-header" id="profileCover">
            <div class="profile-header-overlay">
                <div class="profile-avatar-section">
                    <div class="profile-avatar-large" id="profileAvatar">
                        <div class="avatar-initials">--</div>
                    </div>
                    <div class="profile-header-info">
                        <h1 class="profile-name" id="profileName">Loading...</h1>
                        <div class="profile-username" id="profileUsername">@username</div>
                        <div class="profile-title-org" id="profileTitleOrg"></div>
                        <div class="profile-location" id="profileLocation"></div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-primary" id="editProfileBtn" onclick="editProfile()">Edit Profile</button>
                        <button class="btn btn-secondary" onclick="shareProfile()">Share</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Profile Sidebar -->
            <aside class="profile-sidebar">
                <!-- About Section -->
                <div class="profile-card">
                    <div class="card-title">
                        About
                        <button class="edit-btn" onclick="editSection('bio')">Edit</button>
                    </div>
                    <div class="profile-bio" id="profileBio">
                        <span class="text-muted">No bio provided</span>
                    </div>
                </div>

                <!-- Expertise Section -->
                <div class="profile-card">
                    <div class="card-title">Areas of Expertise</div>
                    <div class="profile-tags" id="expertiseTags">
                        <span class="text-muted">No expertise listed</span>
                    </div>
                </div>

                <!-- Skills Section -->
                <div class="profile-card">
                    <div class="card-title">Skills Offered</div>
                    <div class="profile-tags" id="skillsTags">
                        <span class="text-muted">No skills listed</span>
                    </div>
                </div>

                <!-- Contact Section -->
                <div class="profile-card">
                    <div class="card-title">Contact</div>
                    <a href="#" class="profile-website" id="profileWebsite" style="display: none;" target="_blank"></a>
                    <div class="member-since" id="memberSince">Member since</div>
                </div>

                <!-- Stats Section -->
                <div class="profile-card">
                    <div class="card-title">Activity</div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-value" id="postCount">0</span>
                            <span class="stat-label">Posts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="likeCount">0</span>
                            <span class="stat-label">Likes</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="viewCount">0</span>
                            <span class="stat-label">Views</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Feed Section -->
            <section class="feed-section">
                <!-- Post Creator -->
                <div class="post-creator" id="postCreator">
                    <div class="post-creator-header">Share an update</div>
                    <textarea 
                        class="post-input" 
                        id="postContent" 
                        placeholder="What's on your mind?"
                        maxlength="500"
                    ></textarea>
                    <div class="post-actions">
                        <span class="char-count" id="charCount">0 / 500</span>
                        <button class="btn-post" id="postButton" onclick="createPost()" disabled>Post</button>
                    </div>
                </div>

                <!-- Posts Feed -->
                <div id="feedContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading posts...</p>
                    </div>
                </div>

                <!-- Load More -->
                <div class="load-more" id="loadMoreContainer" style="display: none;">
                    <button class="btn-load-more" onclick="loadMorePosts()">Load More Posts</button>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Debug auth system on script load
        console.log('📄 Profile page script loading at:', new Date().toISOString());
        console.log('🌐 Current URL:', window.location.href);
        console.log('📋 Document ready state:', document.readyState);
        console.log('Initial state - dcfSupabase:', !!window.dcfSupabase);
        console.log('Initial state - getCurrentUser:', !!window.getCurrentUser);
        console.log('Initial state - dcfUser:', window.dcfUser);
        
        // Track when scripts load
        console.log('🔍 Available window properties:');
        console.log('  - supabase (CDN):', !!window.supabase);
        console.log('  - dcfSupabase:', !!window.dcfSupabase);
        console.log('  - initializeDCF:', !!window.initializeDCF);
        
        // Global variables
        let currentProfile = null;
        let currentUserId = null;
        let postsOffset = 0;
        const postsLimit = 20;
        let isLoading = false;
        
        // Real-time auth state monitoring
        setInterval(() => {
            const currentState = {
                dcfSupabase: !!window.dcfSupabase,
                getCurrentUser: !!window.getCurrentUser,
                dcfUser: window.dcfUser?.isLoggedIn || false,
                userEmail: window.dcfUser?.profile?.email || 'none'
            };
            
            if (!window.lastAuthState || JSON.stringify(window.lastAuthState) !== JSON.stringify(currentState)) {
                console.log('🔄 Auth state changed:', currentState);
                window.lastAuthState = currentState;
            }
        }, 1000);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Profile page DOMContentLoaded fired');
            console.log('⏰ Timestamp:', new Date().toISOString());
            console.log('📍 Current auth state at DOM ready:', {
                dcfSupabase: !!window.dcfSupabase,
                getCurrentUser: !!window.getCurrentUser,
                dcfUser: window.dcfUser
            });
            
            // Wait for dcf-unified-auth.js to fully initialize
            console.log('⏳ Starting auth system wait...');
            const authReady = await waitForAuthSystemReady();
            
            if (!authReady) {
                console.error('❌ Auth system failed to initialize, showing debug info');
                showDebugAuthInfo();
                return;
            }
            
            // Setup event listeners first
            console.log('⚙️ Setting up event listeners...');
            setupEventListeners();
            
            // Initialize profile after auth is ready
            console.log('👤 Starting profile initialization...');
            await initializeProfilePage();
        });

        // Wait for auth system to be ready
        async function waitForAuthSystemReady() {
            console.log('🔄 Waiting for auth system to initialize...');
            
            let attempts = 0;
            const maxAttempts = 20; // 10 seconds max wait
            
            while (attempts < maxAttempts) {
                // Check if Supabase client is ready
                if (window.dcfSupabase && window.getCurrentUser && window.dcfUser) {
                    console.log('✅ Auth system ready');
                    console.log('dcfUser state:', window.dcfUser);
                    return true;
                }
                
                console.log(`⏳ Auth system not ready, attempt ${attempts + 1}/${maxAttempts}`);
                console.log('Current state:', {
                    dcfSupabase: !!window.dcfSupabase,
                    getCurrentUser: !!window.getCurrentUser,
                    dcfUser: window.dcfUser
                });
                
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
            }
            
            console.error('❌ Auth system failed to initialize within timeout');
            showError('Authentication system failed to load. Please refresh the page.');
            return false;
        }

        // Initialize profile page
        async function initializeProfilePage() {
            try {
                console.log('🔍 Checking authentication status...');
                console.log('dcfSupabase available:', !!window.dcfSupabase);
                console.log('getCurrentUser available:', !!window.getCurrentUser);
                console.log('dcfUser state:', window.dcfUser);
                
                // Wait for user to be properly authenticated
                let currentUser = null;
                let attempts = 0;
                const maxAuthAttempts = 10;
                
                while (attempts < maxAuthAttempts) {
                    currentUser = window.getCurrentUser();
                    console.log(`Auth attempt ${attempts + 1}: currentUser =`, currentUser);
                    
                    if (currentUser?.id) {
                        console.log('✅ User found:', currentUser);
                        break;
                    }
                    
                    // Check if user is actually logged out
                    if (window.dcfUser && window.dcfUser.isLoggedIn === false) {
                        console.error('🚨 WOULD REDIRECT: User is definitively logged out');
                        // window.location.href = '../auth/dcf_login_page.html';
                        // return;
                    }
                    
                    console.log(`⏳ User not ready, waiting... (attempt ${attempts + 1}/${maxAuthAttempts})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (!currentUser?.id) {
                    console.error('🚨 WOULD REDIRECT: No authenticated user found after retries');
                    showError('DEBUG MODE: Authentication required but redirects disabled');
                    // setTimeout(() => {
                    //     window.location.href = '../auth/dcf_login_page.html';
                    // }, 2000);
                    // return;
                    
                    // Show debug info instead of redirecting
                    showDebugAuthInfo();
                    return;
                }

                currentUserId = currentUser.id;
                console.log('✅ Loading profile for user:', currentUserId, currentUser.email);

                // Load profile data using email since that's how the auth system works
                const { data: profile, error } = await window.dcfSupabase
                    .from('user_profiles')
                    .select('id, username, first_name, last_name, title, organization, location, bio, expertise, skills_offered, website, avatar_url, cover_image_url, role, created_at')
                    .eq('email', currentUser.email)
                    .single();

                if (error || !profile) {
                    console.error('Profile load error:', error);
                    showError('Unable to load profile. Please try again.');
                    return;
                }

                console.log('✅ Profile loaded from database:', profile);
                currentProfile = profile;
                
                // Use the database profile ID for all subsequent queries
                currentUserId = profile.id;

                // Populate profile
                populateProfileHeader(profile);
                populateProfileInfo(profile);

                // Load user's posts using database profile ID
                await loadUserPosts(currentUserId);

                // Load statistics
                await loadProfileStats(currentUserId);

            } catch (error) {
                console.error('Error initializing profile:', error);
                showError('An error occurred while loading your profile.');
            }
        }

        // Populate profile header with data
        function populateProfileHeader(profile) {
            // Cover image
            const coverElement = document.getElementById('profileCover');
            if (profile.cover_image_url) {
                coverElement.style.backgroundImage = `url(${profile.cover_image_url})`;
            } else {
                // Default gradient if no cover image
                coverElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }

            // Avatar
            const avatarElement = document.getElementById('profileAvatar');
            if (profile.avatar_url) {
                avatarElement.innerHTML = `<img src="${profile.avatar_url}" alt="Profile">`;
            } else {
                const fullName = `${profile.first_name || ''} ${profile.last_name || ''}`.trim();
                const initials = window.generateInitials ? 
                    window.generateInitials(fullName) : 
                    fullName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                avatarElement.innerHTML = `<div class="avatar-initials">${initials || 'U'}</div>`;
            }

            // Name and username
            const fullName = `${profile.first_name || ''} ${profile.last_name || ''}`.trim();
            document.getElementById('profileName').textContent = fullName || 'Anonymous User';
            document.getElementById('profileUsername').textContent = `@${profile.username || 'user'}`;

            // Title and organization
            const titleOrgText = [];
            if (profile.title) titleOrgText.push(profile.title);
            if (profile.organization) {
                titleOrgText.push(profile.title ? `at ${profile.organization}` : profile.organization);
            }
            const titleOrgElement = document.getElementById('profileTitleOrg');
            if (titleOrgText.length > 0) {
                titleOrgElement.textContent = titleOrgText.join(' ');
                titleOrgElement.style.display = 'block';
            } else {
                titleOrgElement.style.display = 'none';
            }

            // Location
            const locationElement = document.getElementById('profileLocation');
            if (profile.location) {
                locationElement.textContent = `📍 ${profile.location}`;
                locationElement.style.display = 'block';
            } else {
                locationElement.style.display = 'none';
            }
        }

        // Populate profile information sidebar
        function populateProfileInfo(profile) {
            // Bio section
            const bioElement = document.getElementById('profileBio');
            if (profile.bio && profile.bio.trim()) {
                bioElement.textContent = profile.bio;
            } else {
                bioElement.innerHTML = '<span class="text-muted">No bio provided</span>';
            }

            // Expertise tags
            const expertiseContainer = document.getElementById('expertiseTags');
            expertiseContainer.innerHTML = '';
            if (profile.expertise && profile.expertise.trim()) {
                const expertiseItems = profile.expertise.split(',').map(item => item.trim()).filter(item => item);
                if (expertiseItems.length > 0) {
                    expertiseItems.forEach(item => {
                        const tag = document.createElement('span');
                        tag.className = 'profile-tag';
                        tag.textContent = item;
                        expertiseContainer.appendChild(tag);
                    });
                } else {
                    expertiseContainer.innerHTML = '<span class="text-muted">No expertise listed</span>';
                }
            } else {
                expertiseContainer.innerHTML = '<span class="text-muted">No expertise listed</span>';
            }

            // Skills offered tags
            const skillsContainer = document.getElementById('skillsTags');
            skillsContainer.innerHTML = '';
            if (profile.skills_offered && profile.skills_offered.trim()) {
                const skillItems = profile.skills_offered.split(',').map(item => item.trim()).filter(item => item);
                if (skillItems.length > 0) {
                    skillItems.forEach(item => {
                        const tag = document.createElement('span');
                        tag.className = 'profile-tag profile-tag-secondary';
                        tag.textContent = item;
                        skillsContainer.appendChild(tag);
                    });
                } else {
                    skillsContainer.innerHTML = '<span class="text-muted">No skills listed</span>';
                }
            } else {
                skillsContainer.innerHTML = '<span class="text-muted">No skills listed</span>';
            }

            // Website
            const websiteElement = document.getElementById('profileWebsite');
            if (profile.website && profile.website.trim()) {
                let websiteUrl = profile.website;
                if (!websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                    websiteUrl = 'https://' + websiteUrl;
                }
                websiteElement.href = websiteUrl;
                websiteElement.textContent = profile.website.replace(/^https?:\/\//, '');
                websiteElement.style.display = 'block';
            } else {
                websiteElement.style.display = 'none';
            }

            // Member since
            if (profile.created_at) {
                const joinDate = new Date(profile.created_at);
                document.getElementById('memberSince').textContent = 
                    `Member since ${joinDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            }
        }

        // Load user's posts
        async function loadUserPosts(userId, append = false) {
            if (isLoading) return;
            isLoading = true;

            try {
                const { data: posts, error } = await window.dcfSupabase
                    .from('posts')
                    .select('id, author_id, content, media_url, media_type, created_at, like_count, comment_count, view_count, status')
                    .eq('author_id', userId)
                    .eq('status', 'published')
                    .order('created_at', { ascending: false })
                    .range(postsOffset, postsOffset + postsLimit - 1);

                if (error) {
                    console.error('Error loading posts:', error);
                    showError('Unable to load posts');
                    return;
                }

                const feedContainer = document.getElementById('feedContainer');
                
                if (!append) {
                    feedContainer.innerHTML = '';
                }

                if (posts && posts.length > 0) {
                    posts.forEach(post => appendPostToFeed(post, append));
                    
                    // Show load more button if we got full page of results
                    if (posts.length === postsLimit) {
                        document.getElementById('loadMoreContainer').style.display = 'block';
                    } else {
                        document.getElementById('loadMoreContainer').style.display = 'none';
                    }
                    
                    postsOffset += posts.length;
                } else if (!append) {
                    // No posts at all
                    feedContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📝</div>
                            <h3>No posts yet</h3>
                            <p>Share your first update with the community!</p>
                        </div>
                    `;
                    document.getElementById('loadMoreContainer').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading posts:', error);
                showError('An error occurred while loading posts');
            } finally {
                isLoading = false;
            }
        }

        // Append post to feed
        function appendPostToFeed(post, append = false) {
            const feedContainer = document.getElementById('feedContainer');
            
            // Create post card
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.dataset.postId = post.id;

            // Format timestamp
            const timestamp = formatTimestamp(post.created_at);

            // Get author info from current profile
            const authorName = `${currentProfile.first_name || ''} ${currentProfile.last_name || ''}`.trim() || 'Anonymous';
            const authorUsername = currentProfile.username || 'user';
            
            // Build avatar HTML
            let avatarHtml = '';
            if (currentProfile.avatar_url) {
                avatarHtml = `<img src="${currentProfile.avatar_url}" alt="${authorName}">`;
            } else {
                const initials = window.generateInitials ? 
                    window.generateInitials(authorName) : 
                    authorName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                avatarHtml = `<div class="avatar-initials">${initials || 'U'}</div>`;
            }

            // Build media HTML if exists
            let mediaHtml = '';
            if (post.media_url) {
                if (post.media_type && post.media_type.startsWith('image')) {
                    mediaHtml = `<img src="${post.media_url}" alt="Post image" class="post-media">`;
                }
            }

            postCard.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">${avatarHtml}</div>
                    <div class="post-author-info">
                        <div class="post-author-name">${authorName}</div>
                        <div class="post-timestamp">${timestamp}</div>
                    </div>
                </div>
                <div class="post-content">${escapeHtml(post.content)}</div>
                ${mediaHtml}
                <div class="post-footer">
                    <button class="post-action" onclick="toggleLike('${post.id}')">
                        <span>👍</span>
                        <span>${post.like_count || 0}</span>
                    </button>
                    <button class="post-action">
                        <span>💬</span>
                        <span>${post.comment_count || 0}</span>
                    </button>
                    <button class="post-action">
                        <span>👁️</span>
                        <span>${post.view_count || 0}</span>
                    </button>
                </div>
            `;

            if (append) {
                feedContainer.appendChild(postCard);
            } else {
                // Insert at the beginning for new posts
                feedContainer.insertBefore(postCard, feedContainer.firstChild);
            }
        }

        // Load profile statistics
        async function loadProfileStats(userId) {
            try {
                // Get post count
                const { count: postCount } = await window.dcfSupabase
                    .from('posts')
                    .select('*', { count: 'exact', head: true })
                    .eq('author_id', userId)
                    .eq('status', 'published');

                document.getElementById('postCount').textContent = postCount || 0;

                // Get total engagement stats
                const { data: stats } = await window.dcfSupabase
                    .from('posts')
                    .select('like_count, view_count')
                    .eq('author_id', userId);

                if (stats) {
                    const totalLikes = stats.reduce((sum, post) => sum + (post.like_count || 0), 0);
                    const totalViews = stats.reduce((sum, post) => sum + (post.view_count || 0), 0);
                    
                    document.getElementById('likeCount').textContent = totalLikes;
                    document.getElementById('viewCount').textContent = formatNumber(totalViews);
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Create new post
        async function createPost() {
            const content = document.getElementById('postContent').value.trim();
            if (!content || !currentUserId) return;

            const postButton = document.getElementById('postButton');
            postButton.disabled = true;
            postButton.textContent = 'Posting...';

            try {
                const { data, error } = await window.dcfSupabase
                    .from('posts')
                    .insert({
                        author_id: currentUserId,
                        content: content,
                        status: 'published',
                        created_at: new Date().toISOString(),
                        like_count: 0,
                        comment_count: 0,
                        view_count: 0
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('Error creating post:', error);
                    showError('Unable to create post. Please try again.');
                    return;
                }

                // Clear input
                document.getElementById('postContent').value = '';
                updateCharCount();

                // Add post to feed
                const feedContainer = document.getElementById('feedContainer');
                
                // Remove empty state if it exists
                const emptyState = feedContainer.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                // Add new post to top of feed
                appendPostToFeed(data, false);

                // Update post count
                const postCountElement = document.getElementById('postCount');
                const currentCount = parseInt(postCountElement.textContent) || 0;
                postCountElement.textContent = currentCount + 1;

                showSuccess('Post created successfully!');

            } catch (error) {
                console.error('Error creating post:', error);
                showError('An error occurred while creating your post.');
            } finally {
                postButton.disabled = false;
                postButton.textContent = 'Post';
            }
        }

        // Toggle like on post
        async function toggleLike(postId) {
            // For now, just increment the UI count
            // Full implementation would check if user already liked and toggle accordingly
            const postCard = document.querySelector(`[data-post-id="${postId}"]`);
            if (!postCard) return;

            const likeButton = postCard.querySelector('.post-action');
            const likeCount = likeButton.querySelector('span:last-child');
            const currentCount = parseInt(likeCount.textContent) || 0;
            
            // Toggle liked state
            if (likeButton.classList.contains('liked')) {
                likeButton.classList.remove('liked');
                likeCount.textContent = Math.max(0, currentCount - 1);
            } else {
                likeButton.classList.add('liked');
                likeCount.textContent = currentCount + 1;
            }
        }

        // Load more posts
        function loadMorePosts() {
            if (currentUserId) {
                loadUserPosts(currentUserId, true);
            }
        }

        // Edit profile (placeholder)
        function editProfile() {
            showSuccess('Edit profile functionality coming soon!');
        }

        // Edit section (placeholder)
        function editSection(section) {
            showSuccess(`Edit ${section} functionality coming soon!`);
        }

        // Share profile
        function shareProfile() {
            const profileUrl = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: `${currentProfile?.first_name} ${currentProfile?.last_name} - DCF Profile`,
                    text: 'Check out this profile on DCF Hungary',
                    url: profileUrl
                });
            } else {
                // Fallback to clipboard
                navigator.clipboard.writeText(profileUrl);
                showSuccess('Profile link copied to clipboard!');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Character counter for post input
            const postInput = document.getElementById('postContent');
            postInput.addEventListener('input', updateCharCount);
        }

        // Update character count
        function updateCharCount() {
            const postInput = document.getElementById('postContent');
            const charCount = document.getElementById('charCount');
            const postButton = document.getElementById('postButton');
            
            const length = postInput.value.length;
            charCount.textContent = `${length} / 500`;
            
            if (length > 450) {
                charCount.classList.add('warning');
            } else {
                charCount.classList.remove('warning');
            }
            
            // Enable/disable post button
            postButton.disabled = length === 0 || length > 500;
        }

        // Utility Functions
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 7) {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else if (days > 0) {
                return `${days}d ago`;
            } else if (hours > 0) {
                return `${hours}h ago`;
            } else if (minutes > 0) {
                return `${minutes}m ago`;
            } else {
                return 'Just now';
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        // Debug function to show auth state
        function showDebugAuthInfo() {
            console.log('🔍 FULL DEBUG AUTH STATE:');
            console.log('window.dcfSupabase:', window.dcfSupabase);
            console.log('window.getCurrentUser:', window.getCurrentUser);
            console.log('window.dcfUser:', window.dcfUser);
            console.log('window.isUserLoggedIn():', window.isUserLoggedIn ? window.isUserLoggedIn() : 'function not available');
            
            // Show debug info on page
            const debugPanel = document.createElement('div');
            debugPanel.style.cssText = `
                position: fixed;
                top: 100px;
                left: 20px;
                right: 20px;
                background: #fff;
                border: 3px solid #ff0000;
                padding: 20px;
                z-index: 10000;
                font-family: monospace;
                font-size: 12px;
                max-height: 60vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            debugPanel.innerHTML = `
                <h3 style="color: #ff0000; margin-top: 0;">🔍 DEBUG: Authentication State</h3>
                <div><strong>dcfSupabase available:</strong> ${!!window.dcfSupabase}</div>
                <div><strong>getCurrentUser available:</strong> ${!!window.getCurrentUser}</div>
                <div><strong>dcfUser state:</strong> ${JSON.stringify(window.dcfUser, null, 2)}</div>
                <div><strong>Current URL:</strong> ${window.location.href}</div>
                <div><strong>Script path:</strong> ../js/dcf-unified-auth.js</div>
                <hr>
                <div style="color: #ff0000;"><strong>WOULD REDIRECT TO:</strong> ../auth/dcf_login_page.html</div>
                <hr>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px;">Close Debug Panel</button>
                <button onclick="location.reload()" style="margin-top: 10px; margin-left: 10px;">Reload Page</button>
                <button onclick="window.location.href='../auth/dcf_login_page.html'" style="margin-top: 10px; margin-left: 10px;">Go to Login</button>
            `;
            
            document.body.appendChild(debugPanel);
        }
    </script>
</body>
</html>