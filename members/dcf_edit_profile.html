<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - DCF Hungary</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: #333;
            border-radius: 50%;
            margin-right: 8px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            text-decoration: none;
            color: #666;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-menu a:hover {
            color: #333;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #666;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow: hidden;
        }

        .user-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e5e5;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #000, #333);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .dropdown-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-email {
            color: #666;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-nav {
            padding: 0.5rem;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #000;
        }

        .logout-btn {
            color: #dc3545 !important;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #fee !important;
        }

        .dropdown-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #f0f0f0;
        }

        .signout-button {
            width: 100%;
            padding: 0.75rem;
            background: #000;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .signout-button:hover {
            background: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .edit-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        /* Sidebar Navigation */
        .edit-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .sidebar-nav {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            text-decoration: none;
            margin-bottom: 0.25rem;
        }
        
        .sidebar-nav-item > span[data-icon] {
            display: inline-flex;
            align-items: center;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .sidebar-nav-item:hover {
            background: #f8f9fa;
            color: #333;
        }

        .sidebar-nav-item.active {
            background: #000;
            color: white;
        }

        /* Edit Content */
        .edit-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .edit-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e5e5;
        }

        .section-description {
            color: #666;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.9rem;
        }

        .form-help {
            font-size: 0.8rem;
            color: #999;
            margin-top: 0.25rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #333;
            background: #fafafa;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Image Upload Areas */
        .image-upload-area {
            border: 2px dashed #e5e5e5;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .image-upload-area:hover {
            border-color: #333;
            background: #fafafa;
        }

        .image-upload-area.has-image {
            border-style: solid;
            padding: 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .upload-text {
            color: #666;
            margin-bottom: 0.5rem;
        }

        .upload-button {
            background: #000;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            background: #333;
            transform: translateY(-2px);
        }

        /* Avatar Upload Special */
        .avatar-upload-container {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #999;
            overflow: hidden;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-actions {
            flex: 1;
        }

        /* Cover Position Controls */
        .cover-position-controls {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .position-slider {
            width: 100%;
            margin: 1rem 0;
        }

        .position-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .cover-preview-container {
            margin: 1rem 0;
            text-align: center;
        }

        .cover-preview-box {
            width: 100%;
            max-width: 500px;
            /* Aspect ratio matching profile hero: approximately 3.4:1 */
            aspect-ratio: 3.4 / 1;
            margin: 0 auto;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cover-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center 50%;
            transition: object-position 0.2s ease;
        }

        .preview-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Tags Input */
        .tags-input-container {
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            padding: 0.5rem;
            min-height: 50px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            cursor: text;
        }

        .tags-input-container:focus-within {
            border-color: #333;
            background: #fafafa;
        }

        .tag-item {
            background: #e9ecef;
            color: #333;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            color: #999;
            transition: color 0.3s ease;
        }

        .tag-remove:hover {
            color: #ff4444;
        }

        .tags-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 150px;
            padding: 0.25rem;
            font-size: 0.9rem;
            background: transparent;
        }

        /* Privacy Settings */
        .privacy-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .privacy-option:hover {
            border-color: #333;
            background: #fafafa;
        }

        .privacy-option.selected {
            border-color: #000;
            background: #f0f0f0;
        }

        .privacy-radio {
            margin-right: 1rem;
        }

        .privacy-info {
            flex: 1;
        }

        .privacy-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .privacy-description {
            font-size: 0.9rem;
            color: #666;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: #000;
            color: white;
        }

        .btn-primary:hover {
            background: #333;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e9ecef;
            color: #333;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            padding-top: 2rem;
            border-top: 1px solid #e5e5e5;
            margin-top: 2rem;
        }

        .form-actions-right {
            display: flex;
            gap: 1rem;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .notification.success {
            border-left: 4px solid #28a745;
        }

        .notification.error {
            border-left: 4px solid #ef9a9a; /* Soft red instead of bright red */
        }
        
        /* Character counter styles */
        .char-counter {
            text-align: left;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            font-weight: normal;
            color: #6b7280;
        }

        .char-counter.valid {
            color: #6b7280; /* Neutral gray when valid */
        }

        .char-counter.warning {
            color: #ffa726; /* Soft orange when at limit */
        }

        .char-counter.invalid {
            color: #ef9a9a; /* Soft red when below minimum */
        }

        /* Validation message styles */
        .validation-message {
            font-size: 0.85rem;
            margin-top: 0.25rem;
            color: #ef9a9a; /* Soft red for errors */
            font-weight: normal;
        }

        /* Field error styles */
        .field-error {
            font-size: 0.85rem;
            margin-top: 0.25rem;
            color: #ef9a9a; /* Soft red */
        }

        /* Remove aggressive input error styling */
        .form-input.error,
        .form-textarea.error,
        .form-select.error {
            border-color: #ef9a9a; /* Soft red instead of bright red */
        }

        .form-input:focus.error,
        .form-textarea:focus.error,
        .form-select:focus.error {
            border-color: #ef9a9a; /* Keep soft red on focus */
        }

        .notification.info {
            border-left: 4px solid #007bff;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .edit-grid {
                grid-template-columns: 1fr;
            }
            
            .edit-sidebar {
                position: static;
            }
            
            .sidebar-nav {
                margin-bottom: 2rem;
            }
            
            .avatar-upload-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <div class="logo-icon"></div>
                Domus Communis Foundation
            </a>
            <ul class="nav-menu" id="navMenu">
                <!-- Navigation populated by dcf-ui.js -->
            </ul>
            <div class="user-menu">
                <div class="user-dropdown">
                    <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar"></div>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-header">
                            <div class="dropdown-avatar"></div>
                            <div class="dropdown-info">
                                <div class="dropdown-name" id="dropdownUserName"></div>
                                <div class="dropdown-email" id="dropdownUserEmail"></div>
                            </div>
                        </div>
                        <div class="dropdown-nav" id="dropdownNav">
                            <!-- Navigation items populated by dcf-ui.js -->
                        </div>
                        <div class="dropdown-footer">
                            <button class="signout-button" onclick="signOut()">Sign Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Edit Profile</h1>
            <p class="page-subtitle">Update your profile information and manage your account settings</p>
        </div>

        <!-- Edit Grid Layout -->
        <div class="edit-grid">
            <!-- Sidebar Navigation -->
            <aside class="edit-sidebar">
                <nav class="sidebar-nav">
                    <a href="#basic-info" class="sidebar-nav-item active">
                        <span data-icon="user" data-size="small"></span> Basic Information
                    </a>
                    <a href="#profile-media" class="sidebar-nav-item">
                        <span data-icon="image" data-size="small"></span> Photos & Cover
                    </a>
                    <a href="#professional" class="sidebar-nav-item">
                        <span data-icon="briefcase" data-size="small"></span> Professional Details
                    </a>
                    <a href="#skills-interests" class="sidebar-nav-item">
                        <span data-icon="star" data-size="small"></span> Skills & Interests
                    </a>
                    <a href="#contact" class="sidebar-nav-item">
                        <span data-icon="mail" data-size="small"></span> Contact Information
                    </a>
                    <a href="#privacy" class="sidebar-nav-item">
                        <span data-icon="shield" data-size="small"></span> Privacy Settings
                    </a>
                    <a href="#entity-accounts" class="sidebar-nav-item">
                        <span data-icon="building" data-size="small"></span> Entity Accounts
                    </a>
                </nav>
            </aside>

            <!-- Edit Content -->
            <main class="edit-content">
                <!-- Basic Information Section -->
                <section id="basic-info" class="edit-section">
                    <h2 class="section-title">Basic Information</h2>
                    <p class="section-description">This information will be displayed on your public profile</p>
                    
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-input" id="firstName" placeholder="Enter your first name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-input" id="lastName" placeholder="Enter your last name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="username" placeholder="@username">
                        <p class="form-help">This is your unique identifier on the platform</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bio / About</label>
                        <textarea class="form-textarea" id="bio" placeholder="Tell the world about yourself..." maxlength="500"></textarea>
                        <div id="bioCount" class="char-counter">0/500 characters</div>
                        <p class="form-help">Write a brief description about yourself</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="location" placeholder="Budapest, Hungary">
                    </div>
                    <div class="section-save-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveSection('basic-info')">Save Changes</button>
                    </div>
                </section>

                <!-- Profile Media Section -->
                <section id="profile-media" class="edit-section">
                    <h2 class="section-title">Profile Photos & Cover</h2>
                    <p class="section-description">Customize your profile appearance with photos</p>
                    
                    <!-- Avatar Upload -->
                    <div class="form-group">
                        <label class="form-label">Profile Picture</label>
                        <div class="avatar-upload-container">
                            <div class="avatar-preview" id="avatarPreview">
                                <span data-icon="user" data-size="standard"></span>
                            </div>
                            <div class="avatar-upload-actions">
                                <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('avatarInput').click()">
                                    Choose Photo
                                </button>
                                <button class="btn btn-secondary" onclick="removeAvatar()">
                                    Remove
                                </button>
                                <p class="form-help">Recommended: Square image, at least 400x400px</p>
                            </div>
                        </div>
                    </div>

                    <!-- Cover Image Upload -->
                    <div class="form-group">
                        <label class="form-label">Cover Photo</label>
                        <div class="image-upload-area" id="coverUploadArea" onclick="document.getElementById('coverInput').click()">
                            <div class="upload-icon">🖼️</div>
                            <p class="upload-text">Click to upload cover photo</p>
                            <p class="form-help">Recommended: 1920x480px or 4:1 aspect ratio</p>
                        </div>
                        <input type="file" id="coverInput" accept="image/*" style="display: none;">
                        
                        <!-- Enhanced Cover Position Controls -->
                        <div class="cover-position-controls" id="coverPositionControls" style="display: none;">
                            <p class="position-label">Preview how your cover photo will appear:</p>
                            
                            <!-- Live Preview Box -->
                            <div class="cover-preview-container">
                                <div class="cover-preview-box" id="coverPreviewBox">
                                    <img id="coverPreviewImage" alt="Cover preview">
                                </div>
                                <div class="preview-label">Scaled preview - actual size: full width × 350px on your profile</div>
                            </div>
                            
                            <p class="position-label">Adjust vertical position:</p>
                            <input type="range" class="position-slider" id="coverPositionSlider" min="0" max="100" value="50">
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #999; margin-top: 0.5rem;">
                                <span>Top</span>
                                <span>Center</span>
                                <span>Bottom</span>
                            </div>
                            
                            <!-- ADD SAVE BUTTON -->
                            <div style="margin-top: 1rem; text-align: center;">
                                <button type="button" class="btn btn-primary btn-small" onclick="saveCoverPosition()">
                                    Save Position
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="section-save-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveSection('profile-media')">Save Changes</button>
                    </div>
                </section>

                <!-- Professional Details Section -->
                <section id="professional" class="edit-section">
                    <h2 class="section-title">Professional Details</h2>
                    <p class="section-description">Share your professional background and expertise</p>
                    
                    <div class="form-group">
                        <label class="form-label">Job Title / Role</label>
                        <input type="text" class="form-input" id="role" placeholder="e.g., Software Engineer, Product Manager">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Organization</label>
                        <input type="text" class="form-input" id="organization" placeholder="Company or organization name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select class="form-select" id="industry">
                            <option value="">Select your industry</option>
                            <option value="technology">Technology</option>
                            <option value="finance">Finance</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="education">Education</option>
                            <option value="media">Media & Entertainment</option>
                            <option value="nonprofit">Non-profit</option>
                            <option value="government">Government</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Years of Experience</label>
                        <select class="form-select" id="experience">
                            <option value="">Select experience level</option>
                            <option value="0-2">0-2 years</option>
                            <option value="3-5">3-5 years</option>
                            <option value="6-10">6-10 years</option>
                            <option value="11-15">11-15 years</option>
                            <option value="16+">16+ years</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Professional Summary</label>
                        <textarea class="form-textarea" id="professionalSummary" placeholder="Describe your professional background, achievements, and goals..."></textarea>
                    </div>
                    <div class="section-save-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveSection('professional')">Save Changes</button>
                    </div>
                </section>

                <!-- Skills & Interests Section -->
                <section id="skills-interests" class="edit-section">
                    <h2 class="section-title">Skills & Interests</h2>
                    <p class="section-description">Help others understand your expertise and passions</p>
                    
                    <div class="form-group">
                        <label class="form-label">Skills</label>
                        <div class="tags-input-container" id="skillsContainer">
                            <input type="text" class="tags-input" id="skillsInput" placeholder="Type a skill and press Enter">
                        </div>
                        <p class="form-help">Add your professional skills (e.g., JavaScript, Project Management, Data Analysis)</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Interests</label>
                        <div class="tags-input-container" id="interestsContainer">
                            <input type="text" class="tags-input" id="interestsInput" placeholder="Type an interest and press Enter">
                        </div>
                        <p class="form-help">Share your interests and hobbies (e.g., AI Ethics, Climate Tech, Photography)</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Focus Areas</label>
                        <div class="tags-input-container" id="focusContainer">
                            <input type="text" class="tags-input" id="focusInput" placeholder="Type a focus area and press Enter">
                        </div>
                        <p class="form-help">Areas you want to focus on or learn more about</p>
                    </div>
                    <div class="section-save-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveSection('skills-interests')">Save Changes</button>
                    </div>
                </section>

                <!-- Contact Information Section -->
                <section id="contact" class="edit-section">
                    <h2 class="section-title">Contact Information</h2>
                    <p class="section-description">Control how people can reach you</p>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="email" placeholder="your.email@example.com">
                        <p class="form-help">This email will be used for notifications</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="phone" placeholder="+36 20 123 4567">
                        <p class="form-help">Optional: Only visible to connections</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Website / Portfolio</label>
                        <input type="url" class="form-input" id="website" placeholder="https://yourwebsite.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">LinkedIn Profile</label>
                        <input type="url" class="form-input" id="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Twitter/X Handle</label>
                        <input type="text" class="form-input" id="twitter" placeholder="@yourhandle">
                    </div>
                    <div class="section-save-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveSection('contact')">Save Changes</button>
                    </div>
                </section>

                <!-- Privacy Settings Section -->
                <section id="privacy" class="edit-section">
                    <h2 class="section-title">Privacy Settings</h2>
                    <p class="section-description">Control who can see your profile information</p>
                    
                    <div class="form-group">
                        <label class="form-label">Profile Visibility</label>
                        
                        <div class="privacy-option" onclick="selectPrivacy('public')">
                            <input type="radio" class="privacy-radio" name="visibility" value="public" id="visibilityPublic">
                            <div class="privacy-info">
                                <div class="privacy-title">Public</div>
                                <div class="privacy-description">Anyone can view your full profile</div>
                            </div>
                        </div>

                        <div class="privacy-option" onclick="selectPrivacy('connections')">
                            <input type="radio" class="privacy-radio" name="visibility" value="connections" id="visibilityConnections" checked>
                            <div class="privacy-info">
                                <div class="privacy-title">Connections Only</div>
                                <div class="privacy-description">Only your connections can see full profile details</div>
                            </div>
                        </div>

                        <div class="privacy-option" onclick="selectPrivacy('private')">
                            <input type="radio" class="privacy-radio" name="visibility" value="private" id="visibilityPrivate">
                            <div class="privacy-info">
                                <div class="privacy-title">Private</div>
                                <div class="privacy-description">Only you can see your profile</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Contact Preferences</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="allowMessages">
                                <span>Allow messages from connections</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="allowConnectionRequests" checked>
                                <span>Allow connection requests</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="showEmail">
                                <span>Show email to connections</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="showPhone">
                                <span>Show phone to connections</span>
                            </label>
                        </div>
                    </div>
                    <div class="section-save-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveSection('privacy')">Save Changes</button>
                    </div>
                </section>

                <!-- Entity Account Management Section -->
                <section id="entity-accounts" class="edit-section">
                    <h2 class="section-title">Entity Account Management</h2>
                    <p class="section-description">Create and manage entity accounts for organizations, foundations, or institutions</p>
                    
                    <!-- Container for existing entities -->
                    <div id="existingEntities" style="margin-bottom: 2rem;"></div>
                    
                    <!-- Create Entity Button (Initially shown) -->
                    <div id="createEntityButton">
                        <button type="button" class="btn btn-primary" onclick="showEntityCreationForm()">
                            + Create Entity Account
                        </button>
                    </div>
                    
                    <!-- Entity Creation Form (Initially hidden) -->
                    <div id="entityCreationForm" style="display: none;">
                        <div style="border: 2px dashed #e5e5e5; border-radius: 12px; padding: 2rem; margin-top: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Entity Name</label>
                                <input type="text" class="form-input" id="entityName" placeholder="e.g., Domus Communis Foundation">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Entity Username</label>
                                <input type="text" class="form-input" id="entityUsername" placeholder="@dcfoundation">
                                <p class="form-help">Unique identifier for the entity account</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Entity Type</label>
                                <select class="form-select" id="entityType">
                                    <option value="">Select entity type</option>
                                    <option value="non-profit">Non-profit</option>
                                    <option value="foundation">Foundation</option>
                                    <option value="corporation">Corporation</option>
                                    <option value="institution">Institution</option>
                                    <option value="government">Government</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Entity Size</label>
                                <select class="form-select" id="entitySize">
                                    <option value="">Select size</option>
                                    <option value="1-10">1-10 people</option>
                                    <option value="11-50">11-50 people</option>
                                    <option value="51-200">51-200 people</option>
                                    <option value="201-1000">201-1000 people</option>
                                    <option value="1000+">1000+ people</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Entity Description</label>
                                <textarea class="form-textarea" id="entityDescription" placeholder="Brief description of the entity..." rows="4"></textarea>
                                <p class="form-help">Provide a clear description of the entity's purpose and activities</p>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button type="button" class="btn btn-secondary" onclick="cancelEntityCreation()">
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-primary" onclick="createEntityAccount()">
                                    Create
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-save-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveSection('entity-accounts')">Save Changes</button>
                    </div>
                </section>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button class="btn btn-danger" onclick="confirmReset()">
                        Reset Changes
                    </button>
                    <div class="form-actions-right">
                        <button class="btn btn-secondary" onclick="cancelEdit()">
                            Cancel
                        </button>
                        <button class="btn btn-primary" onclick="saveProfile()">
                            Save Changes
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- DCF Modular System -->
    <script src="../js/dcf-core.js"></script>
    <script src="../js/dcf-ui.js"></script>
    <script src="../js/dcf-auth.js"></script>
    <script src="../js/dcf-init.js"></script>
    
    <script>
        // Track unsaved changes
        let hasUnsavedChanges = false;
        let isNavigatingAway = false;
        
        // ============================================
        // SECURITY: Comprehensive Input Sanitization
        // ============================================
        // This edit profile form implements bulletproof input sanitization to prevent:
        // 1. Cross-Site Scripting (XSS) attacks
        // 2. SQL Injection attacks
        // 3. JavaScript injection
        // 4. HTML/XML injection
        // 5. Command injection
        // 6. Buffer overflow attempts
        // All inputs are sanitized both in real-time and on submission
        
        /**
         * Comprehensive input sanitization function
         * Removes dangerous patterns, scripts, and injection attempts
         */
        function sanitizeInput(input) {
            if (typeof input !== 'string') {
                return '';
            }
            
            // Store original length for logging
            const originalLength = input.length;
            
            // Step 1: Remove all HTML/XML tags including script tags
            let sanitized = input.replace(/<\/?[^>]+(>|$)/gi, '');
            
            // Step 2: Remove JavaScript event handlers
            sanitized = sanitized.replace(/on\w+\s*=\s*["'][^"']*["']/gi, '');
            sanitized = sanitized.replace(/on\w+\s*=\s*[^\s>]*/gi, '');
            
            // Step 3: Remove javascript:, data:, vbscript: and other dangerous URL schemes
            sanitized = sanitized.replace(/javascript\s*:/gi, '');
            sanitized = sanitized.replace(/data\s*:/gi, '');
            sanitized = sanitized.replace(/vbscript\s*:/gi, '');
            sanitized = sanitized.replace(/about\s*:/gi, '');
            sanitized = sanitized.replace(/chrome\s*:/gi, '');
            sanitized = sanitized.replace(/file\s*:/gi, '');
            
            // Step 4: Remove SQL injection patterns
            const sqlPatterns = [
                /(\b)(DROP|DELETE|INSERT|UPDATE|SELECT|UNION|CREATE|ALTER|EXEC|EXECUTE|SCRIPT|TRUNCATE)(\b)/gi,
                /(--)|(\/\*[\s\S]*?\*\/)/g,  // SQL comments
                /(\b)(OR|AND)(\b)\s*\d+\s*=\s*\d+/gi,  // OR 1=1 patterns
                /(\b)(OR|AND)(\b)\s*['"][^'"]*['"]\s*=\s*['"][^'"]*['"]/gi,  // OR 'a'='a' patterns
                /;.*(DROP|DELETE|INSERT|UPDATE|SELECT)/gi,  // Semicolon followed by SQL command
                /\bWAITFOR\s+DELAY/gi,  // SQL Server delay attacks
                /\bBENCHMARK\s*\(/gi,  // MySQL benchmark attacks
                /\bSLEEP\s*\(/gi  // Sleep attacks
            ];
            
            sqlPatterns.forEach(pattern => {
                sanitized = sanitized.replace(pattern, '');
            });
            
            // Step 5: Remove inline styles that could be malicious
            sanitized = sanitized.replace(/style\s*=\s*["'][^"']*["']/gi, '');
            sanitized = sanitized.replace(/style\s*=\s*[^\s>]*/gi, '');
            
            // Step 6: Remove potentially dangerous characters in specific contexts
            // But preserve valid characters for general text
            const dangerousChars = [
                /[<>]/g,  // Angle brackets
                /&#/g,  // HTML entities
                /\\x[0-9a-fA-F]{2}/g,  // Hex escapes
                /\\u[0-9a-fA-F]{4}/g,  // Unicode escapes
                /\0/g  // Null bytes
            ];
            
            dangerousChars.forEach(pattern => {
                sanitized = sanitized.replace(pattern, '');
            });
            
            // Step 7: Remove any remaining script-like patterns
            sanitized = sanitized.replace(/\beval\s*\(/gi, '');
            sanitized = sanitized.replace(/\bexecScript\s*\(/gi, '');
            sanitized = sanitized.replace(/\bsetTimeout\s*\(/gi, '');
            sanitized = sanitized.replace(/\bsetInterval\s*\(/gi, '');
            sanitized = sanitized.replace(/\bFunction\s*\(/gi, '');
            sanitized = sanitized.replace(/\bnew\s+Function/gi, '');
            
            // Step 8: Remove encoded scripts
            sanitized = sanitized.replace(/%3Cscript/gi, '');
            sanitized = sanitized.replace(/%3C%2Fscript/gi, '');
            sanitized = sanitized.replace(/\\x3cscript/gi, '');
            sanitized = sanitized.replace(/\\u003cscript/gi, '');
            
            // Step 9: Normalize whitespace
            sanitized = sanitized.replace(/\s+/g, ' ').trim();
            
            // Log if content was sanitized (for security monitoring)
            // Only warn if something OTHER than whitespace normalization occurred
            const normalizedInput = input.replace(/\s+/g, ' ').trim();
            if (sanitized !== normalizedInput) {
                console.warn('⚠️ Input sanitization applied. Potential attack attempt blocked.');
                console.log('Original length:', originalLength, 'Sanitized length:', sanitized.length);
            }
            
            return sanitized;
        }
        
        /**
         * Email-specific sanitization
         * Preserves valid email format while removing dangerous content
         */
        function sanitizeEmail(email) {
            if (typeof email !== 'string') {
                return '';
            }
            
            // First apply general sanitization
            let sanitized = sanitizeInput(email);
            
            // Remove any remaining non-email characters
            // Allow only valid email characters: alphanumeric, @, ., _, -, +
            sanitized = sanitized.replace(/[^a-zA-Z0-9@._\-+]/g, '');
            
            // Ensure only one @ symbol
            const atCount = (sanitized.match(/@/g) || []).length;
            if (atCount > 1) {
                // Keep only the first @ and remove others
                let firstAt = sanitized.indexOf('@');
                let beforeAt = sanitized.substring(0, firstAt);
                let afterAt = sanitized.substring(firstAt + 1).replace(/@/g, '');
                sanitized = beforeAt + '@' + afterAt;
            }
            
            // Limit length to prevent buffer overflow attempts
            if (sanitized.length > 254) {  // RFC 5321 max email length
                sanitized = sanitized.substring(0, 254);
            }
            
            return sanitized.toLowerCase();
        }
        
        /**
         * URL-specific sanitization
         * Preserves valid URL format while removing dangerous content
         */
        function sanitizeUrl(url) {
            if (typeof url !== 'string') {
                return '';
            }
            
            // First apply general sanitization
            let sanitized = sanitizeInput(url);
            
            // Remove javascript: and other dangerous schemes
            sanitized = sanitized.replace(/^javascript\s*:/gi, '');
            sanitized = sanitized.replace(/^data\s*:/gi, '');
            sanitized = sanitized.replace(/^vbscript\s*:/gi, '');
            
            // Limit length
            if (sanitized.length > 2048) {  // Common URL max length
                sanitized = sanitized.substring(0, 2048);
            }
            
            return sanitized;
        }
        
        /**
         * Phone number sanitization
         * Preserves valid phone format while removing dangerous content
         */
        function sanitizePhone(phone) {
            if (typeof phone !== 'string') {
                return '';
            }
            
            // First apply general sanitization
            let sanitized = sanitizeInput(phone);
            
            // Keep only valid phone characters: digits, +, -, (, ), spaces
            sanitized = sanitized.replace(/[^0-9+\-() ]/g, '');
            
            // Limit length
            if (sanitized.length > 20) {
                sanitized = sanitized.substring(0, 20);
            }
            
            return sanitized;
        }
        
        /**
         * Username-specific sanitization
         * Preserves valid username format while removing dangerous content
         */
        function sanitizeUsername(username) {
            if (typeof username !== 'string') {
                return '';
            }
            
            // First apply general sanitization
            let sanitized = sanitizeInput(username);
            
            // Allow only alphanumeric, underscore, and hyphen
            sanitized = sanitized.replace(/[^a-zA-Z0-9_\-]/g, '');
            
            // Limit length
            if (sanitized.length > 30) {
                sanitized = sanitized.substring(0, 30);
            }
            
            return sanitized.toLowerCase();
        }
        
        /**
         * Text field sanitization
         * Removes dangerous patterns while preserving text content
         */
        function sanitizeText(text, maxLength = 5000) {
            if (typeof text !== 'string') {
                return '';
            }
            
            let sanitized = sanitizeInput(text);
            
            // Limit length based on field requirements
            if (sanitized.length > maxLength) {
                sanitized = sanitized.substring(0, maxLength);
            }
            
            return sanitized;
        }
        
        /**
         * Initialize comprehensive input sanitization for all form fields
         */
        function initializeEditProfileSanitization() {
            // Text input fields
            const textFields = {
                'firstName': 100,
                'lastName': 100,
                'username': 30,
                'location': 100,
                'role': 100,
                'organization': 200,
                'twitter': 50
            };
            
            Object.keys(textFields).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    const maxLength = textFields[fieldId];
                    // Sanitize on blur only, not while typing
                    field.addEventListener('blur', function(e) {
                        const sanitized = fieldId === 'username' ? 
                            sanitizeUsername(e.target.value) : 
                            sanitizeText(e.target.value, maxLength);
                        if (sanitized !== e.target.value) {
                            e.target.value = sanitized;
                            console.warn(`⚠️ ${fieldId} sanitized`);
                        }
                    });
                    
                    field.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        e.target.value = fieldId === 'username' ? 
                            sanitizeUsername(pastedText) : 
                            sanitizeText(pastedText, maxLength);
                    });
                }
            });
            
            // Textarea fields
            const textareaFields = {
                'bio': 500,
                'professionalSummary': 1000
            };
            
            Object.keys(textareaFields).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    const maxLength = textareaFields[fieldId];
                    // Sanitize on blur only, not while typing
                    field.addEventListener('blur', function(e) {
                        const sanitized = sanitizeText(e.target.value, maxLength);
                        if (sanitized !== e.target.value) {
                            e.target.value = sanitized;
                            console.warn(`⚠️ ${fieldId} sanitized`);
                        }
                    });
                    
                    field.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        e.target.value = sanitizeText(pastedText, maxLength);
                    });
                }
            });
            
            // Email field
            const emailField = document.getElementById('email');
            if (emailField) {
                // Sanitize on blur only, not while typing
                emailField.addEventListener('blur', function(e) {
                    const sanitized = sanitizeEmail(e.target.value);
                    if (sanitized !== e.target.value) {
                        e.target.value = sanitized;
                        console.warn('⚠️ Email sanitized');
                    }
                });
                
                emailField.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    e.target.value = sanitizeEmail(pastedText);
                });
            }
            
            // Phone field
            const phoneField = document.getElementById('phone');
            if (phoneField) {
                // Sanitize on blur only, not while typing
                phoneField.addEventListener('blur', function(e) {
                    const sanitized = sanitizePhone(e.target.value);
                    if (sanitized !== e.target.value) {
                        e.target.value = sanitized;
                        console.warn('⚠️ Phone sanitized');
                    }
                });
                
                phoneField.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    e.target.value = sanitizePhone(pastedText);
                });
            }
            
            // URL fields
            const urlFields = ['website', 'linkedin'];
            urlFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Sanitize on blur only, not while typing
                    field.addEventListener('blur', function(e) {
                        const sanitized = sanitizeUrl(e.target.value);
                        if (sanitized !== e.target.value) {
                            e.target.value = sanitized;
                            console.warn(`⚠️ ${fieldId} sanitized`);
                        }
                    });
                    
                    field.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        e.target.value = sanitizeUrl(pastedText);
                    });
                }
            });
            
            // Tag input fields (skills, interests, focus)
            const tagFields = ['skillsInput', 'interestsInput', 'focusInput'];
            tagFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Sanitize on blur only, not while typing
                    field.addEventListener('blur', function(e) {
                        const sanitized = sanitizeText(e.target.value, 50);
                        if (sanitized !== e.target.value) {
                            e.target.value = sanitized;
                            console.warn(`⚠️ ${fieldId} sanitized`);
                        }
                    });
                    
                    field.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        e.target.value = sanitizeText(pastedText, 50);
                    });
                }
            });
            
            // Select fields
            const selectFields = ['industry', 'experience'];
            selectFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', function(e) {
                        const sanitized = sanitizeText(e.target.value, 100);
                        if (sanitized !== e.target.value) {
                            e.target.value = sanitized;
                            console.warn(`⚠️ ${fieldId} sanitized`);
                        }
                    });
                }
            });
            
            console.log('✅ Security: Edit profile form sanitization initialized for all fields');
        }
        
        // Profile data
        let currentProfile = null;
        let currentUser = null;
        let profileId = null;
        let originalData = null;
        let avatarFile = null;
        let coverFile = null;
        let coverPosition = 50;

        // Sign out function
        async function signOut() {
            try {
                const { error } = await window.dcfSupabase.auth.signOut();
                if (!error) {
                    window.location.href = '../index.html';
                }
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('dcfReady', async function() {
            console.log('Initializing edit profile page...');
            
            // Show loading while checking auth
            showLoading(true);
            
            // Initialize authentication
            if (window.initializeAuth) {
                const isLoggedIn = await window.initializeAuth();
                if (isLoggedIn) {
                    currentUser = window.getCurrentUser();
                } else {
                    currentUser = null;
                }
            }
            
            try {
                
                if (!currentUser) {
                    console.log('No authenticated user found');
                    showLoading(false);
                    showNotification('Please log in to edit profile', 'error');
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 3000);
                    return;
                }
                
                console.log('Current user:', currentUser.id);
                
                // Get profile ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                profileId = urlParams.get('id');
                
                // If no profile ID in URL, use current user's ID
                if (!profileId) {
                    profileId = currentUser.id;
                }
                
                // Verify ownership - users can only edit their own profile
                if (profileId !== currentUser.id) {
                    console.log('Profile ID mismatch:', profileId, 'vs', currentUser.id);
                    showNotification('You can only edit your own profile', 'error');
                    setTimeout(() => {
                        window.location.href = `dcf_member_profile.html?id=${profileId}`;
                    }, 2000);
                    return;
                }
                
                // Load profile data
                await loadProfileData();
                
                // Setup event listeners
                setupEventListeners();
                
                // Setup sidebar navigation
                setupSidebarNavigation();
                
            } catch (error) {
                console.error('Auth check error:', error);
                showLoading(false);
                showNotification('Authentication error. Please try again.', 'error');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 3000);
            }
        });

        // Load profile data
        async function loadProfileData() {
            try {
                showLoading(true);
                
                const { data, error } = await window.dcfSupabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error('Error loading profile:', error);
                    showNotification('Error loading profile data', 'error');
                    return;
                }
                
                currentProfile = data;
                originalData = JSON.parse(JSON.stringify(data)); // Deep clone for reset
                
                // Populate form fields
                populateFormFields(data);
                
                // Initialize comprehensive input sanitization
                initializeEditProfileSanitization();
                
                // Setup change tracking for all form inputs
                setupChangeTracking();
                
                // Load existing entities
                await loadExistingEntities();
                
                showLoading(false);
                console.log('Profile data loaded:', data);
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to load profile', 'error');
                showLoading(false);
            }
        }

        // Populate form fields with profile data
        function populateFormFields(profile) {
            // Basic Information
            document.getElementById('firstName').value = profile.first_name || '';
            document.getElementById('lastName').value = profile.last_name || '';
            document.getElementById('username').value = profile.username || '';
            document.getElementById('bio').value = profile.bio || '';
            document.getElementById('location').value = profile.location || '';
            
            // Profile Media
            if (profile.avatar_url) {
                const preview = document.getElementById('avatarPreview');
                preview.innerHTML = `<img src="${profile.avatar_url}" alt="Avatar">`;
            }
            
            if (profile.cover_image_url) {
                const uploadArea = document.getElementById('coverUploadArea');
                uploadArea.classList.add('has-image');
                uploadArea.innerHTML = `<img src="${profile.cover_image_url}" class="upload-preview" alt="Cover">`;
                
                // Show position controls
                document.getElementById('coverPositionControls').style.display = 'block';
                
                // Also set the preview box image
                const previewImage = document.getElementById('coverPreviewImage');
                if (previewImage) {
                    previewImage.src = profile.cover_image_url;
                    previewImage.style.display = 'block';
                }
                
                // Set position if available
                if (profile.cover_position) {
                    const match = profile.cover_position.match(/(\d+)%/);
                    if (match) {
                        coverPosition = parseInt(match[1]);
                        document.getElementById('coverPositionSlider').value = coverPosition;
                        
                        // Update positions in both previews
                        const img = uploadArea.querySelector('img');
                        if (img) {
                            img.style.objectPosition = `center ${coverPosition}%`;
                        }
                        if (previewImage) {
                            previewImage.style.objectPosition = `center ${coverPosition}%`;
                        }
                    }
                }
            }
            
            // Professional Details
            document.getElementById('role').value = profile.job_title || '';
            document.getElementById('organization').value = profile.organization || '';
            document.getElementById('industry').value = profile.industry || '';
            document.getElementById('experience').value = profile.experience_level || '';
            document.getElementById('professionalSummary').value = profile.professional_summary || '';
            
            // Skills & Interests
            if (profile.skills) {
                const skills = typeof profile.skills === 'string' ? 
                    profile.skills.split(',').map(s => s.trim()) : profile.skills;
                displayTags('skillsContainer', skills);
            }
            
            if (profile.interests) {
                const interests = typeof profile.interests === 'string' ? 
                    profile.interests.split(',').map(i => i.trim()) : profile.interests;
                displayTags('interestsContainer', interests);
            }
            
            if (profile.focus_areas) {
                const focusAreas = typeof profile.focus_areas === 'string' ? 
                    profile.focus_areas.split(',').map(f => f.trim()) : profile.focus_areas;
                displayTags('focusContainer', focusAreas);
            }
            
            // Contact Information
            document.getElementById('email').value = profile.email || '';
            document.getElementById('phone').value = profile.phone || '';
            document.getElementById('website').value = profile.website || '';
            document.getElementById('linkedin').value = profile.linkedin || '';
            document.getElementById('twitter').value = profile.twitter || '';
            
            // Privacy Settings
            const visibility = profile.visibility || 'connections';
            document.getElementById(`visibility${visibility.charAt(0).toUpperCase() + visibility.slice(1)}`).checked = true;
            selectPrivacy(visibility);
            
            document.getElementById('allowMessages').checked = profile.allow_messages !== false;
            document.getElementById('allowConnectionRequests').checked = profile.allow_connection_requests !== false;
            document.getElementById('showEmail').checked = profile.show_email === true;
            document.getElementById('showPhone').checked = profile.show_phone === true;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Avatar upload
            document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
            
            // Cover upload
            document.getElementById('coverInput').addEventListener('change', handleCoverUpload);
            
            // Cover position slider
            document.getElementById('coverPositionSlider').addEventListener('input', function(e) {
                coverPosition = parseInt(e.target.value);
                updateCoverPosition();
            });
            
            // Initialize character counting for bio field
            initializeFormValidation();
            
            // Tags inputs
            setupTagsInput('skillsInput', 'skillsContainer');
            setupTagsInput('interestsInput', 'interestsContainer');
            setupTagsInput('focusInput', 'focusContainer');
        }

        // Character count and validation functions
        function updateCharCount(fieldId, maxLength, minLength = 0) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(fieldId + 'Count');
            
            if (field && counter) {
                let currentLength = field.value.length;
                
                // Enforce hard limit
                if (currentLength > maxLength) {
                    field.value = field.value.substring(0, maxLength);
                    currentLength = maxLength;
                }
                
                let displayText = `${currentLength}/${maxLength} characters`;
                
                if (minLength > 0 && currentLength < minLength) {
                    displayText += ` (minimum ${minLength})`;
                    counter.className = 'char-counter invalid';
                    counter.style.color = '#ef9a9a'; // Soft red
                } else if (currentLength === maxLength) {
                    counter.className = 'char-counter warning';
                    counter.style.color = '#ffa726'; // Soft orange
                } else {
                    counter.className = 'char-counter valid';
                    counter.style.color = '#6b7280'; // Neutral gray
                }
                
                counter.textContent = displayText;
            }
        }
        
        function showFieldError(field, message) {
            clearFieldError(field);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error';
            errorDiv.id = field.id + '-error';
            errorDiv.textContent = message;
            field.parentElement.appendChild(errorDiv);
            field.classList.add('error');
        }
        
        function clearFieldError(field) {
            const existingError = document.getElementById(field.id + '-error');
            if (existingError) {
                existingError.remove();
            }
            field.classList.remove('error');
        }
        
        // Initialize form character counting
        function initializeFormValidation() {
            // Bio field with character counter
            const bioField = document.getElementById('bio');
            if (bioField) {
                // Initialize character counter
                updateCharCount('bio', 500);
                
                // Add real-time character counting
                bioField.addEventListener('input', () => {
                    updateCharCount('bio', 500);
                });
                
                // Add validation on blur only
                bioField.addEventListener('blur', () => {
                    const value = bioField.value.trim();
                    if (value.length > 500) {
                        showFieldError(bioField, 'Maximum 500 characters allowed');
                    } else {
                        clearFieldError(bioField);
                    }
                });
                
                // Remove validation on focus
                bioField.addEventListener('focus', () => {
                    clearFieldError(bioField);
                });
            }
        }
        
        // Setup tags input functionality
        function setupTagsInput(inputId, containerId) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const value = input.value.trim();
                    if (value) {
                        addTag(containerId, value);
                        input.value = '';
                    }
                }
            });
            
            // Focus input when clicking container
            container.addEventListener('click', function() {
                input.focus();
            });
        }

        // Add tag to container
        function addTag(containerId, value) {
            const container = document.getElementById(containerId);
            const input = container.querySelector('.tags-input');
            
            // Check if tag already exists
            const existingTags = container.querySelectorAll('.tag-item');
            for (let tag of existingTags) {
                if (tag.textContent.replace('×', '').trim() === value) {
                    return; // Tag already exists
                }
            }
            
            const tagElement = document.createElement('div');
            tagElement.className = 'tag-item';
            tagElement.innerHTML = `
                ${value}
                <span class="tag-remove" onclick="removeTag(this)">×</span>
            `;
            
            container.insertBefore(tagElement, input);
            hasUnsavedChanges = true;
        }

        // Remove tag
        function removeTag(element) {
            element.parentElement.remove();
            hasUnsavedChanges = true;
        }
        
        // Setup change tracking for all form inputs
        function setupChangeTracking() {
            // Track all input, textarea, and select elements
            const formElements = document.querySelectorAll('input, textarea, select');
            formElements.forEach(element => {
                element.addEventListener('change', () => {
                    hasUnsavedChanges = true;
                });
                element.addEventListener('input', () => {
                    hasUnsavedChanges = true;
                });
            });
            
            // Track radio buttons and checkboxes
            const radioCheckboxes = document.querySelectorAll('input[type="radio"], input[type="checkbox"]');
            radioCheckboxes.forEach(element => {
                element.addEventListener('click', () => {
                    hasUnsavedChanges = true;
                });
            });
        }
        
        // Show unsaved changes dialog
        async function showUnsavedChangesDialog() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'unsaved-modal';
                modal.innerHTML = `
                    <div class="unsaved-modal-content">
                        <h3>Unsaved Changes</h3>
                        <p>You have unsaved changes. What would you like to do?</p>
                        <div class="unsaved-modal-buttons">
                            <button class="btn btn-primary" onclick="saveAndLeave()">Save & Leave</button>
                            <button class="btn btn-secondary" onclick="leaveWithoutSaving()">Leave Without Saving</button>
                            <button class="btn btn-ghost" onclick="cancelNavigation()">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add styles for modal
                if (!document.getElementById('unsaved-modal-styles')) {
                    const style = document.createElement('style');
                    style.id = 'unsaved-modal-styles';
                    style.textContent = `
                        .unsaved-modal {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10000;
                        }
                        .unsaved-modal-content {
                            background: white;
                            padding: 2rem;
                            border-radius: 12px;
                            max-width: 500px;
                            width: 90%;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                        }
                        .unsaved-modal-content h3 {
                            margin-bottom: 1rem;
                            color: #333;
                        }
                        .unsaved-modal-content p {
                            margin-bottom: 1.5rem;
                            color: #666;
                        }
                        .unsaved-modal-buttons {
                            display: flex;
                            gap: 1rem;
                            justify-content: flex-end;
                        }
                        .unsaved-modal-buttons .btn-ghost {
                            background: transparent;
                            color: #666;
                            border: 1px solid #ddd;
                        }
                        .unsaved-modal-buttons .btn-ghost:hover {
                            background: #f8f9fa;
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Store resolve function globally for button handlers
                window.unsavedDialogResolve = resolve;
            });
        }
        
        // Handle save and leave
        window.saveAndLeave = async function() {
            const modal = document.querySelector('.unsaved-modal');
            if (modal) modal.remove();
            
            // Save the profile
            await saveProfile();
            hasUnsavedChanges = false;
            isNavigatingAway = true;
            
            // Continue with navigation
            if (window.pendingNavigation) {
                window.location.href = window.pendingNavigation;
            }
            
            if (window.unsavedDialogResolve) {
                window.unsavedDialogResolve(true);
            }
        }
        
        // Handle leave without saving
        window.leaveWithoutSaving = function() {
            const modal = document.querySelector('.unsaved-modal');
            if (modal) modal.remove();
            
            hasUnsavedChanges = false;
            isNavigatingAway = true;
            
            // Continue with navigation
            if (window.pendingNavigation) {
                window.location.href = window.pendingNavigation;
            }
            
            if (window.unsavedDialogResolve) {
                window.unsavedDialogResolve(true);
            }
        }
        
        // Handle cancel navigation
        window.cancelNavigation = function() {
            const modal = document.querySelector('.unsaved-modal');
            if (modal) modal.remove();
            
            window.pendingNavigation = null;
            
            if (window.unsavedDialogResolve) {
                window.unsavedDialogResolve(false);
            }
        }

        // Display tags in container
        function displayTags(containerId, tags) {
            const container = document.getElementById(containerId);
            const input = container.querySelector('.tags-input');
            
            // Clear existing tags
            container.querySelectorAll('.tag-item').forEach(tag => tag.remove());
            
            // Add new tags
            tags.forEach(tag => {
                if (tag) addTag(containerId, tag);
            });
        }

        // Get tags from container
        function getTags(containerId) {
            const container = document.getElementById(containerId);
            const tags = [];
            container.querySelectorAll('.tag-item').forEach(tag => {
                tags.push(tag.textContent.replace('×', '').trim());
            });
            return tags;
        }

        // Handle avatar upload
        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image size should be less than 5MB', 'error');
                return;
            }
            
            avatarFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('avatarPreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Avatar Preview">`;
            };
            reader.readAsDataURL(file);
        }

        // Handle cover upload
        function handleCoverUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('Image size should be less than 10MB', 'error');
                return;
            }
            
            // Store file for upload
            coverFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // Update main upload area preview
                const uploadArea = document.getElementById('coverUploadArea');
                uploadArea.classList.add('has-image');
                uploadArea.innerHTML = `<img src="${imageData}" class="upload-preview" alt="Cover Preview" style="object-position: center ${coverPosition}%;">`;
                
                // Show position controls
                const positionControls = document.getElementById('coverPositionControls');
                if (positionControls) {
                    positionControls.style.display = 'block';
                }
                
                // SET THE PREVIEW BOX IMAGE SOURCE
                const previewImage = document.getElementById('coverPreviewImage');
                if (previewImage) {
                    previewImage.src = imageData;
                    previewImage.style.objectPosition = `center ${coverPosition}%`;
                    // Ensure the image is visible
                    previewImage.style.display = 'block';
                }
                
                // Mark as having unsaved changes
                hasUnsavedChanges = true;
                
                // Show success notification
                showNotification(`Cover photo ready for upload: ${file.name}`, 'success');
            };
            reader.readAsDataURL(file);
        }

        // Update cover position
        function updateCoverPosition() {
            const position = coverPosition;
            
            // Update main upload area image
            const uploadArea = document.getElementById('coverUploadArea');
            const mainImg = uploadArea.querySelector('img');
            if (mainImg) {
                mainImg.style.objectPosition = `center ${position}%`;
            }
            
            // Update preview box image
            const previewImage = document.getElementById('coverPreviewImage');
            if (previewImage) {
                previewImage.style.objectPosition = `center ${position}%`;
            }
            
            // Mark as having unsaved changes
            hasUnsavedChanges = true;
        }

        // Save cover position to database
        async function saveCoverPosition() {
            try {
                showLoading(true);
                
                const updates = {
                    cover_position: `center ${coverPosition}%`,
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await window.dcfSupabase
                    .from('user_profiles')
                    .update(updates)
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                showNotification('Cover photo position saved!', 'success');
                hasUnsavedChanges = false;
                
            } catch (error) {
                console.error('Save cover position error:', error);
                showNotification('Failed to save position: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Expose to window for onclick handler
        window.saveCoverPosition = saveCoverPosition;

        // Remove avatar
        function removeAvatar() {
            avatarFile = null;
            const preview = document.getElementById('avatarPreview');
            preview.innerHTML = '<span data-icon="user" data-size="standard"></span>';
            document.getElementById('avatarInput').value = '';
        }

        // Select privacy option
        function selectPrivacy(value) {
            // Update visual state
            document.querySelectorAll('.privacy-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector(`input[value="${value}"]`).closest('.privacy-option');
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Check the radio button
            document.getElementById(`visibility${value.charAt(0).toUpperCase() + value.slice(1)}`).checked = true;
        }

        // Setup sidebar navigation
        function setupSidebarNavigation() {
            const navItems = document.querySelectorAll('.sidebar-nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active state
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Scroll to section
                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
            
            // Update active state on scroll
            window.addEventListener('scroll', function() {
                const sections = document.querySelectorAll('.edit-section');
                let current = '';
                
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    const sectionHeight = section.clientHeight;
                    if (pageYOffset >= (sectionTop - 150)) {
                        current = section.getAttribute('id');
                    }
                });
                
                navItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('href') === '#' + current) {
                        item.classList.add('active');
                    }
                });
            });
        }

        // Save profile
        // Intercept navigation attempts
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges && !isNavigatingAway) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
        
        // Intercept link clicks
        document.addEventListener('click', async function(e) {
            // Check if it's a link or button that navigates
            const link = e.target.closest('a');
            if (link && link.href && hasUnsavedChanges && !isNavigatingAway) {
                e.preventDefault();
                window.pendingNavigation = link.href;
                await showUnsavedChangesDialog();
            }
        }, true);
        
        async function saveProfile() {
            try {
                showLoading(true);
                
                // Collect form data with sanitization
                const updates = {
                    first_name: sanitizeText(document.getElementById('firstName').value.trim(), 100),
                    last_name: sanitizeText(document.getElementById('lastName').value.trim(), 100),
                    username: sanitizeUsername(document.getElementById('username').value.trim()),
                    bio: sanitizeText(document.getElementById('bio').value.trim(), 500),
                    location: sanitizeText(document.getElementById('location').value.trim(), 100),
                    job_title: sanitizeText(document.getElementById('role').value.trim(), 100),
                    organization: sanitizeText(document.getElementById('organization').value.trim(), 200),
                    industry: sanitizeText(document.getElementById('industry').value, 50),
                    experience_level: sanitizeText(document.getElementById('experience').value, 50),
                    professional_summary: sanitizeText(document.getElementById('professionalSummary').value.trim(), 1000),
                    skills: sanitizeText(getTags('skillsContainer').join(', '), 500),
                    interests: sanitizeText(getTags('interestsContainer').join(', '), 500),
                    focus_areas: sanitizeText(getTags('focusContainer').join(', '), 500),
                    email: sanitizeEmail(document.getElementById('email').value.trim()),
                    phone: sanitizePhone(document.getElementById('phone').value.trim()),
                    website: sanitizeUrl(document.getElementById('website').value.trim()),
                    linkedin: sanitizeUrl(document.getElementById('linkedin').value.trim()),
                    twitter: sanitizeText(document.getElementById('twitter').value.trim(), 50),
                    visibility: document.querySelector('input[name="visibility"]:checked').value,
                    allow_messages: document.getElementById('allowMessages').checked,
                    allow_connection_requests: document.getElementById('allowConnectionRequests').checked,
                    show_email: document.getElementById('showEmail').checked,
                    show_phone: document.getElementById('showPhone').checked,
                    cover_position: `center ${coverPosition}%`,
                    updated_at: new Date().toISOString()
                };
                
                // Upload avatar if changed
                if (avatarFile) {
                    const avatarUrl = await uploadFile(avatarFile, 'avatar');
                    if (avatarUrl) {
                        updates.avatar_url = avatarUrl;
                    }
                }
                
                // Upload cover if changed
                if (coverFile) {
                    const coverUrl = await uploadFile(coverFile, 'cover');
                    if (coverUrl) {
                        updates.cover_image_url = coverUrl;
                    }
                }
                
                // Log the data being sent for debugging
                console.log('Attempting to save profile with data:', updates);
                console.log('Current user ID:', currentUser.id);
                
                // Update profile in database
                const { error } = await window.dcfSupabase
                    .from('user_profiles')
                    .update(updates)
                    .eq('id', currentUser.id);
                
                if (error) {
                    console.error('Update error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    console.error('Full error object:', error);
                    throw error;
                }
                
                showNotification('Profile updated successfully!', 'success');
                
                // Reset unsaved changes flag
                hasUnsavedChanges = false;
                
            } catch (error) {
                console.error('Save error:', error);
                showNotification('Failed to save profile: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveSection(sectionName) {
            try {
                // Use the existing saveProfile logic but with section-specific feedback
                showLoading(true);
                
                // Call the existing saveProfile function
                await saveProfile();
                
                // Show section-specific success message
                showNotification(`${getSectionDisplayName(sectionName)} updated successfully!`, 'success');
                
            } catch (error) {
                console.error(`Save ${sectionName} error:`, error);
                showNotification(`Failed to save ${getSectionDisplayName(sectionName)}: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function getSectionDisplayName(sectionName) {
            const names = {
                'basic-info': 'Basic Information',
                'profile-media': 'Profile Photos',
                'professional': 'Professional Details',
                'skills-interests': 'Skills & Interests',
                'contact': 'Contact Information',
                'privacy': 'Privacy Settings',
                'entity-accounts': 'Entity Accounts'
            };
            return names[sectionName] || 'Section';
        }
        
        // Expose saveSection to window for onclick handlers
        window.saveSection = saveSection;

        // Upload file to Supabase storage
        async function uploadFile(file, type) {
            try {
                const fileExt = file.name.split('.').pop().toLowerCase();
                const timestamp = Date.now();
                const userEmail = currentUser.email.replace(/[^a-zA-Z0-9]/g, '_');
                const fileName = `${type}_${userEmail}_${timestamp}.${fileExt}`;
                
                const formData = new FormData();
                formData.append('file', file);
                
                const uploadResponse = await fetch(`https://atzommnkkwzgbktuzjti.supabase.co/storage/v1/object/media/${fileName}`, {
                    method: 'POST',
                    headers: {
                        'apikey': 'sb_publishable_H7mmmUclubQKjq1tGwTalA_omRtGoV8',
                        'Authorization': 'Bearer sb_publishable_H7mmmUclubQKjq1tGwTalA_omRtGoV8'
                    },
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                return `https://atzommnkkwzgbktuzjti.supabase.co/storage/v1/object/public/media/${fileName}`;
                
            } catch (error) {
                console.error('File upload error:', error);
                showNotification(`Failed to upload ${type}`, 'error');
                return null;
            }
        }

        // Cancel edit
        function cancelEdit() {
            showConfirm('Are you sure you want to cancel? Any unsaved changes will be lost.').then(confirmed => {
                if (confirmed) {
                    window.location.href = 'dcf_member_profile.html';
                }
            });
        }

        // Confirm reset
        function confirmReset() {
            showConfirm('Are you sure you want to reset all changes? This will restore the original values.').then(confirmed => {
                if (confirmed) {
                    populateFormFields(originalData);
                    avatarFile = null;
                    coverFile = null;
                    showNotification('Changes have been reset', 'info');
                }
            });
        }

        // Entity Account Management Functions
        function showEntityCreationForm() {
            document.getElementById('createEntityButton').style.display = 'none';
            document.getElementById('entityCreationForm').style.display = 'block';
            
            // Focus on the first input
            document.getElementById('entityName').focus();
        }
        
        function cancelEntityCreation() {
            // Clear form inputs
            document.getElementById('entityName').value = '';
            document.getElementById('entityUsername').value = '';
            document.getElementById('entityType').value = '';
            document.getElementById('entitySize').value = '';
            document.getElementById('entityDescription').value = '';
            
            // Hide form and show button
            document.getElementById('entityCreationForm').style.display = 'none';
            document.getElementById('createEntityButton').style.display = 'block';
        }
        
        async function createEntityAccount() {
            const entityName = sanitizeText(document.getElementById('entityName').value.trim(), 100);
            const entityUsername = sanitizeUsername(document.getElementById('entityUsername').value.trim());
            const entityType = document.getElementById('entityType').value;
            const entitySize = document.getElementById('entitySize').value;
            const entityDescription = sanitizeText(document.getElementById('entityDescription').value.trim(), 500);
            
            // Validation
            if (!entityName || !entityUsername || !entityType) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (entityName.length < 2) {
                showNotification('Entity name must be at least 2 characters', 'error');
                return;
            }
            
            if (entityUsername.length < 3) {
                showNotification('Username must be at least 3 characters', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                // Check if username is already taken
                const { data: existingUser } = await window.dcfSupabase
                    .from('user_profiles')
                    .select('username')
                    .eq('username', entityUsername)
                    .single();
                    
                if (existingUser) {
                    showNotification('Username is already taken', 'error');
                    showLoading(false);
                    return;
                }
                
                // Create entity account
                const { data, error } = await window.dcfSupabase
                    .from('user_profiles')
                    .insert({
                        email: `entity_${Date.now()}@dcfhungary.internal`,
                        first_name: entityName,
                        username: entityUsername,
                        account_type: 'entity',
                        entity_type: entityType,
                        entity_size: entitySize,
                        entity_description: entityDescription,
                        bio: entityDescription,
                        created_by: currentUser.id,
                        visibility: 'public',
                        profile_public: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                    
                if (error) throw error;
                
                showNotification('Entity account created successfully!', 'success');
                cancelEntityCreation();
                loadExistingEntities();
                
            } catch (error) {
                console.error('Entity creation error:', error);
                showNotification('Failed to create entity: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function loadExistingEntities() {
            try {
                const { data: entities, error } = await window.dcfSupabase
                    .from('user_profiles')
                    .select('id, first_name, username, entity_type, created_at')
                    .eq('created_by', currentUser.id)
                    .eq('account_type', 'entity')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                const container = document.getElementById('existingEntities');
                if (entities && entities.length > 0) {
                    container.innerHTML = `
                        <h3 style="margin-bottom: 1rem; color: #333; font-size: 1.2rem;">Your Entity Accounts</h3>
                        ${entities.map(entity => `
                            <div style="padding: 1rem; border: 1px solid #e5e5e5; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; background: white;">
                                <div>
                                    <strong style="color: #333;">${entity.first_name}</strong>
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">@${entity.username} • ${entity.entity_type || 'Entity'}</div>
                                </div>
                                <a href="dcf_member_profile.html?id=${entity.id}" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">View Profile</a>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                console.error('Load entities error:', error);
            }
        }
        
        // Expose entity functions to window for onclick handlers
        window.showEntityCreationForm = showEntityCreationForm;
        window.cancelEntityCreation = cancelEntityCreation;
        window.createEntityAccount = createEntityAccount;
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Show/hide loading overlay
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
    </script>
    
    <script>
    // Wait for DCF system to be ready
    function initializeIconsWhenReady() {
            // Wait for icon system AND correct icon set
            if (window.iconSystem && 
                typeof window.iconSystem.getIcon === 'function' &&
                window.iconSystem.currentIconSet === 'sacred-minimalist') {
                
                console.log('✅ Sacred-minimalist icon set ready, initializing sidebar icons...');
                
                document.querySelectorAll('[data-icon]').forEach(element => {
                    const iconName = element.dataset.icon;
                    const size = element.dataset.size || 'small';
                    element.innerHTML = window.iconSystem.getIcon(iconName, size);
                });
                
                console.log('✅ Sidebar icons initialized successfully');
            } else {
                // Keep checking - the sacred-minimalist set loads after emoji set
                setTimeout(initializeIconsWhenReady, 200);
            }
        }
        
        // Start checking when DCF system is ready
        if (window.dcfInit && window.dcfInit.isReady()) {
            setTimeout(initializeIconsWhenReady, 500);
        } else {
            window.addEventListener('dcfReady', function() {
                setTimeout(initializeIconsWhenReady, 500);
            });
        }
    </script>
    
</body>
</html>