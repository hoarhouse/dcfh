<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - DCF Hungary</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23dc3545'/></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/dcf-unified-auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: #333;
            border-radius: 50%;
            margin-right: 8px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            text-decoration: none;
            color: #666;
            font-size: 0.9rem;
            position: relative;
        }

        .nav-menu a.active {
            color: #333;
            font-weight: 600;
        }

        .nav-menu a:hover {
            color: #333;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }



        

        .user-menu {
            position: relative;
        }

        .user-dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e5e5;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

                .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #666;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow: hidden;
            /* Content controlled by master-consolidated.js */
        }

        .user-avatar:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dropdown-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #000, #333);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
            box-sizing: border-box;
            overflow: hidden;
        }

        .dropdown-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-email {
            color: #666;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-divider {
            height: 1px;
            background: #f0f0f0;
            margin: 0.5rem 0;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #000;
        }

        .logout-btn {
            color: #dc3545 !important;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #fee !important;
            color: #c82333 !important;
        }

        .dropdown-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            display: none;
        }

        .dropdown-overlay.active {
            display: block;
        }

    

        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            color: #666;
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: #666;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: #333;
        }

        .project-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .project-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .project-title-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .project-icon {
            width: 60px;
            height: 60px;
            background: #000;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
        }

        .project-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .project-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .project-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .btn-primary {
            background: #000;
            color: white;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: transparent;
            color: #666;
            border: 2px solid #e5e5e5;
        }

        .btn-secondary:hover {
            color: #333;
            border-color: #333;
        }

        .project-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .meta-item {
            text-align: center;
        }

        .meta-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .meta-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e8;
            color: #2d7d2d;
        }

        .status-planning {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-recruiting {
            background: #e1f5fe;
            color: #01579b;
        }

        .project-description {
            color: #666;
            line-height: 1.7;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            background: #f8f9fa;
            color: #666;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid #e5e5e5;
        }

        .tag.highlight {
            background: #000;
            color: white;
            border-color: #000;
        }

        /* Project Cover Photo - Exact Match to Member Profile Cover */
        .project-hero {
            position: relative;
            height: 350px;
            margin-bottom: 2rem;
            border-radius: 16px;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .hero-background {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            z-index: 1;
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
            z-index: 2;
        }

        .hero-content {
            position: relative;
            z-index: 3;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: white;
            text-align: center;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            margin: 0;
        }

        /* Improved Text Overlay - Readable with proper positioning */
        .hero-impact-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, 
                rgba(0,0,0,0.95) 0%, 
                rgba(0,0,0,0.85) 30%,
                rgba(0,0,0,0.6) 60%,
                transparent 100%);
            padding: 3rem;
            padding-top: 6rem;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            pointer-events: none; /* Allow clicking through to image except interactive elements */
        }

        .hero-impact-overlay > * {
            pointer-events: auto; /* Re-enable clicks on overlay content */
        }


        /* Mobile responsive design */
        /* Join the Movement Banner */
        .join-movement-banner {
            background: linear-gradient(135deg, #000 0%, #333 100%);
            color: white;
            text-align: center;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .banner-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
        }

        .banner-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .banner-cta {
            background: white;
            color: #000;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .banner-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .project-hero {
                height: 300px;
            }
            
            .hero-content {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 2rem;
                gap: 1.5rem;
            }

            .hero-title {
                font-size: 2rem !important;
            }

            .banner-title {
                font-size: 2rem !important;
            }

            .banner-subtitle {
                font-size: 1rem !important;
            }
        }

        .project-meta-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .meta-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .meta-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .meta-card span:first-child {
            font-size: 1.5rem;
        }

        .meta-card div {
            display: flex;
            flex-direction: column;
        }

        .meta-card strong {
            color: #666;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .meta-card span:last-child {
            color: #333;
            font-weight: 600;
        }

        /* INSPIRATIONAL HERO IMPACT SECTION */
        .hero-impact-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.7));
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 3rem;
            text-align: center;
            color: white;
        }

        .impact-headline {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 1rem;
            text-shadow: 0 3px 6px rgba(0,0,0,0.4);
            background: linear-gradient(135deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .impact-subtitle {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            opacity: 0.95;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .impact-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-bottom: 2rem;
        }

        .impact-stat {
            text-align: center;
        }

        .impact-stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
            color: #4CAF50;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .impact-stat-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            font-weight: 600;
        }

        .hero-join-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 1.2rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            margin-top: 1rem;
        }

        .hero-join-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.6);
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        /* STORY & VISION SECTION */
        .story-vision-section {
            background: linear-gradient(135deg, #f8f9fa, #fff);
            padding: 4rem 0;
            margin-bottom: 2rem;
        }

        .story-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .story-headline {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
            color: #333;
        }

        .story-subheadline {
            font-size: 1.2rem;
            color: #666;
            text-align: center;
            margin-bottom: 3rem;
            line-height: 1.6;
        }

        .story-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #555;
            margin-bottom: 2rem;
        }

        .vision-quote {
            background: white;
            padding: 2rem;
            border-left: 4px solid #dc3545;
            border-radius: 0 12px 12px 0;
            margin: 2rem 0;
            font-style: italic;
            font-size: 1.2rem;
            color: #333;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
        }

        /* PARTICIPATION PATHWAYS */
        .participation-section {
            background: white;
            padding: 4rem 2rem;
            margin-bottom: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .pathways-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .pathway-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            padding: 2rem;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .pathway-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #dc3545, #fd7e14, #28a745);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .pathway-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            border-color: #dc3545;
        }

        .pathway-card:hover::before {
            transform: scaleX(1);
        }

        .pathway-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .pathway-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .pathway-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .pathway-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .skill-tag {
            background: #dc3545;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .pathway-action {
            background: #333;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .pathway-action:hover {
            background: #dc3545;
            transform: translateY(-2px);
        }

        /* SOCIAL PROOF SECTION */
        .social-proof-section {
            background: linear-gradient(135deg, #333, #222);
            color: white;
            padding: 4rem 2rem;
            margin-bottom: 2rem;
            border-radius: 16px;
            text-align: center;
        }

        .momentum-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .momentum-stat {
            padding: 1.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .momentum-number {
            font-size: 2rem;
            font-weight: 800;
            color: #4CAF50;
            margin-bottom: 0.5rem;
        }

        .momentum-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* URGENCY ELEMENTS */
        .urgency-banner {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(220, 53, 69, 0.3); }
            50% { box-shadow: 0 0 25px rgba(220, 53, 69, 0.6); }
        }

        .urgency-text {
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-tabs {
            display: flex;
            border-bottom: 1px solid #e5e5e5;
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 0 1.5rem;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #333;
            border-bottom-color: #333;
        }

        .tab-btn:hover {
            color: #333;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .sidebar-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .team-member:last-child {
            border-bottom: none;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.2rem;
        }

        .member-role {
            color: #666;
            font-size: 0.9rem;
        }

        .member-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            background: #f8f9fa;
            color: #666;
        }

        .member-badge.leader {
            background: #000;
            color: white;
        }

        .member-badge.contributor {
            background: #fff3cd;
            color: #856404;
        }

        .join-project-card {
            background: linear-gradient(135deg, #000, #333);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .join-project-card h3 {
            margin-bottom: 1rem;
        }

        .join-project-card p {
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }


            .content-wrapper {
                grid-template-columns: 1fr;
            }
        }

        .join-project-card .btn {
            background: white;
            color: #000;
        }

        .join-project-card .btn:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: #dc3545;
        }

        @media (max-width: 1024px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .main-content {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0 1rem;
            }

            .project-header-top {
                flex-direction: column;
                gap: 1rem;
            }

            .project-title-section {
                flex-direction: column;
                text-align: center;
            }

            .project-meta {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav-menu {
                display: none;
            }

            .content-tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <nav class="nav-container">
            <a href="../index.html" class="logo">
                <div class="logo-icon"></div>
                Domus Communis Foundation
            </a>
             <ul class="nav-menu" id="navMenu">
                <!-- Navigation populated by dcf-unified-auth.js -->
            </ul>
            <div class="user-menu">
                <div class="user-dropdown">
                    <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar"></div>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-header">
                            <div class="dropdown-avatar"></div>
                            <div class="dropdown-info">
                                <div class="dropdown-name" id="dropdownUserName"></div>
                                <div class="dropdown-email" id="dropdownUserEmail"></div>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-container">
        <div class="breadcrumb">
            <a href="dcf_projects_home.html">Projects</a>
            <span>→</span>
            <span id="breadcrumbProjectTitle">Loading...</span>
        </div>

        <div id="loadingState" class="loading">
            <h2>Loading project details...</h2>
        </div>

        <div id="errorState" class="error" style="display: none;">
            <h2>Project not found</h2>
            <p>The project you're looking for doesn't exist or has been removed.</p>
            <a href="dcf_projects_home.html" class="btn btn-primary">← Back to Projects</a>
        </div>

        <div id="projectContent" style="display: none;">
            <!-- Project Cover Photo - Exact Match to Member Profile -->
            <div class="project-hero" id="projectHero" style="display: none;">
                <div class="hero-background" id="heroBackground"></div>
                <div class="hero-overlay"></div>
                
                <div class="hero-content">
                    <h1 class="hero-title" id="heroTitle">Loading...</h1>
                </div>
            </div>

            <!-- Join the Movement Banner -->
            <div class="join-movement-banner" id="joinBanner" style="display: none;">
                <h2 class="banner-title">Join the Movement</h2>
                <p class="banner-subtitle">Be part of positive change in your community</p>
                <button class="banner-cta" onclick="joinProjectRequest(getProjectIdFromUrl(), window.currentProject?.title)">
                    🚀 Join This Project
                </button>
            </div>

            <!-- Fallback for projects without photos -->
            <div class="project-header" id="fallbackHeader">
                <div class="project-header-top">
                    <div class="project-title-section">
                        <div class="project-icon" id="projectIcon">📋</div>
                        <div>
                            <h1 class="project-title" id="projectTitle">Loading...</h1>
                            <p class="project-subtitle" id="projectSubtitle">Loading project details...</p>
                        </div>
                    </div>
                    <div class="project-actions">
                        <button class="btn btn-secondary" id="followBtn" style="display: none;">⭐ Follow</button>
                        <button class="btn btn-primary" id="joinBtn" style="display: none;">🤝 Join Project</button>
                        <button class="btn btn-primary" id="manageBtn" style="display: none; background-color: #dc3545; border-color: #dc3545;" onclick="window.location.href='dcf_project_manage.html?id=' + getProjectIdFromUrl()">⚙️ Manage Project</button>
                    </div>
                </div>

                <div class="project-meta">
                    <div class="meta-item">
                        <div class="meta-label">Status</div>
                        <div class="meta-value">
                            <span class="status-badge" id="statusBadge">Loading</span>
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Team Size</div>
                        <div class="meta-value" id="teamSize">1 Member</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Location</div>
                        <div class="meta-value" id="projectLocation">Loading...</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Created</div>
                        <div class="meta-value" id="projectCreated">Loading...</div>
                    </div>
                </div>

                <div class="project-tags" id="projectTags">
                    <!-- Tags will be loaded here -->
                </div>
            </div>

            <!-- Standalone Hero Impact Section (for projects without photos) -->
            <div class="hero-impact-standalone" id="heroImpactStandalone" style="display: none; background: linear-gradient(135deg, #333, #222); color: white; text-align: center; padding: 4rem 2rem; margin-bottom: 2rem; border-radius: 16px;">
                <h1 class="impact-headline" style="font-size: 3.5rem; font-weight: 800; margin-bottom: 1rem;">Transform Lives. Change the World.</h1>
                <p class="impact-subtitle" style="font-size: 1.3rem; margin-bottom: 2rem; opacity: 0.95;">Join a movement that's making a real difference in communities across Hungary</p>
                
                <div class="impact-stats" style="display: flex; justify-content: center; gap: 3rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <div class="impact-stat" style="text-align: center;">
                        <div class="impact-stat-number" id="peopleHelpedStandalone" style="font-size: 2.5rem; font-weight: 800; color: #4CAF50; margin-bottom: 0.5rem;">0</div>
                        <div class="impact-stat-label" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">People Helped</div>
                    </div>
                    <div class="impact-stat" style="text-align: center;">
                        <div class="impact-stat-number" id="goalsAchievedStandalone" style="font-size: 2.5rem; font-weight: 800; color: #4CAF50; margin-bottom: 0.5rem;">0</div>
                        <div class="impact-stat-label" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">Goals Achieved</div>
                    </div>
                    <div class="impact-stat" style="text-align: center;">
                        <div class="impact-stat-number" id="daysActiveStandalone" style="font-size: 2.5rem; font-weight: 800; color: #4CAF50; margin-bottom: 0.5rem;">0</div>
                        <div class="impact-stat-label" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">Days Active</div>
                    </div>
                </div>
                
                <button class="hero-join-btn" onclick="joinProjectRequest(getProjectIdFromUrl(), window.currentProject?.title)" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 1.2rem 2.5rem; font-size: 1.1rem; font-weight: 700; border: none; border-radius: 50px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);">
                    🚀 Join This Project
                </button>
            </div>

            <!-- Urgency Banner -->
            <div class="urgency-banner" id="urgencyBanner" style="display: none;">
                <div class="urgency-text">
                    <div class="pulse-dot"></div>
                    <span>⚡ Only 3 spots left for this impact project - Join before it's too late!</span>
                </div>
            </div>

            <!-- Story & Vision Section -->
            <div class="story-vision-section" id="storySection" style="display: none;">
                <div class="story-container">
                    <h2 class="story-headline" id="storyHeadline">Our Mission</h2>
                    <p class="story-subheadline" id="storySubheadline">Every great change starts with a single step. Here's ours.</p>
                    
                    <div class="story-content" id="storyContent">
                        <p>This project was born from a simple belief: that when passionate people come together around a shared vision, extraordinary things happen. We're not just building another project – we're creating a movement that will ripple through our community for generations to come.</p>
                        
                        <p>Your skills, your passion, and your unique perspective are exactly what we need to turn this vision into reality. Together, we can achieve something that none of us could accomplish alone.</p>
                    </div>
                    
                    <div class="vision-quote">
                        "The best time to plant a tree was 20 years ago. The second best time is now. Join us in planting the seeds of change."
                    </div>
                </div>
            </div>

            <!-- Participation Pathways Section -->
            <div class="participation-section" id="participationSection" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 1rem; font-size: 2.5rem; font-weight: 700;">How You Can Make a Difference</h2>
                <p style="text-align: center; color: #666; font-size: 1.2rem; margin-bottom: 2rem;">Choose your path to impact. Every contribution matters.</p>
                
                <div class="pathways-grid">
                    <div class="pathway-card" onclick="joinWithSkill('leadership')">
                        <span class="pathway-icon">🎯</span>
                        <h3 class="pathway-title">Project Leadership</h3>
                        <p class="pathway-description">Guide strategic decisions and coordinate team efforts to maximize our impact.</p>
                        <div class="pathway-skills">
                            <span class="skill-tag">Strategy</span>
                            <span class="skill-tag">Leadership</span>
                            <span class="skill-tag">Communication</span>
                        </div>
                        <button class="pathway-action">Lead the Way</button>
                    </div>
                    
                    <div class="pathway-card" onclick="joinWithSkill('technical')">
                        <span class="pathway-icon">💻</span>
                        <h3 class="pathway-title">Technical Development</h3>
                        <p class="pathway-description">Build the tools and systems that will scale our impact across the community.</p>
                        <div class="pathway-skills">
                            <span class="skill-tag">Development</span>
                            <span class="skill-tag">Design</span>
                            <span class="skill-tag">Innovation</span>
                        </div>
                        <button class="pathway-action">Build Solutions</button>
                    </div>
                    
                    <div class="pathway-card" onclick="joinWithSkill('community')">
                        <span class="pathway-icon">🤝</span>
                        <h3 class="pathway-title">Community Outreach</h3>
                        <p class="pathway-description">Connect with people, build relationships, and spread our mission far and wide.</p>
                        <div class="pathway-skills">
                            <span class="skill-tag">Networking</span>
                            <span class="skill-tag">Events</span>
                            <span class="skill-tag">Marketing</span>
                        </div>
                        <button class="pathway-action">Connect & Inspire</button>
                    </div>
                    
                    <div class="pathway-card" onclick="joinWithSkill('support')">
                        <span class="pathway-icon">💡</span>
                        <h3 class="pathway-title">Creative Support</h3>
                        <p class="pathway-description">Provide research, content creation, and strategic support to fuel our mission.</p>
                        <div class="pathway-skills">
                            <span class="skill-tag">Research</span>
                            <span class="skill-tag">Writing</span>
                            <span class="skill-tag">Analysis</span>
                        </div>
                        <button class="pathway-action">Support & Research</button>
                    </div>
                </div>
            </div>

            <!-- Social Proof & Momentum Section -->
            <div class="social-proof-section" id="socialProofSection" style="display: none;">
                <h2 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">Join the Movement</h2>
                <p style="font-size: 1.2rem; opacity: 0.9; margin-bottom: 2rem;">See the incredible momentum we're building together</p>
                
                <div class="momentum-stats">
                    <div class="momentum-stat">
                        <div class="momentum-number" id="activeMembers">0</div>
                        <div class="momentum-label">Active Members</div>
                    </div>
                    <div class="momentum-stat">
                        <div class="momentum-number" id="completedTasks">0</div>
                        <div class="momentum-label">Tasks Completed</div>
                    </div>
                    <div class="momentum-stat">
                        <div class="momentum-number" id="impactScore">0</div>
                        <div class="momentum-label">Impact Score</div>
                    </div>
                    <div class="momentum-stat">
                        <div class="momentum-number" id="communityReach">0</div>
                        <div class="momentum-label">Community Reach</div>
                    </div>
                </div>
            </div>

            <!-- Metadata Cards (for hero layout) -->
            <div class="project-meta-cards" id="metaCards" style="display: none;">
                <div class="meta-card">
                    <span>👥</span>
                    <div>
                        <strong>Team Size</strong>
                        <span id="cardTeamSize">1 Member</span>
                    </div>
                </div>
                <div class="meta-card">
                    <span>📅</span>
                    <div>
                        <strong>Created</strong>
                        <span id="cardCreated">Loading...</span>
                    </div>
                </div>
                <div class="meta-card">
                    <span>⏳</span>
                    <div>
                        <strong>Timeline</strong>
                        <span id="cardTimeline">Loading...</span>
                    </div>
                </div>
                <div class="meta-card">
                    <span>💰</span>
                    <div>
                        <strong>Funding</strong>
                        <span id="cardFunding">Self-funded</span>
                    </div>
                </div>
            </div>

            <!-- Project Description and Tags (for hero layout) -->
            <div id="heroDescription" style="display: none;">
                <div style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom: 1rem;">About This Project</h3>
                    <div class="project-description" id="heroProjectDescription">
                        Loading project description...
                    </div>
                    <div class="project-tags" id="heroProjectTags">
                        <!-- Tags will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="content-wrapper">
                <div class="sidebar">
                    <div class="card">
                        <h3 class="card-title">Quick Actions</h3>
                        <!-- Quick Actions will be inserted here by dcf-unified-auth.js -->
                    </div>

                    <div class="join-project-card">
                        <h3>Join This Project</h3>
                        <p>Help advance this important initiative</p>
                        <button class="btn" onclick="joinProjectRequest(getProjectIdFromUrl(), window.currentProject?.title)">🤝 Join Now</button>
                    </div>

                    <div class="sidebar-card">
                        <h3 class="sidebar-title">Project Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">1</div>
                                <div class="stat-label">Members</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">0</div>
                                <div class="stat-label">Tasks</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="followersCount">0</div>
                                <div class="stat-label">Followers</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">0</div>
                                <div class="stat-label">Files</div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-card">
                        <h3 class="sidebar-title">Project Team</h3>
                        <div id="projectTeam">
                            <!-- Team members will be loaded here -->
                        </div>
                    </div>

                    <div class="sidebar-card">
                        <h3 class="sidebar-title">Recent Activity</h3>
                        <div id="projectActivity">
                            <div style="text-align: center; padding: 1rem; color: #666; font-size: 0.9rem;">
                                Loading activity...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="content-tabs">
                        <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                        <button class="tab-btn" onclick="switchTab('tasks')">Tasks</button>
                        <button class="tab-btn" onclick="switchTab('discussions')">Discussions</button>
                        <button class="tab-btn" onclick="switchTab('files')">Files</button>
                    </div>

                    <!-- Overview Tab -->
                    <div class="tab-content active" id="overview">
                        <h2 style="margin-bottom: 1.5rem;">Project Overview</h2>
                        
                        <h3 style="margin-bottom: 1rem;">Project Goals</h3>
                        <div id="projectGoals" style="margin-bottom: 2rem; padding-left: 2rem; color: #666; line-height: 1.8;">
                            <p>Project goals will be displayed here once loaded from the database.</p>
                        </div>

                        <h3 style="margin-bottom: 1rem;">Current Phase</h3>
                        <p id="currentPhase" style="color: #666; line-height: 1.6; margin-bottom: 2rem;">
                            This project is in the initial planning phase. More details will be available soon.
                        </p>

                        <h3 style="margin-bottom: 1rem;">Skills Needed</h3>
                        <div id="skillsNeeded" class="project-tags">
                            <!-- Skills will be loaded here -->
                        </div>
                    </div>

                    <!-- Tasks Tab -->
                    <div class="tab-content" id="tasks">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2>Project Tasks</h2>
                        </div>
                        <div id="tasksContainer">
                            <div id="tasksLoading" style="text-align: center; padding: 3rem; color: #666;">
                                Loading tasks...
                            </div>
                        </div>
                    </div>

                    <!-- Discussions Tab -->
                    <div class="tab-content" id="discussions">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2>Project Discussions</h2>
                            <button class="btn btn-primary">+ Start Discussion</button>
                        </div>
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <p>No discussions have been started for this project yet.</p>
                        </div>
                    </div>

                    <!-- Files Tab -->
                    <div class="tab-content" id="files">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2>Project Files</h2>
                            <button class="btn btn-primary" onclick="document.getElementById('fileUploadInput').click()">📁 Upload File</button>
                            <input type="file" id="fileUploadInput" multiple style="display: none;" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,.gif,.mp4,.avi,.mov">
                        </div>
                        <div id="uploadProgress" style="display: none; margin-bottom: 1rem;">
                            <div style="width: 100%; height: 6px; background: #e5e5e5; border-radius: 3px; overflow: hidden;">
                                <div id="uploadProgressBar" style="height: 100%; background: linear-gradient(90deg, #000, #333); border-radius: 3px; transition: width 0.3s ease; width: 0%;"></div>
                            </div>
                            <div id="uploadStatus" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">Uploading...</div>
                        </div>
                        <div id="filesContainer">
                            <div id="filesLoading" style="text-align: center; padding: 3rem; color: #666;">
                                Loading files...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Use unified auth client exclusively
        const supabase = window.dcfSupabase;

        // Get project ID from URL
        function getProjectIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // All avatar initials now use global window.generateInitials from dcf-unified-auth.js

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'ai_ethics': '⚖️',
                'cybersecurity': '🔐',
                'education': '📚',
                'research': '🔬',
                'policy': '📜',
                'humanitarian': '🌍',
                'faith_tech': '✝️',
                'innovation': '💡'
            };
            return icons[category] || '📋';
        }


        function setupHeroLayout(project) {
            // Check if project has main photo
            if (project.main_photo_url) {
                // Show cover photo hero
                document.getElementById('projectHero').style.display = 'block';
                document.getElementById('joinBanner').style.display = 'block';
                document.getElementById('fallbackHeader').style.display = 'none';
                
                // Set cover photo background
                const heroBackground = document.getElementById('heroBackground');
                heroBackground.style.backgroundImage = `url(${project.main_photo_url})`;
                
                // Set project title
                document.getElementById('heroTitle').textContent = project.title;
                
                return true;
            } else {
                // Use fallback layout
                document.getElementById('projectHero').style.display = 'none';
                document.getElementById('joinBanner').style.display = 'none';
                document.getElementById('fallbackHeader').style.display = 'block';
                
                return false;
            }
        }

        // Load project data
        async function loadProject() {
            const projectId = getProjectIdFromUrl();
            
            // 🔍 DEBUG LOGGING - Auth System Status
            console.log('🔍 DEBUG - Auth System Check');
            console.log('🔍 DEBUG - window.getCurrentUser exists:', typeof window.getCurrentUser);
            console.log('🔍 DEBUG - Current User on Load:', window.getCurrentUser());
            console.log('🔍 DEBUG - Project ID:', projectId);
            
            if (!projectId) {
                showError();
                return;
            }

            try {
                const { data: project, error } = await supabase
                    .from('projects')
                    .select(`*, author:user_profiles!author_id(id,email,username,first_name,last_name)`)
                    .eq('id', projectId)
                    .single();

                // 🔍 DEBUG LOGGING - Query Results
                console.log('🔍 DEBUG - Query Error:', error);
                console.log('🔍 DEBUG - Raw Project Data:', project);
                console.log('🔍 DEBUG - Author JOIN Data:', project?.author);

                if (error || !project) {
                    showError();
                    return;
                }

                displayProject(project);
                loadProjectStats(projectId);
                loadProjectFiles(projectId, project);
                loadProjectTasks(projectId);
                loadProjectTeam(projectId, project);
                loadProjectActivity(projectId);
                
            } catch (error) {
                console.error('Error loading project:', error);
                showError();
            }
        }

        // Display project data
        function displayProject(project) {
            // Store project globally for later use
            window.currentProject = project;
            
            // Setup hero layout first
            const usingHeroLayout = setupHeroLayout(project);
            
            // Hide loading, show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('projectContent').style.display = 'block';

            // Update page title
            document.title = `${project.title} - DCF Hungary`;

            // Update breadcrumb
            document.getElementById('breadcrumbProjectTitle').textContent = project.title;

            // Update content based on layout
            if (usingHeroLayout) {
                // Show hero description section
                document.getElementById('heroDescription').style.display = 'block';
                document.getElementById('heroProjectDescription').textContent = project.description;
                
                // Update metadata cards
                document.getElementById('cardTeamSize').textContent = '1 Member';
                document.getElementById('cardCreated').textContent = formatDate(project.created_at);
                document.getElementById('cardTimeline').textContent = project.timeline || 'Ongoing';
                document.getElementById('cardFunding').textContent = project.funding || 'Self-funded';
                
                // Update hero tags
                const heroTagsContainer = document.getElementById('heroProjectTags');
                if (project.skills && Array.isArray(project.skills)) {
                    heroTagsContainer.innerHTML = project.skills.map((skill, index) => 
                        `<div class="tag ${index === 0 ? 'highlight' : ''}">${skill}</div>`
                    ).join('');
                } else {
                    heroTagsContainer.innerHTML = '<div class="tag highlight">No skills specified</div>';
                }
            } else {
                // Use fallback layout
                document.getElementById('heroDescription').style.display = 'none';
                
                // Update project header
                document.getElementById('projectIcon').textContent = getCategoryIcon(project.category);
                document.getElementById('projectTitle').textContent = project.title;
                document.getElementById('projectSubtitle').textContent = project.description;

                // Update meta information
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = project.status || 'active';
                statusBadge.className = `status-badge status-${project.status || 'active'}`;

                document.getElementById('teamSize').textContent = '1 Member';
                document.getElementById('projectLocation').textContent = project.location || 'Global';
                document.getElementById('projectCreated').textContent = formatDate(project.created_at);

                // Description is already shown in project subtitle above, no need to duplicate
                
                // Update fallback tags
                const tagsContainer = document.getElementById('projectTags');
                if (project.skills && Array.isArray(project.skills)) {
                    tagsContainer.innerHTML = project.skills.map((skill, index) => 
                        `<div class="tag ${index === 0 ? 'highlight' : ''}">${skill}</div>`
                    ).join('');
                } else {
                    tagsContainer.innerHTML = '<div class="tag highlight">No skills specified</div>';
                }
            }
            
            // Add Manage Project button dynamically for project owner
            const currentUser = window.getCurrentUser();
            const currentUserEmail = currentUser ? currentUser.email : null;
            const projectActions = document.querySelector('.project-actions');
            const currentUserName = window.getCurrentUser()?.name || window.getCurrentUser()?.username || 'User' || '';
            
            // 🔍 DEBUG LOGGING - Ownership Detection
            console.log('🔍 DEBUG - Current User:', currentUser);
            console.log('🔍 DEBUG - Current User ID:', currentUser?.id);
            console.log('🔍 DEBUG - Project Object:', project);
            console.log('🔍 DEBUG - Project Author ID:', project.author_id);
            console.log('🔍 DEBUG - Project Author Object:', project.author);
            console.log('🔍 DEBUG - Ownership Check Result:', currentUser?.id === project.author_id);
            console.log('🔍 DEBUG - ID Types:', typeof currentUser?.id, 'vs', typeof project.author_id);
            
// Ownership logic now handled by updateJoinButton() after auth loads

            // Update skills needed section
            const skillsContainer = document.getElementById('skillsNeeded');
            if (project.skills) {
                let skills;
                try {
                    skills = Array.isArray(project.skills) ? project.skills : project.skills.split(',');
                } catch (e) {
                    skills = [project.skills];
                }
                
                skillsContainer.innerHTML = skills.map(skill => 
                    `<span class="tag">${skill.trim()}</span>`
                ).join('');
            }

            // Update project goals
            const goalsContainer = document.getElementById('projectGoals');
            if (project.goals) {
                goalsContainer.innerHTML = `<p>${project.goals}</p>`;
            } else {
                goalsContainer.innerHTML = '<p>Project goals will be defined as the project develops.</p>';
            }

            // Load real team members (done in separate function)
            loadProjectTeam(project.id, project);
            
            // Manage button handled above
        }

        // Load project statistics
        async function loadProjectStats(projectId) {
            try {
                // Get team members count
                const { data: members } = await supabase
                    .from('project_members')
                    .select('id')
                    .eq('project_id', projectId);
                
                const memberCount = (members ? members.length : 0) + 1; // +1 for project owner

                // Get tasks count
                const { data: tasks } = await supabase
                    .from('project_tasks')
                    .select('id')
                    .eq('project_id', projectId);
                
                const taskCount = tasks ? tasks.length : 0;

                // Get files count
                const { data: files } = await supabase
                    .from('project_files')
                    .select('id')
                    .eq('project_id', projectId);
                
                const fileCount = files ? files.length : 0;

                // Get followers count
                const { data: followers } = await supabase
                    .from('project_follows')
                    .select('id')
                    .eq('project_id', projectId);
                
                const followersCount = followers ? followers.length : 0;

                // Update the stats display
                const statNumbers = document.querySelectorAll('.stats-grid .stat-number');
                if (statNumbers.length >= 4) {
                    statNumbers[0].textContent = memberCount;     // Members
                    statNumbers[1].textContent = taskCount;       // Tasks
                    statNumbers[2].textContent = followersCount;  // Followers
                    statNumbers[3].textContent = fileCount;       // Files
                }
                
                // Also update the standalone followers count if it exists
                const followersElement = document.getElementById('followersCount');
                if (followersElement) {
                    followersElement.textContent = followersCount;
                }

                // Update team size in meta section
                document.getElementById('teamSize').textContent = `${memberCount} Member${memberCount !== 1 ? 's' : ''}`;

            } catch (error) {
                console.error('Error loading project stats:', error);
            }
        }
// Load project team members
        async function loadProjectTeam(projectId, project) {
            const teamContainer = document.getElementById('projectTeam');
            
            try {
                // Get all project members from database with user profiles
                const { data: members, error } = await supabase
                    .from('project_members')
                    .select(`*, user_profile:user_profiles!user_id(username)`)
                    .eq('project_id', projectId)
                    .order('joined_at', { ascending: true });

                if (error) {
                    console.error('Error loading team members:', error);
                }

                // Start with project owner - Use unified auth function
                const authorInitials = window.generateInitials ? window.generateInitials(`${project.author?.first_name || ''} ${project.author?.last_name || ''}`.trim() || project.author?.username) : 'U';
                let teamHTML = `
                    <div class="team-member">
                        <div class="member-avatar">${authorInitials}</div>
                        <div class="member-info">
                            <div class="member-name">${project.author?.username || `${project.author?.first_name || ''} ${project.author?.last_name || ''}`.trim() || 'Project Creator'}</div>
                            <div class="member-role">Project Lead</div>
                        </div>
                        <span class="member-badge leader">Leader</span>
                    </div>
                `;

                // Add actual team members
                if (members && members.length > 0) {
                    members.forEach(member => {
                        const memberInitials = window.generateInitials ? window.generateInitials(`${member.user_profile?.first_name || ''} ${member.user_profile?.last_name || ''}`.trim() || member.user_profile?.username || member.user_name) : 'U';
                        const roleText = member.role === 'admin' ? 'Admin' : 
                                       member.role === 'contributor' ? 'Contributor' : 'Member';
                        const badgeClass = member.role === 'admin' ? 'leader' : 
                                         member.role === 'contributor' ? 'contributor' : '';
                        
                        teamHTML += `
                            <div class="team-member">
                                <div class="member-avatar">${memberInitials}</div>
                                <div class="member-info">
                                    <div class="member-name">@${member.user_profile?.username || member.user_name}</div>
                                    <div class="member-role">${roleText}</div>
                                </div>
                                <span class="member-badge ${badgeClass}">${roleText}</span>
                            </div>
                        `;
                    });
                }

                // Show message if no additional members
                if (!members || members.length === 0) {
                    teamHTML += `
                        <div style="text-align: center; padding: 1rem; color: #666; font-size: 0.9rem; border-top: 1px solid #f0f0f0; margin-top: 1rem;">
                            <p>No additional team members yet.</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem;">People can join by clicking "Join Project"</p>
                        </div>
                    `;
                }

                teamContainer.innerHTML = teamHTML;

            } catch (error) {
                console.error('Error loading team:', error);
                // Fallback to just showing project owner - Use unified auth function
                const authorInitials = window.generateInitials ? window.generateInitials(`${project.author?.first_name || ''} ${project.author?.last_name || ''}`.trim() || project.author?.username) : 'U';
                teamContainer.innerHTML = `
                    <div class="team-member">
                        <div class="member-avatar">${authorInitials}</div>
                        <div class="member-info">
                           <div class="member-name">@${project.author?.username || `${project.author?.first_name || ''} ${project.author?.last_name || ''}`.trim() || 'Project Creator'}</div>
                            <div class="member-role">Project Lead</div>
                        </div>
                        <span class="member-badge leader">Leader</span>
                    </div>
                    <div style="text-align: center; padding: 1rem; color: #dc3545; font-size: 0.9rem;">
                        Error loading team members
                    </div>
                `;
            }
        }

        // Load project activity
        async function loadProjectActivity(projectId) {
            const activityContainer = document.getElementById('projectActivity');
            
            try {
                // Get recent project activity
                const { data: activities, error } = await supabase
                    .from('project_activity')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) {
                    console.error('Error loading activity:', error);
                }

                if (!activities || activities.length === 0) {
                    activityContainer.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: #666; font-size: 0.9rem;">
                            <p>No recent activity</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem; color: #999;">Activity will appear here as the project develops</p>
                        </div>
                    `;
                    return;
                }

                // Display recent activities
                let activityHTML = '';
                activities.forEach(activity => {
                    const timeAgo = getTimeAgo(activity.created_at);
                    
                    // 🔍 ACTIVITY DEBUG BLOCK
                    console.log('🔍 ACTIVITY DEBUG - Raw activity object:', activity);
                    console.log('🔍 ACTIVITY DEBUG - activity.user_name:', activity.user_name);
                    console.log('🔍 ACTIVITY DEBUG - activity.user_email:', activity.user_email);
                    console.log('🔍 ACTIVITY DEBUG - Calling window.generateInitials with:', activity.user_name);
                    
                    const userInitials = window.generateInitials ? window.generateInitials(activity.user_name) : 'U';
                    
                    console.log('🔍 ACTIVITY DEBUG - Generated initials result:', userInitials);
                    console.log('🔍 ACTIVITY DEBUG - window.generateInitials function exists:', !!window.generateInitials);
                    
                    // Get activity icon based on type
                    let icon = '📝';
                    switch(activity.action_type) {
                        case 'project_created': icon = '🚀'; break;
                        case 'member_joined': icon = '👥'; break;
                        case 'task_completed': icon = '✅'; break;
                        case 'task_created': icon = '📋'; break;
                        case 'file_uploaded': icon = '📎'; break;
                        case 'comment_added': icon = '💬'; break;
                        default: icon = '📝';
                    }
                    
                    activityHTML += `
                        <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid #f5f5f5;">
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0;">
                                ${userInitials}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.9rem; color: #333; line-height: 1.4; margin-bottom: 0.25rem;">
                                    ${icon} ${activity.action_description || activity.action_type.replace('_', ' ')}
                                </div>
                                <div style="font-size: 0.8rem; color: #666;">
                                    ${timeAgo}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Remove last border
                activityHTML = activityHTML.replace(/border-bottom: 1px solid #f5f5f5;(?!.*border-bottom: 1px solid #f5f5f5;)/, '');
                
                activityContainer.innerHTML = activityHTML;

            } catch (error) {
                console.error('Error loading activity:', error);
                activityContainer.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #dc3545; font-size: 0.9rem;">
                        Error loading activity
                    </div>
                `;
            }
        }

        // Helper function for time ago (if not already present)
        function getTimeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffMs = now - past;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            if (diffMinutes < 1) return 'Just now';
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 30) return `${diffDays}d ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)}mo ago`;
            return `${Math.floor(diffDays / 365)}y ago`;
        }
        // Load project tasks
        async function loadProjectTasks(projectId) {
            try {
                const { data: tasks, error } = await supabase
                    .from('project_tasks')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('created_at', { ascending: false });

                const tasksContainer = document.getElementById('tasksContainer');
                const tasksLoading = document.getElementById('tasksLoading');
                
                if (tasksLoading) tasksLoading.style.display = 'none';

                if (error || !tasks || tasks.length === 0) {
                    tasksContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <p>No tasks have been created for this project yet.</p>
                        </div>
                    `;
                    return;
                }

                // Task count is now handled by loadProjectStats()

                // Display tasks
                tasksContainer.innerHTML = tasks.map(task => `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 1px solid #e5e5e5; border-radius: 8px; margin-bottom: 1rem; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#333'; this.style.background='#f8f9fa'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.background='white'">
                        <div style="width: 20px; height: 20px; border: 2px solid #e5e5e5; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; ${task.status === 'completed' ? 'background: #28a745; border-color: #28a745; color: white;' : ''}" onclick="toggleTaskStatus('${task.id}')">
                            ${task.status === 'completed' ? '✓' : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem; ${task.status === 'completed' ? 'text-decoration: line-through; color: #666;' : ''}">${task.title}</div>
                            <div style="color: #666; font-size: 0.8rem; display: flex; gap: 1rem;">
                                <span>Due: ${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date'}</span>
                                <span>Assigned to: ${task.assigned_to || 'Unassigned'}</span>
                                <span>Priority: ${task.priority || 'Medium'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading tasks:', error);
                const tasksContainer = document.getElementById('tasksContainer');
                tasksContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <p>Error loading tasks. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Load project files
        async function loadProjectFiles(projectId, project = null) {
            try {
                const { data: files, error } = await supabase
                    .from('project_files')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('uploaded_at', { ascending: false });

                const filesContainer = document.getElementById('filesContainer');
                const filesLoading = document.getElementById('filesLoading');
                
                if (filesLoading) filesLoading.style.display = 'none';

                if (error || !files || files.length === 0) {
                    filesContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <p>No files have been uploaded for this project yet.</p>
                        </div>
                    `;
                    return;
                }

                // File count is now handled by loadProjectStats()

                // Get current user email for delete permissions
                const currentUser = window.getCurrentUser();
            const currentUserEmail = currentUser ? currentUser.email : null;
                
                // Display files with thumbnails and view functionality
                filesContainer.innerHTML = files.map(file => {
                    const extension = file.file_name.split('.').pop().toLowerCase();
                    const icons = {
                        'pdf': '📄',
                        'doc': '📝', 'docx': '📝',
                        'ppt': '📊', 'pptx': '📊',
                        'xls': '📈', 'xlsx': '📈',
                        'txt': '📃',
                        'zip': '🗜️', 'rar': '🗜️',
                        'jpg': '🖼️', 'jpeg': '🖼️', 'png': '🖼️', 'gif': '🖼️',
                        'mp4': '🎥', 'avi': '🎥', 'mov': '🎥'
                    };
                    const icon = icons[extension] || '📎';
                    
                    return `
<div style="display: flex; align-items: center; margin: 0.75rem 0; padding: 0.75rem 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e5e5; transition: all 0.2s ease;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">                            <div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: #e9ecef; border-radius: 8px; margin-right: 1rem; font-size: 1.5rem; overflow: hidden; flex-shrink: 0;">
                                ${['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension) ? 
                                    `<img src="https://atzommnkkwzgbktuzjti.supabase.co/storage/v1/object/public/project-files/${file.file_path || file.file_name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" onerror="this.style.display='none'; this.parentElement.innerHTML='${icon}';">` : 
                                    icon}
                            </div>
                            <div style="flex: 1; min-width: 0; max-width: calc(100% - 200px);">
                                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.file_name}</div>
                                <div style="color: #666; font-size: 0.9rem; line-height: 1.4;">
                                    ${formatFileSize(file.file_size || 0)} • Uploaded by ${file.uploaded_by || 'Unknown'} on ${formatDate(file.uploaded_at)}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.25rem; margin-left: 1rem; flex-shrink: 0;">
                                <button class="btn btn-primary btn-small" onclick="viewFile('${file.file_name}', '${file.file_path || file.file_name}')" style="padding: 0.4rem 0.6rem;">👁️</button>
                                <button class="btn btn-secondary btn-small" onclick="downloadFile('${file.file_name}', '${file.file_path || file.file_name}')" style="padding: 0.4rem 0.6rem;">↓</button>
                                ${currentUserEmail === project.author_email ? `<button class="btn btn-danger btn-small" onclick="deleteFile('${file.id}', '${file.file_path || file.file_name}')" style="padding: 0.4rem 0.6rem;">🗑️</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading files:', error);
                const filesContainer = document.getElementById('filesContainer');
                filesContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <p>Error loading files. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Format file size helper
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // File viewer and download functions
        function viewFile(fileName, filePath) {
            const extension = fileName.split('.').pop().toLowerCase();
            const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'];
            const videoTypes = ['mp4', 'avi', 'mov', 'webm'];
            const pdfTypes = ['pdf'];
            const textTypes = ['txt', 'md', 'csv', 'json', 'xml', 'log'];
            const docTypes = ['doc', 'docx', 'rtf'];
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.cssText = 'display: flex; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; position: fixed; top: 0; left: 0; right: 0; bottom: 0;';
            
            let content = '';
            
            if (imageTypes.includes(extension)) {
                content = `
                    <div style="max-width: 90vw; max-height: 90vh; position: relative; display: flex; align-items: center; justify-content: center;">
                        <img src="https://atzommnkkwzgbktuzjti.supabase.co/storage/v1/object/public/project-files/${filePath || fileName}" alt="${fileName}" style="max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
                        <button onclick="this.closest('.modal').remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px;">×</button>
                    </div>
                `;
            } else if (videoTypes.includes(extension)) {
                content = `
                    <div style="max-width: 90vw; max-height: 90vh; position: relative;">
                        <video controls style="max-width: 100%; max-height: 100%; border-radius: 8px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
                            <source src="https://atzommnkkwzgbktuzjti.supabase.co/storage/v1/object/public/project-files/${filePath || fileName}" type="video/${extension}">
                        </video>
                        <button onclick="this.closest('.modal').remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px;">×</button>
                    </div>
                `;
            } else if (pdfTypes.includes(extension)) {
                content = `
                    <div style="max-width: 90vw; max-height: 90vh; position: relative;">
                        <iframe src="https://atzommnkkwzgbktuzjti.supabase.co/storage/v1/object/public/project-files/${filePath || fileName}" style="width: 100%; height: 90vh; border: none; border-radius: 8px;"></iframe>
                        <button onclick="this.closest('.modal').remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px;">×</button>
                    </div>
                `;
            } else {
                content = `
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 400px; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">📎</div>
                        <h3 style="margin-bottom: 1rem;">${fileName}</h3>
                        <p style="color: #666; margin-bottom: 2rem;">This file type cannot be previewed in the browser.</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">Close</button>
                            <button onclick="downloadFile('${fileName}', '${filePath}')" class="btn btn-primary">📥 Download</button>
                        </div>
                    </div>
                `;
            }
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function downloadFile(fileName, filePath) {
            const url = `https://atzommnkkwzgbktuzjti.supabase.co/storage/v1/object/public/project-files/${filePath || fileName}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Delete file functionality
        async function deleteFile(fileId, filePath) {
            showConfirmDialog('Delete File', 'Are you sure you want to delete this file? This action cannot be undone.', async () => {
                try {
                    // Delete from database
                    const { error: dbError } = await supabase
                        .from('project_files')
                        .delete()
                        .eq('id', fileId);
                    
                    if (dbError) throw dbError;
                    
                    // Delete from storage
                    const { error: storageError } = await supabase.storage
                        .from('project-files')
                        .remove([filePath]);
                    
                    if (storageError) {
                        console.warn('Storage deletion failed:', storageError);
                        // Don't throw error here as database deletion succeeded
                    }
                    
                    console.log('File deleted successfully');
                    
                    // Reload files list
                    const projectId = getProjectIdFromUrl();
                    loadProjectFiles(projectId, window.currentProject);
                    
                } catch (error) {
                    console.error('Error deleting file:', error);
                    showAlert('Error deleting file. Please try again.', 'error', 'Delete Error');
                }
            });
        }

        // Custom confirmation dialog
        let confirmCallback = null;
        
        function showConfirmDialog(title, message, callback) {
            // Create modal if it doesn't exist
            if (!document.getElementById('confirmModal')) {
                const modalHTML = `
                    <div class="modal" id="confirmModal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%;">
                            <div style="margin-bottom: 1.5rem;">
                                <h2 style="margin: 0 0 1rem 0; color: #333;" id="confirmTitle">Confirm Action</h2>
                                <p style="color: #666; line-height: 1.6; margin: 0;" id="confirmMessage"></p>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                                <button type="button" class="btn btn-danger" onclick="executeConfirmedAction()">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }
        
        function executeConfirmedAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        
        // Show error state
        function showError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }

        // Toggle task completion status
        async function toggleTaskStatus(taskId) {
            try {
                // Get current task status from database
                const { data: task, error: fetchError } = await supabase
                    .from('project_tasks')
                    .select('status, title')
                    .eq('id', taskId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                const newStatus = task.status === 'completed' ? 'pending' : 'completed';
                
                const { error } = await supabase
                    .from('project_tasks')
                    .update({ status: newStatus })
                    .eq('id', taskId);
                
                if (error) throw error;
                
                // Log activity
                const projectId = getProjectIdFromUrl();
                const currentEmail = window.getCurrentUser()?.email || 'anonymous';
                const { data: userProfile } = await supabase
                    .from('user_profiles')
                    .select('first_name, last_name, username')
                    .eq('email', currentEmail)
                    .single();
                const currentUser = `${userProfile?.first_name || ''} ${userProfile?.last_name || ''}`.trim() || userProfile?.username || 'User';
                
                const activityType = newStatus === 'completed' ? 'task_completed' : 'task_updated';
                const activityDescription = newStatus === 'completed' 
                    ? `Completed task: ${task.title}`
                    : `Reopened task: ${task.title}`;
                
                await supabase
                    .from('project_activity')
                    .insert([{
                        project_id: projectId,
                        user_email: currentEmail,
                        user_name: currentUser,
                        action_type: activityType,
                        action_description: activityDescription
                    }]);
                
                // Reload tasks to reflect changes
                loadProjectTasks(projectId);
                
            } catch (error) {
                console.error('Error updating task:', error);
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            // Load content when tabs are clicked
            const projectId = getProjectIdFromUrl();
            if (projectId) {
                if (tabName === 'files') {
                    // Get project data from global scope if available
                    loadProjectFiles(projectId, window.currentProject);
                } else if (tabName === 'tasks') {
                    loadProjectTasks(projectId);
                }
            }
        }

        // =============================================================================
        // FOLLOW/JOIN SYSTEM FUNCTIONS 
        // =============================================================================

        async function followProject(projectId, projectTitle) {
            const currentUser = window.getCurrentUser();
            const userEmail = currentUser ? currentUser.email : null;
            const userName = currentUser ? currentUser.name : null;
            
            if (!userEmail) {
                showAlert('Please log in to follow projects', 'warning', 'Login Required');
                return;
            }
            
            try {
                const response = await fetch('https://atzommnkkwzgbktuzjti.supabase.co/rest/v1/project_follows', {
                    method: 'POST',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_email: userEmail,
                        user_name: userName,
                        project_id: projectId
                    })
                });
                
                if (response.ok) {
                    updateFollowButton(true);
                    // Refresh stats to show updated follower count
                    loadProjectStats(projectId);
                    console.log(`Successfully followed: ${projectTitle}`);
                } else if (response.status === 409) {
                    console.log('Already following this project');
                }
            } catch (error) {
                console.error('Error following project:', error);
            }
        }

        async function unfollowProject(projectId, projectTitle) {
            const currentUser = window.getCurrentUser();
            const userEmail = currentUser ? currentUser.email : null;
            
            try {
                const response = await fetch(`https://atzommnkkwzgbktuzjti.supabase.co/rest/v1/project_follows?user_email=eq.${userEmail}&project_id=eq.${projectId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks'
                    }
                });
                
                if (response.ok) {
                    updateFollowButton(false);
                    // Refresh stats to show updated follower count
                    loadProjectStats(getProjectIdFromUrl());
                    console.log(`Successfully unfollowed: ${projectTitle}`);
                }
            } catch (error) {
                console.error('Error unfollowing project:', error);
            }
        }

        function updateFollowButton(isFollowing) {
            const followBtn = document.getElementById('followBtn');
            if (!followBtn) return;
            
            if (isFollowing) {
                followBtn.textContent = '✓ Following';
                followBtn.className = 'btn btn-secondary';
                followBtn.onclick = () => unfollowProject(getProjectIdFromUrl(), window.currentProject?.title);
            } else {
                followBtn.textContent = '⭐ Follow';
                followBtn.className = 'btn btn-secondary';
                followBtn.onclick = () => followProject(getProjectIdFromUrl(), window.currentProject?.title);
            }
        }

        async function joinProjectRequest(projectId, projectTitle, skillFocus = null) {
            const currentUser = window.getCurrentUser();
            const userEmail = currentUser ? currentUser.email : null;
            const userName = currentUser ? currentUser.name : null;
            
            if (!userEmail) {
                showAlert('Please log in to join projects', 'warning', 'Login Required');
                return;
            }
            
            try {
                const joinData = {
                    user_email: userEmail,
                    user_name: userName,
                    project_id: projectId,
                    status: 'pending',
                    message: skillFocus ? 
                        `Interested in contributing with ${skillFocus} skills` : 
                        `${userName} would like to join ${projectTitle}`
                };
                
                if (skillFocus) {
                    joinData.skill_focus = skillFocus;
                }
                
                const response = await fetch('https://atzommnkkwzgbktuzjti.supabase.co/rest/v1/project_join_requests', {
                    method: 'POST',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(joinData)
                });
                
                if (response.ok) {
                    updateJoinButton('pending');
                    showAlert(skillFocus ? 
                        `Your ${skillFocus}-focused join request has been submitted! The project owner will review your application.` :
                        'Your join request has been submitted! The project owner will review your application.', 
                        'success', 'Request Sent');
                } else if (response.status === 409) {
                    showAlert('You have already requested to join this project', 'warning', 'Already Requested');
                } else {
                    throw new Error('Failed to submit join request');
                }
                
            } catch (error) {
                console.error('Error submitting join request:', error);
                showAlert('Failed to submit join request. Please try again.', 'error', 'Request Failed');
            }
        }

        function updateJoinButton(userStatus) {
            const joinBtn = document.getElementById('joinBtn');
            const joinCard = document.querySelector('.join-project-card');
            if (!joinBtn) return;
            
            switch(userStatus) {
                case 'owner':
                    const followBtn = document.getElementById('followBtn');
                    const manageBtn = document.getElementById('manageBtn');
                    if (followBtn) followBtn.style.display = 'none';
                    if (joinBtn) joinBtn.style.display = 'none';
                    if (joinCard) joinCard.style.display = 'none';
                    if (manageBtn) manageBtn.style.display = 'inline-block';
                    break;
                case 'member':
                    joinBtn.textContent = '✓ Member';
                    joinBtn.className = 'btn btn-secondary';
                    joinBtn.disabled = true;
                    if (joinCard) joinCard.style.display = 'none';
                    break;
                case 'pending':
                    joinBtn.textContent = '⏳ Request Pending';
                    joinBtn.className = 'btn btn-secondary';
                    joinBtn.disabled = true;
                    if (joinCard) {
                        joinCard.querySelector('h3').textContent = 'Join Request Pending';
                        joinCard.querySelector('p').textContent = 'Your request to join this project is being reviewed.';
                        joinCard.querySelector('button').style.display = 'none';
                    }
                    break;
                default:
                    const followBtn2 = document.getElementById('followBtn');
                    const manageBtn2 = document.getElementById('manageBtn');
                    if (followBtn2) followBtn2.style.display = 'inline-block';
                    if (joinBtn) joinBtn.style.display = 'inline-block';
                    if (joinCard) joinCard.style.display = 'block';
                    if (manageBtn2) manageBtn2.style.display = 'none';
                    joinBtn.textContent = '🤝 Join Project';
                    joinBtn.className = 'btn btn-primary';
                    joinBtn.disabled = false;
                    joinBtn.onclick = () => joinProjectRequest(getProjectIdFromUrl(), window.currentProject?.title);
            }
        }

        // Check user's follow and join status for this project
        async function checkUserProjectStatus() {
            console.log('🔍 DEBUG - checkUserProjectStatus called');
            console.log('🔍 DEBUG - window.currentProject exists?', !!window.currentProject);
            console.log('🔍 DEBUG - window.getCurrentUser exists?', typeof window.getCurrentUser === 'function');
            
            const currentUser = window.getCurrentUser();
            const userEmail = currentUser ? currentUser.email : null;
            const projectId = getProjectIdFromUrl();
            
            console.log('🔍 DEBUG - getCurrentUser returned:', currentUser);
            
            if (!userEmail || !projectId) {
                console.log('🔍 DEBUG - Missing userEmail or projectId:', { userEmail, projectId });
                return;
            }

            // Wait for currentProject to be loaded if not ready
            if (!window.currentProject) {
                console.log('🔍 DEBUG - currentProject not ready, waiting...');
                await new Promise(resolve => {
                    let checkCount = 0;
                    const checkInterval = setInterval(() => {
                        checkCount++;
                        if (window.currentProject || checkCount > 20) {
                            clearInterval(checkInterval);
                            console.log('🔍 DEBUG - currentProject ready after', checkCount, 'checks');
                            resolve();
                        }
                    }, 100);
                });
            }
            
            try {
                // Check if following
                const followResponse = await fetch(`https://atzommnkkwzgbktuzjti.supabase.co/rest/v1/project_follows?user_email=eq.${userEmail}&project_id=eq.${projectId}`, {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks'
                    }
                });
                
                const followData = await followResponse.json();
                const isFollowing = followData && followData.length > 0;
                updateFollowButton(isFollowing);
                
                // Check membership status
                const memberResponse = await fetch(`https://atzommnkkwzgbktuzjti.supabase.co/rest/v1/project_members?user_email=eq.${userEmail}&project_id=eq.${projectId}`, {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks'
                    }
                });
                
                const memberData = await memberResponse.json();
                
                // Check pending join requests
                const requestResponse = await fetch(`https://atzommnkkwzgbktuzjti.supabase.co/rest/v1/project_join_requests?user_email=eq.${userEmail}&project_id=eq.${projectId}&status=eq.pending`, {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0em9tbW5ra3d6Z2JrdHV6anRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzAyMzIsImV4cCI6MjA2ODk0NjIzMn0.9mh2A5A5mLbo408S9g7k76VRzSJE0QWdiYTTOPLEiks'
                    }
                });
                
                const requestData = await requestResponse.json();
                
                // Check if user owns this project
                console.log('🔍 DEBUG - Status Check - Current User:', currentUser);
                console.log('🔍 DEBUG - Status Check - Current User ID:', currentUser?.id);
                console.log('🔍 DEBUG - Status Check - Current User ID Type:', typeof currentUser?.id);
                console.log('🔍 DEBUG - Status Check - currentProject:', window.currentProject);
                console.log('🔍 DEBUG - Status Check - Author ID:', window.currentProject?.author_id);
                console.log('🔍 DEBUG - Status Check - Author ID Type:', typeof window.currentProject?.author_id);
                console.log('🔍 DEBUG - Status Check - Direct Comparison:', currentUser?.id, '===', window.currentProject?.author_id);
                console.log('🔍 DEBUG - Status Check - String Comparison:', String(currentUser?.id), '===', String(window.currentProject?.author_id));
                console.log('🔍 DEBUG - Status Check - Ownership Result (Direct):', currentUser?.id === window.currentProject?.author_id);
                console.log('🔍 DEBUG - Status Check - Ownership Result (String):', String(currentUser?.id) === String(window.currentProject?.author_id));
                
                if (window.currentProject && currentUser?.id && String(currentUser.id) === String(window.currentProject.author_id)) {
                    updateJoinButton('owner');
                } else if (memberData && memberData.length > 0) {
                    updateJoinButton('member');
                } else if (requestData && requestData.length > 0) {
                    updateJoinButton('pending');
                } else {
                    updateJoinButton('none');
                }
                
            } catch (error) {
                console.error('Error checking user project status:', error);
            }
        }

        // Manage project functionality
        function manageProject() {
            const projectId = getProjectIdFromUrl();
            if (projectId) {
                window.location.href = `dcf_project_manage.html?id=${projectId}`;
            }
        }

        // Wait for auth system to be ready
        async function waitForAuth() {
            let attempts = 0;
            const maxAttempts = 10; // Reduced timeout for better UX
            
            while (attempts < maxAttempts) {
                if (typeof window.getCurrentUser === 'function') {
                    const user = window.getCurrentUser();
                    console.log('🔍 DEBUG - Auth Ready Check - Attempt:', attempts + 1, 'User:', user ? 'logged in' : 'no session');
                    
                    if (user && user.id) {
                        console.log('✅ Auth system ready with user:', user.id);
                        return true;
                    } else {
                        // Auth system ready but no user - this is fine for public viewing
                        console.log('ℹ️ Auth system ready, no user session - public viewing mode');
                        return false;
                    }
                }
                
                console.log('⏳ Waiting for auth system... attempt', attempts + 1);
                await new Promise(resolve => setTimeout(resolve, 200)); // Faster polling
                attempts++;
            }
            
            console.log('ℹ️ Auth system not available - continuing in public mode');
            return false;
        }

        // Initialize page with auth timing fix
        async function initializePage() {
            console.log('🚀 Starting page initialization...');
            
            // Load project data first (doesn't need auth)
            await loadProject();
            
            // Wait for auth system to be ready
            await waitForAuth();
            
            // Now check user status with auth ready
            await checkUserProjectStatus();
            
            // Update join card button
            const joinCardBtn = document.querySelector('.join-project-card button');
            if (joinCardBtn) {
                joinCardBtn.onclick = () => joinProjectRequest(getProjectIdFromUrl(), window.currentProject?.title);
            }
            
            console.log('✅ Page initialization complete');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            
            // Monitor for authentication completion and re-check user status
            let authChecked = false;
            const checkAuthAndUpdateStatus = () => {
                if (!authChecked && window.dcfUser && window.dcfUser.isLoggedIn) {
                    authChecked = true;
                    console.log('🔍 DEBUG - Authentication completed, user logged in:', window.dcfUser.profile?.id);
                    console.log('🔍 DEBUG - Re-running checkUserProjectStatus after auth...');
                    checkUserProjectStatus();
                }
            };

            // Check periodically for auth state change
            const authCheckInterval = setInterval(() => {
                checkAuthAndUpdateStatus();
                
                // Stop checking after auth is detected or 30 seconds
                if (authChecked) {
                    clearInterval(authCheckInterval);
                }
            }, 500);

            // Timeout after 30 seconds
            setTimeout(() => {
                clearInterval(authCheckInterval);
                if (!authChecked) {
                    console.log('🔍 DEBUG - Auth check timeout after 30 seconds');
                }
            }, 30000);
        });

        // =============================================================================
        // INSPIRATIONAL REDESIGN FUNCTIONS
        // =============================================================================
        
        
        // Setup inspirational hero elements
        function setupInspirationalElements(project) {
            // Calculate impact statistics
            const createdDate = new Date(project.created_at);
            const now = new Date();
            const daysActive = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));
            
            // Check if hero overlay exists (for projects with photos)
            const heroOverlay = document.getElementById('impactHeadline');
            const standaloneHero = document.getElementById('heroImpactStandalone');
            
            if (heroOverlay) {
                // Update impact statistics for hero overlay
                animateCounter('peopleHelped', Math.floor(daysActive * 0.3) + 5);
                animateCounter('goalsAchieved', Math.floor(daysActive / 30) + 1);
                animateCounter('daysActive', daysActive);
                
                // Update headlines with project-specific content
                document.getElementById('impactHeadline').textContent = project.title || 'Transform Lives. Change the World.';
                document.getElementById('impactSubtitle').textContent = project.description || 'Join a movement that\'s making a real difference in communities across Hungary';
            } else if (standaloneHero) {
                // Show standalone hero section for projects without photos
                standaloneHero.style.display = 'block';
                
                // Update standalone impact statistics
                animateCounter('peopleHelpedStandalone', Math.floor(daysActive * 0.3) + 5);
                animateCounter('goalsAchievedStandalone', Math.floor(daysActive / 30) + 1);
                animateCounter('daysActiveStandalone', daysActive);
            }
            
            // Always show inspirational sections
            document.getElementById('urgencyBanner').style.display = 'block';
            document.getElementById('storySection').style.display = 'block';
            document.getElementById('participationSection').style.display = 'block';
            document.getElementById('socialProofSection').style.display = 'block';
            
            // Update social proof stats
            setTimeout(() => {
                animateCounter('activeMembers', Math.floor(daysActive * 0.1) + 3);
                animateCounter('completedTasks', Math.floor(daysActive * 0.2) + 2);
                animateCounter('impactScore', Math.floor(daysActive * 2.5) + 85);
                animateCounter('communityReach', Math.floor(daysActive * 1.5) + 150);
            }, 500);
        }
        
        // Animate counter numbers
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let current = 0;
            const increment = targetValue / 30;
            const duration = 2000; // 2 seconds
            const stepTime = duration / 30;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= targetValue) {
                    element.textContent = targetValue;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, stepTime);
        }
        
        // Join with specific skill pathway
        function joinWithSkill(skillType) {
            const skillMessages = {
                'leadership': 'Ready to lead strategic initiatives and guide our team to success?',
                'technical': 'Excited to build innovative solutions that will scale our impact?',
                'community': 'Passionate about connecting with people and building relationships?',
                'support': 'Ready to provide crucial research and creative support?'
            };
            
            const message = skillMessages[skillType] || 'Ready to make a difference?';
            
            if (confirm(`${message}\n\nClick OK to submit your join request with ${skillType} focus.`)) {
                joinProjectRequest(getProjectIdFromUrl(), window.currentProject?.title, skillType);
            }
        }
    </script>
    </body>
</html>